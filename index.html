<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FinanceFlow â€” Cloud Expense Management</title>
<title>FinanceFlow â€” Cloud Expense Management</title>
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRmluYW5jZUZsb3ciLCJzaG9ydF9uYW1lIjoiRmluYW5jZUZsb3ciLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzFhMjMzZiIsInRoZW1lX2NvbG9yIjoiIzFlM2E1ZiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnJTNFJTNDcmVjdCB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCcgZmlsbD0nJTIzMWUzYTVmJy8lM0UlM0N0ZXh0IHg9JzUwJyB5PSc3MCcgZm9udC1mYW1pbHk9J0FyaWFsJyBmb250LXNpemU9JzUwJyBmaWxsPSclMjNjMjg1M2EnIHRleHQtYW5jaG9yPSdtaWRkbGUnJTNFRiUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%231e3a5f'/%3E%3Cstop offset='100%25' style='stop-color:%232d5a8e'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23g)'/%3E%3Ctext x='50' y='70' font-family='Arial,sans-serif' font-size='50' font-weight='bold' fill='%23c2853a' text-anchor='middle'%3EF%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%231e3a5f'/%3E%3Cstop offset='100%25' style='stop-color:%232d5a8e'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23g)'/%3E%3Ctext x='50' y='70' font-family='Arial,sans-serif' font-size='50' font-weight='bold' fill='%23c2853a' text-anchor='middle'%3EF%3C/text%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=DM+Sans:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#f4f6f9;--surface:#fff;--surface2:#f0f3f7;
  --text:#1e293b;--text2:#475569;--text3:#94a3b8;
  --border:#e2e8f0;--border2:#cbd5e1;
  --navy:#1e3a5f;--navy2:#2d5a8e;--navy-light:rgba(30,58,95,.07);
  --gold:#c2853a;--gold2:#d4975a;--gold-light:rgba(194,133,58,.12);--gold-glow:rgba(194,133,58,.25);
  --red:#dc2626;--red-light:rgba(220,38,38,.1);
  --green:#16a34a;--green-light:rgba(22,163,74,.1);
  --blue:#2563eb;--blue-light:rgba(37,99,235,.1);
  --purple:#7c3aed;
  --radius:12px;--radius-sm:8px;
  --font-display:'Cormorant Garamond',serif;--font-body:'DM Sans',sans-serif;--font-mono:'JetBrains Mono',monospace;
  --shadow:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);
  --shadow-md:0 4px 16px rgba(30,58,95,.08);--shadow-lg:0 8px 32px rgba(30,58,95,.12);
}
html{scroll-behavior:smooth}
body{font-family:var(--font-body);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;line-height:1.6}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
.z1{position:relative;z-index:1}
#authScreen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem;background:#0a0e27;position:relative;overflow:hidden}
#authScreen::before{content:'';position:fixed;inset:0;pointer-events:none;background:linear-gradient(135deg,rgba(30,58,95,0.95) 0%,rgba(15,23,42,0.98) 50%,rgba(30,58,95,0.95) 100%);z-index:1;animation:gradientShift 15s ease infinite}
#authScreen::after{content:'';position:fixed;inset:0;pointer-events:none;background-image:radial-gradient(circle at 20% 30%,rgba(194,133,58,0.15) 0%,transparent 50%),radial-gradient(circle at 80% 70%,rgba(37,99,235,0.12) 0%,transparent 50%),radial-gradient(circle at 50% 50%,rgba(16,185,129,0.08) 0%,transparent 70%);animation:pulseGlow 8s ease-in-out infinite;z-index:1}
@keyframes gradientShift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
@keyframes pulseGlow{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.7;transform:scale(1.1)}}
.finance-particle{position:absolute;color:rgba(194,133,58,0.3);font-size:1.2rem;pointer-events:none;animation:float 20s linear infinite;z-index:0}
.finance-particle:nth-child(1){left:10%;top:20%;animation-delay:0s;animation-duration:25s}
.finance-particle:nth-child(2){left:80%;top:60%;animation-delay:2s;animation-duration:22s}
.finance-particle:nth-child(3){left:30%;top:80%;animation-delay:4s;animation-duration:28s}
.finance-particle:nth-child(4){left:70%;top:30%;animation-delay:6s;animation-duration:20s}
.finance-particle:nth-child(5){left:50%;top:50%;animation-delay:8s;animation-duration:24s}
.finance-particle:nth-child(6){left:15%;top:70%;animation-delay:1s;animation-duration:26s;color:rgba(37,99,235,0.25)}
.finance-particle:nth-child(7){left:85%;top:15%;animation-delay:3s;animation-duration:23s;color:rgba(16,185,129,0.2)}
.finance-particle:nth-child(8){left:40%;top:40%;animation-delay:5s;animation-duration:27s;color:rgba(194,133,58,0.25)}
@keyframes float{0%{transform:translateY(0) rotate(0deg);opacity:0}10%{opacity:1}90%{opacity:1}100%{transform:translateY(-100vh) rotate(360deg);opacity:0}}
.auth-logo{text-align:center;margin-bottom:2.2rem;position:relative;z-index:1}
.auth-logo h1{font-family:var(--font-display);font-size:3rem;font-weight:700;color:var(--navy);letter-spacing:-.5px;line-height:1.1}
.auth-logo h1 em{color:var(--gold);font-style:normal}
.auth-logo p{color:var(--text3);font-size:.85rem;margin-top:.45rem;letter-spacing:.6px;text-transform:uppercase}
.auth-card{width:100%;max-width:440px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-lg);position:relative;z-index:1;overflow:hidden}
.auth-tabs{display:flex;border-bottom:1px solid var(--border)}
.auth-tab{flex:1;padding:.9rem;text-align:center;font-size:.76rem;letter-spacing:.8px;text-transform:uppercase;color:var(--text3);cursor:pointer;border:none;background:none;font-family:var(--font-body);font-weight:500;transition:color .3s,background .3s;position:relative}
.auth-tab.active{color:var(--navy);background:var(--navy-light)}
.auth-tab.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--navy)}
.auth-body{padding:1.8rem 2rem 2rem}
.form-row{margin-bottom:1.15rem}
.form-row label{display:block;font-size:.72rem;letter-spacing:.6px;text-transform:uppercase;color:var(--text2);margin-bottom:.4rem;font-weight:600}
.form-row input{width:100%;padding:.72rem .9rem;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:.88rem;font-family:var(--font-body);transition:border-color .3s,box-shadow .3s;outline:none}
.form-row input:focus{border-color:var(--navy2);box-shadow:0 0 0 3px var(--navy-light)}
.form-row input::placeholder{color:var(--text3)}
.form-row .hint{font-size:.7rem;color:var(--text3);margin-top:.3rem}
.pw-strength{display:flex;gap:4px;margin-top:.5rem;height:3px}
.pw-bar{flex:1;border-radius:2px;background:var(--border);transition:background .3s}
.pw-bar.weak{background:#ef4444}.pw-bar.ok{background:#f59e0b}.pw-bar.good{background:var(--blue)}.pw-bar.strong{background:var(--green)}
.pw-label{font-size:.7rem;color:var(--text3);margin-top:.35rem}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.74rem 1.4rem;border:none;border-radius:var(--radius-sm);font-family:var(--font-body);font-size:.8rem;letter-spacing:.5px;text-transform:uppercase;cursor:pointer;transition:all .25s;outline:none;width:100%;font-weight:600}
.btn-navy{background:var(--navy);color:#fff;box-shadow:0 3px 12px rgba(30,58,95,.3)}
.btn-navy:hover{background:var(--navy2);transform:translateY(-1px);box-shadow:0 5px 18px rgba(30,58,95,.35)}
.btn-navy:active{transform:translateY(0)}
.btn-navy:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border)}
.btn-ghost:hover{border-color:var(--navy2);color:var(--navy)}
.alert{padding:.68rem .9rem;border-radius:var(--radius-sm);font-size:.8rem;margin-bottom:.9rem;display:none;align-items:flex-start;gap:.5rem}
.alert.show{display:flex}
.alert-err{background:var(--red-light);border:1px solid rgba(220,38,38,.25);color:var(--red)}
.alert-ok{background:var(--green-light);border:1px solid rgba(22,163,74,.25);color:var(--green)}
.alert-info{background:var(--blue-light);border:1px solid rgba(37,99,235,.25);color:var(--blue)}
.forgot-link{display:block;text-align:right;font-size:.74rem;color:var(--text3);cursor:pointer;margin-top:-.3rem;margin-bottom:.7rem;background:none;border:none;font-family:var(--font-body);transition:color .25s}
.forgot-link:hover{color:var(--navy)}
.loading{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#appScreen{display:none}
#appScreen.show{display:block}
.topbar{position:sticky;top:0;z-index:100;background:var(--surface);border-bottom:1px solid var(--border);padding:.7rem 2rem;display:flex;align-items:center;justify-content:space-between;box-shadow:0 1px 4px rgba(0,0,0,.04)}
.topbar-left{display:flex;align-items:center;gap:1.2rem}
.topbar-logo{font-family:var(--font-display);font-size:1.45rem;color:var(--navy);font-weight:700}
.topbar-logo em{color:var(--gold);font-style:normal}
.topbar-user{display:flex;align-items:center;gap:.55rem;padding:.35rem .7rem;background:var(--surface2);border-radius:var(--radius-sm);border:1px solid var(--border)}
.topbar-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--navy),var(--navy2));display:flex;align-items:center;justify-content:center;font-size:.68rem;color:#fff;font-weight:700}
.topbar-name{font-size:.78rem;color:var(--text);font-weight:500}
.topbar-right{display:flex;align-items:center;gap:.6rem}
.btn-sm{padding:.38rem .8rem;font-size:.7rem;width:auto}
.page{max-width:1320px;margin:0 auto;padding:1.8rem 2rem 3.5rem}
.section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem;flex-wrap:wrap;gap:.8rem}
.section-head h2{font-family:var(--font-display);font-size:1.6rem;color:var(--navy);font-weight:600}
.section-head h2 span{color:var(--gold)}
.add-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;margin-bottom:1.6rem;box-shadow:var(--shadow)}
.add-grid{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:.7rem;align-items:end}
.add-grid .form-row{margin-bottom:0}
.add-grid .form-row input,.add-grid .form-row select{width:100%;padding:.64rem .8rem;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:.84rem;font-family:var(--font-body);outline:none;transition:border-color .3s,box-shadow .3s;appearance:none;-webkit-appearance:none}
.add-grid .form-row select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath fill='%2394a3b8' d='M0 0l5 6 5-6z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right .75rem center;padding-right:2rem}
.add-grid .form-row select option{background:#fff;color:var(--text)}
.add-grid .form-row input:focus,.add-grid .form-row select:focus{border-color:var(--navy2);box-shadow:0 0 0 3px var(--navy-light)}
.add-grid .form-row input[type=date]{color-scheme:light}
.add-actions{display:flex;gap:.55rem;margin-top:.9rem}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:.9rem;margin-bottom:1.6rem}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem 1.4rem;position:relative;overflow:hidden;box-shadow:var(--shadow);transition:border-color .3s,box-shadow .3s}
.stat-card:hover{border-color:var(--navy2);box-shadow:var(--shadow-md)}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.stat-card:nth-child(1)::before{background:linear-gradient(90deg,var(--gold),var(--gold2))}
.stat-card:nth-child(2)::before{background:linear-gradient(90deg,var(--blue),#60a5fa)}
.stat-card:nth-child(3)::before{background:linear-gradient(90deg,var(--purple),#a78bfa)}
.stat-card:nth-child(4)::before{background:linear-gradient(90deg,var(--green),#4ade80)}
.stat-label{font-size:.68rem;letter-spacing:.7px;text-transform:uppercase;color:var(--text3);margin-bottom:.35rem;font-weight:600}
.stat-value{font-family:var(--font-display);font-size:1.7rem;font-weight:700;color:var(--navy)}
.stat-value.gold{color:var(--gold)}
.stat-sub{font-size:.69rem;color:var(--text3);margin-top:.2rem}
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
.table-bar{display:flex;align-items:center;justify-content:space-between;padding:.9rem 1.3rem;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:.6rem}
.table-bar h3{font-size:.82rem;color:var(--navy);font-weight:600}
.table-bar-right{display:flex;align-items:center;gap:.5rem}
.search-box{position:relative}
.search-box input{padding:.38rem .75rem .38rem 1.9rem;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:.76rem;width:175px;outline:none;transition:border-color .3s,width .3s;font-family:var(--font-body)}
.search-box input:focus{border-color:var(--navy2);width:215px}
.search-box svg{position:absolute;left:.6rem;top:50%;transform:translateY(-50%);color:var(--text3);width:13px;height:13px}
table{width:100%;border-collapse:collapse}
thead{background:var(--navy)}
thead th{text-align:left;padding:.78rem 1.1rem;font-size:.66rem;letter-spacing:.7px;text-transform:uppercase;color:rgba(255,255,255,.75);font-weight:600;white-space:nowrap}
tbody tr{border-bottom:1px solid var(--border);transition:background .2s}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:var(--navy-light)}
tbody td{padding:.72rem 1.1rem;font-size:.82rem;color:var(--text)}
.td-desc{font-weight:600;color:var(--navy)}
.cat-pill{display:inline-block;padding:.18rem .55rem;border-radius:20px;font-size:.68rem;letter-spacing:.3px;text-transform:uppercase;font-weight:600}
.td-amount{font-family:var(--font-mono);font-size:.8rem;font-weight:600;color:var(--gold)}
.td-del{background:none;border:none;color:var(--text3);cursor:pointer;padding:.28rem;border-radius:4px;transition:color .2s,background .2s;font-size:.9rem}
.td-del:hover{color:var(--red);background:var(--red-light)}
.empty-row td{text-align:center;padding:2.8rem;color:var(--text3);font-size:.84rem}
.empty-row .empty-icon{font-size:1.8rem;margin-bottom:.4rem;opacity:.5}
.modal-overlay{position:fixed;inset:0;background:rgba(30,58,95,.35);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);width:90%;max-width:500px;padding:1.8rem;position:relative;box-shadow:var(--shadow-lg);animation:modal-in .25s cubic-bezier(.4,0,.2,1)}
@keyframes modal-in{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
.modal-close{position:absolute;top:.9rem;right:.9rem;background:none;border:none;color:var(--text3);cursor:pointer;font-size:1.1rem;transition:color .2s}
.modal-close:hover{color:var(--red)}
.modal h3{font-family:var(--font-display);font-size:1.4rem;color:var(--navy);margin-bottom:.25rem;font-weight:600}
.modal>p{font-size:.76rem;color:var(--text3);margin-bottom:1.2rem}
.period-pills{display:flex;flex-wrap:wrap;gap:.45rem;margin-bottom:1rem}
.period-pill{padding:.38rem .85rem;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:.73rem;cursor:pointer;font-family:var(--font-body);transition:all .2s;letter-spacing:.3px;font-weight:500}
.period-pill:hover{border-color:var(--navy2);color:var(--navy)}
.period-pill.active{background:var(--navy);color:#fff;border-color:var(--navy);font-weight:600}
.custom-range{display:none;gap:.6rem;align-items:center;margin-bottom:1rem}
.custom-range.show{display:flex}
.custom-range label{font-size:.68rem;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
.custom-range input{flex:1;padding:.46rem .7rem;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:.78rem;font-family:var(--font-body);outline:none;color-scheme:light;transition:border-color .3s}
.custom-range input:focus{border-color:var(--navy2)}
.wm-section{margin-bottom:1rem}
.wm-section label{display:block;font-size:.68rem;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:.35rem;font-weight:600}
.wm-row{display:flex;gap:.5rem;align-items:center}
.wm-row input[type=text]{flex:1;padding:.46rem .7rem;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:.8rem;font-family:var(--font-body);outline:none;transition:border-color .3s}
.wm-row input[type=text]:focus{border-color:var(--navy2)}
.wm-row input[type=color]{width:32px;height:32px;border:1px solid var(--border);border-radius:var(--radius-sm);background:none;cursor:pointer;padding:2px}
.fmt-toggle{display:flex;gap:.45rem;margin-bottom:1.2rem}
.fmt-btn{flex:1;padding:.5rem;border-radius:var(--radius-sm);border:1px solid var(--border);background:transparent;color:var(--text2);font-size:.73rem;cursor:pointer;font-family:var(--font-body);transition:all .2s;text-align:center;letter-spacing:.2px;font-weight:500}
.fmt-btn:hover{border-color:var(--navy2);color:var(--navy)}
.fmt-btn.active{background:var(--navy);color:#fff;border-color:var(--navy);font-weight:600}
.modal-actions{display:flex;gap:.5rem}
.toast{position:fixed;bottom:1.6rem;right:1.6rem;z-index:300;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:.6rem 1rem;font-size:.76rem;color:var(--text);display:flex;align-items:center;gap:.55rem;transform:translateX(140%);transition:transform .35s cubic-bezier(.4,0,.2,1);box-shadow:var(--shadow-md);max-width:280px}
.toast.show{transform:translateX(0)}
.toast.ok .toast-dot{background:var(--green)}.toast.err .toast-dot{background:var(--red)}.toast.info .toast-dot{background:var(--blue)}
.toast-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.confirm-overlay{position:fixed;inset:0;background:rgba(30,58,95,.3);z-index:201;display:none;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.confirm-overlay.show{display:flex}
.confirm-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.6rem;max-width:340px;width:90%;text-align:center;box-shadow:var(--shadow-lg);animation:modal-in .22s cubic-bezier(.4,0,.2,1)}
.confirm-box h4{color:var(--navy);margin-bottom:.3rem;font-weight:600}
.confirm-box p{font-size:.76rem;color:var(--text2);margin-bottom:1.1rem}
.confirm-btns{display:flex;justify-content:center;gap:.5rem}
.confirm-btns .btn{width:auto;padding:.44rem 1.1rem}
.btn-red{background:var(--red);color:#fff;font-weight:600}
.btn-red:hover{background:#b91c1c}
@media(max-width:900px){.add-grid{grid-template-columns:1fr 1fr}.stats-row{grid-template-columns:1fr 1fr}}
@media(max-width:600px){.topbar{padding:.55rem 1rem}.page{padding:1rem 1rem 2.5rem}.add-grid{grid-template-columns:1fr}.stats-row{grid-template-columns:1fr 1fr}.topbar-user .topbar-name{display:none}table{font-size:.76rem}thead th,tbody td{padding:.55rem .65rem}}
@keyframes fade-up{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.anim-in{animation:fade-up .38s cubic-bezier(.4,0,.2,1) both}
.budget-section{margin-bottom:1.6rem}
.budget-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;margin-bottom:.8rem;box-shadow:var(--shadow)}
.budget-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem}
.budget-category{font-size:.85rem;font-weight:600;color:var(--navy)}
.budget-amount{font-size:.75rem;color:var(--text3)}
.budget-progress-bg{width:100%;height:8px;background:var(--surface2);border-radius:20px;overflow:hidden;position:relative}
.budget-progress-bar{height:100%;border-radius:20px;transition:width .5s ease,background .3s}
.budget-progress-bar.safe{background:linear-gradient(90deg,#10b981,#34d399)}
.budget-progress-bar.warning{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.budget-progress-bar.danger{background:linear-gradient(90deg,#ef4444,#f87171)}
.budget-status{display:flex;justify-content:space-between;margin-top:.4rem;font-size:.7rem}
.budget-spent{color:var(--text2);font-weight:600}
.budget-remaining{color:var(--text3)}
.budget-remaining.over{color:var(--red);font-weight:700}
.set-budget-btn{background:var(--gold-light);color:var(--gold);border:1px dashed var(--gold);padding:.5rem 1rem;border-radius:var(--radius-sm);font-size:.75rem;cursor:pointer;transition:all .3s;font-weight:600}
.set-budget-btn:hover{background:var(--gold);color:#fff;border-color:var(--gold)}
.quick-add-fab{position:fixed;bottom:2rem;right:2rem;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#fff;border:none;font-size:1.8rem;cursor:pointer;box-shadow:0 8px 24px rgba(194,133,58,.4);transition:all .3s;z-index:150;display:flex;align-items:center;justify-content:center}
.quick-add-fab:hover{transform:scale(1.1) rotate(90deg);box-shadow:0 12px 32px rgba(194,133,58,.6)}
.quick-add-fab:active{transform:scale(1)}
.quick-add-modal .modal{max-width:400px}
.quick-add-form{display:flex;flex-direction:column;gap:.8rem}
.quick-add-form input,.quick-add-form select{padding:.7rem;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:.85rem}
.streak-badge{background:linear-gradient(135deg,#8b5cf6,#a78bfa);color:#fff;padding:.8rem 1.2rem;border-radius:var(--radius);display:inline-flex;align-items:center;gap:.6rem;font-weight:600;font-size:.85rem;box-shadow:0 4px 12px rgba(139,92,246,.3);margin-bottom:1rem}
.streak-number{font-size:1.8rem;font-family:var(--font-display)}
.achievement-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#fff;padding:2rem;border-radius:var(--radius);text-align:center;z-index:300;box-shadow:0 20px 60px rgba(0,0,0,.4);transition:transform .5s cubic-bezier(.68,-.55,.265,1.55)}
.achievement-popup.show{transform:translate(-50%,-50%) scale(1)}
.achievement-popup h2{font-size:2rem;margin-bottom:.5rem}
body.dark-mode{--bg:#0f172a;--surface:#1e293b;--surface2:#334155;--text:#f1f5f9;--text2:#cbd5e1;--text3:#94a3b8;--border:#334155;--border2:#475569}
.theme-toggle{background:var(--surface2);border:1px solid var(--border);padding:.4rem;border-radius:var(--radius-sm);cursor:pointer;transition:all .3s}
.theme-toggle:hover{background:var(--gold-light)}
.support-btn{display:flex;align-items:center;gap:.5rem;padding:.6rem 1.2rem;border-radius:var(--radius-sm);text-decoration:none;font-size:.75rem;font-weight:600;transition:all .3s;letter-spacing:.3px}
.support-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.15)}
.support-btn:active{transform:translateY(0)}
.goal-card{background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border:2px solid var(--blue);border-radius:var(--radius);padding:1.2rem;margin-bottom:1rem;position:relative;overflow:hidden}
.goal-card::before{content:'ğŸ¯';position:absolute;top:.5rem;right:.5rem;font-size:2rem;opacity:.2}
.goal-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.8rem}
.goal-title{font-size:1rem;font-weight:700;color:var(--navy)}
.goal-amount{font-size:.9rem;color:var(--text2)}
.goal-progress-container{position:relative;margin-bottom:.5rem}
.goal-progress-bg{width:100%;height:12px;background:rgba(255,255,255,.6);border-radius:20px;overflow:hidden;border:1px solid rgba(37,99,235,.2)}
.goal-progress-fill{height:100%;background:linear-gradient(90deg,#3b82f6,#60a5fa);border-radius:20px;transition:width .5s ease;position:relative}
.goal-progress-fill::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shimmer 2s infinite}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.goal-stats{display:flex;justify-content:space-between;font-size:.75rem;margin-top:.4rem}
.goal-saved{color:var(--blue);font-weight:700}
.goal-remaining{color:var(--text3)}
.goal-actions{position:absolute;top:.8rem;right:2.5rem;display:flex;gap:.3rem}
.goal-action-btn{background:none;border:none;color:var(--text3);cursor:pointer;font-size:.9rem;transition:all .2s}
.goal-action-btn:hover{transform:scale(1.2);color:var(--navy)}
.no-goals{text-align:center;padding:3rem;background:var(--surface2);border-radius:var(--radius);border:2px dashed var(--border)}
.no-goals-icon{font-size:3rem;margin-bottom:1rem;opacity:.5}
.no-goals-text{color:var(--text3);margin-bottom:1rem}
.achievements-container{background:linear-gradient(135deg,#fef3c7,#fde68a);border:2px solid var(--gold);border-radius:var(--radius);padding:1rem;display:flex;gap:.8rem;align-items:center;overflow-x:auto}
.achievement-badge{min-width:60px;text-align:center;cursor:pointer;transition:transform .2s}
.achievement-badge:hover{transform:scale(1.1)}
.achievement-icon{font-size:2rem;margin-bottom:.3rem}
.achievement-label{font-size:.65rem;color:var(--text2);font-weight:600}
.achievement-locked{opacity:.3;filter:grayscale(1)}
.shortcuts-hint{position:fixed;bottom:20px;right:20px;background:rgba(30,58,95,.95);color:#fff;padding:.8rem 1.2rem;border-radius:var(--radius);font-size:.75rem;z-index:300;display:none}
.shortcuts-hint.show{display:block;animation:fadeIn .3s}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
</style>
</head>
<body>

<section id="authScreen" class="z1">
  <!-- Animated Finance Particles -->
  <div class="finance-particle">ğŸ’°</div>
  <div class="finance-particle">ğŸ“Š</div>
  <div class="finance-particle">ğŸ’³</div>
  <div class="finance-particle">ğŸ“ˆ</div>
  <div class="finance-particle">ğŸ’µ</div>
  <div class="finance-particle">ğŸ¦</div>
  <div class="finance-particle">ğŸ’</div>
  <div class="finance-particle">ğŸ“‰</div>
  
  <div class="auth-logo"><h1>Finance<em>Flow</em></h1><p>Cloud-Powered Expense Management</p></div>
  <div class="auth-card">
    <div class="auth-tabs">
      <button class="auth-tab active" data-tab="login">Sign In</button>
      <button class="auth-tab" data-tab="register">Create Account</button>
    </div>
    <div class="auth-body">
      <div class="alert" id="authAlert"></div>
      <form id="loginForm" autocomplete="off">
        <div class="form-row"><label>Email</label><input type="email" id="loginEmail" placeholder="you@example.com" required></div>
        <div class="form-row"><label>Password</label><input type="password" id="loginPw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required></div>
        <button type="button" class="forgot-link" id="forgotBtn">Forgot password?</button>
        <button type="submit" class="btn btn-navy" id="loginBtn">Sign In</button>
      </form>
      <form id="registerForm" style="display:none" autocomplete="off">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.7rem">
          <div class="form-row"><label>First Name</label><input type="text" id="regFirst" placeholder="Benjamin" required></div>
          <div class="form-row"><label>Last Name</label><input type="text" id="regLast" placeholder="Omondi" required></div>
        </div>
        <div class="form-row"><label>Email</label><input type="email" id="regEmail" placeholder="benjamami@example.com" required></div>
        <div class="form-row"><label>Phone (optional)</label><input type="tel" id="regPhone" placeholder="+254 712 345 678"></div>
        <div class="form-row"><label>Watermark Text</label><input type="text" id="regWatermark" placeholder="e.g. BENJAMIN O" required><p class="hint">Appears on your PDF reports</p></div>
        <div class="form-row"><label>Password</label><input type="password" id="regPw" placeholder="Minimum 8 characters" required>
          <div class="pw-strength"><div class="pw-bar" id="pwBar1"></div><div class="pw-bar" id="pwBar2"></div><div class="pw-bar" id="pwBar3"></div><div class="pw-bar" id="pwBar4"></div></div>
          <p class="pw-label" id="pwLabel">Enter a password</p></div>
        <div class="form-row"><label>Confirm Password</label><input type="password" id="regPwConf" placeholder="Re-enter password" required></div>
        <button type="submit" class="btn btn-navy" id="registerBtn">Create Account</button>
      </form>
      <div id="forgotScreen" style="display:none">
        <div class="form-row"><label>Email Address</label><input type="email" id="forgotEmail" placeholder="you@example.com"></div>
        <button type="button" class="btn btn-navy" id="forgotSendBtn">Send Reset Email</button>
        <div style="margin-top:.7rem;text-align:center"><button class="forgot-link" id="backFromForgot">â† Back to Sign In</button></div>
</div>
    </div>
  </div>
  
  <!-- Support Buttons -->
  <div style="display:flex;justify-content:center;gap:1rem;margin-top:1.5rem;position:relative;z-index:2">
    <a href="https://wa.me/254798116803?text=Hi%2C%20I%20need%20technical%20assistance%20with%20FinanceFlow" target="_blank" style="display:flex;align-items:center;gap:.5rem;padding:.6rem 1.2rem;background:rgba(37,211,102,.1);border:1.5px solid rgba(37,211,102,.3);border-radius:var(--radius-sm);color:#25d366;text-decoration:none;font-size:.75rem;font-weight:600;transition:all .3s;letter-spacing:.3px">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
      </svg>
      WhatsApp Support
    </a>
    
    <a href="mailto:omondibenjamin387@gmail.com?subject=TECHNICAL%20ASSISTANCE%20REQUEST&body=Hello%20Benjamin%2C%0A%0AI%20need%20technical%20assistance%20with%20FinanceFlow.%0A%0ADetails%3A%0A%0A%0A%0AThank%20you!" style="display:flex;align-items:center;gap:.5rem;padding:.6rem 1.2rem;background:rgba(37,99,235,.08);border:1.5px solid rgba(37,99,235,.25);border-radius:var(--radius-sm);color:var(--blue);text-decoration:none;font-size:.75rem;font-weight:600;transition:all .3s;letter-spacing:.3px">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
        <polyline points="22,6 12,13 2,6"/>
      </svg>
      Email Support
    </a>
  </div>
  
  <!-- Footer -->
  <div style="text-align:center;margin-top:2rem;padding-bottom:1rem;position:relative;z-index:2">
    <p style="font-size:.72rem;color:var(--text3);letter-spacing:.8px;font-weight:500">
      Proudly Designed By <span style="color:var(--gold);font-weight:700">Benjamin</span>
    </p>
  </div>
</section>

<section id="appScreen" class="z1">
  <nav class="topbar">
    <div class="topbar-left">
      <span class="topbar-logo">Finance<em>Flow</em></span>
      <div class="topbar-user"><div class="topbar-avatar" id="topbarAvatar">BO</div><span class="topbar-name" id="topbarName">Benjamin Omondi</span></div>
      <select id="currencySelector" style="padding:.35rem .6rem;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);font-size:.75rem;cursor:pointer">
        <option value="KSH">KSH</option>
        <option value="USD">USD ($)</option>
        <option value="EUR">EUR (â‚¬)</option>
        <option value="GBP">GBP (Â£)</option>
      </select>
    </div>
    <div class="topbar-right">
      <button class="theme-toggle btn-sm" id="themeToggle" title="Toggle Dark Mode">ğŸŒ™</button>
      <button class="btn btn-ghost btn-sm" id="backupBtn" title="Backup Data">ğŸ’¾</button>
      <button class="btn btn-ghost btn-sm" id="exportSheetsBtn" title="Export to Google Sheets">ğŸ“Š</button>
      <button class="btn btn-navy btn-sm" id="aiInsightsBtn">ğŸ¤– AI Insights</button>
      <button class="btn btn-navy btn-sm" id="exportBtn">â¬‡ Export</button>
      <button class="btn btn-ghost btn-sm" id="logoutBtn">Sign Out</button>
    </div>
  </nav>
  <div class="page">
    <div class="add-card anim-in">
      <div class="section-head" style="margin-bottom:.9rem"><h2>Add <span>Expense</span></h2></div>
      <div class="add-grid">
        <div class="form-row"><label>Description</label><input type="text" id="expDesc" placeholder="e.g. Grocery Shopping"></div>
        <div class="form-row"><label>Amount (KSH)</label><input type="number" id="expAmt" placeholder="0.00" step="0.01" min="0"></div>
        <div class="form-row"><label>Category</label>
          <select id="expCat">
            <option value="Food">ğŸ½  Food</option><option value="Transport">ğŸš—  Transport</option>
            <option value="Entertainment">ğŸ¬  Entertainment</option><option value="Utilities">ğŸ’¡  Utilities</option>
            <option value="Healthcare">ğŸ¥  Healthcare</option><option value="Shopping">ğŸ›  Shopping</option>
            <option value="Education">ğŸ“š  Education</option><option value="Housing">ğŸ   Housing</option>
            <option value="Other">ğŸ“Œ  Other</option>
          </select>
        </div>
        <div class="form-row"><label>Date</label><input type="date" id="expDate"></div>
      </div>
      <div class="add-actions">
        <button class="btn btn-navy btn-sm" id="addExpBtn" style="width:auto">+ Add Expense</button>
        <button class="btn btn-ghost btn-sm" id="clearExpBtn" style="width:auto">Clear</button>
      </div>
    </div>
    </div>
      <div style="border-top:1px solid var(--border);margin-top:1rem;padding-top:1rem">
        <label style="font-size:.75rem;color:var(--text2);font-weight:600;display:block;margin-bottom:.5rem">ğŸ“¸ Or Upload Receipt</label>
        <input type="file" id="receiptUpload" accept="image/*" style="display:none" />
        <button class="btn btn-ghost btn-sm" onclick="document.getElementById('receiptUpload').click()" style="width:100%">ğŸ“¤ Upload Receipt (Auto-Extract)</button>
      </div>
    <div class="stats-row">
      <div class="stat-card anim-in"><div class="stat-label">Weekly</div><div class="stat-value gold" id="statWeekly">KSH 0</div><div class="stat-sub" id="statWeeklySub">0 transactions</div></div>
      <div class="stat-card anim-in" style="animation-delay:.07s"><div class="stat-label">Monthly</div><div class="stat-value gold" id="statMonthly">KSH 0</div><div class="stat-sub" id="statMonthlySub">0 transactions</div></div>
      <div class="stat-card anim-in" style="animation-delay:.13s"><div class="stat-label">Annual</div><div class="stat-value gold" id="statAnnual">KSH 0</div><div class="stat-sub" id="statAnnualSub">0 transactions</div></div>
      <div class="stat-card anim-in" style="animation-delay:.19s"><div class="stat-label">All Time</div><div class="stat-value" id="statTotal">KSH 0</div><div class="stat-sub" id="statTotalSub">0 total entries</div></div>
    </div>
    
    <div class="section-head" style="margin-top:1.5rem">
      <h2>Financial <span>Goals</span></h2>
      <button class="btn btn-ghost btn-sm" id="addGoalBtn">ğŸ¯ New Goal</button>
    </div>
    
    <div class="section-head" style="margin-top:1.5rem">
      <h2>Analytics <span>Dashboard</span></h2>
      <button class="btn btn-ghost btn-sm" id="toggleDashboard">ğŸ“Š Toggle</button>
    </div>
    <div id="analyticsDashboard" style="display:none;margin-bottom:1.6rem">
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:1rem">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem">
          <h4 style="font-size:.85rem;color:var(--navy);margin-bottom:1rem;font-weight:600">Weekly Trends</h4>
          <canvas id="weeklyChart" style="max-height:200px"></canvas>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem">
          <h4 style="font-size:.85rem;color:var(--navy);margin-bottom:1rem;font-weight:600">Top 5 Expenses</h4>
          <canvas id="topExpensesChart" style="max-height:200px"></canvas>
        </div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem">
        <h4 style="font-size:.85rem;color:var(--navy);margin-bottom:1rem;font-weight:600">Category Distribution (Last 90 Days)</h4>
        <canvas id="quarterlyChart" style="max-height:250px"></canvas>
      </div>
    </div>
    
    <div class="table-wrap anim-in" style="animation-delay:.24s">
    </div>
    <div id="goalsContainer" style="margin-bottom:1.6rem"></div>
    
    <div class="table-wrap anim-in" style="animation-delay:.24s">
    </div>
    
    <div id="streakBadge"></div>
    <div id="streakBadge"></div>
    <div id="achievementsBanner" style="margin-bottom:1rem"></div>
    <div class="stat-card" style="background:linear-gradient(135deg,#eef2ff,#fdf2e9);border:2px solid var(--gold);margin-bottom:1rem">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="stat-label">ğŸ’« Today's Spending</div>
          <div class="stat-value gold" id="todaySpending">KSH 0</div>
          <div class="stat-sub" id="todaySub">0 transactions today</div>
        </div>
        <div style="text-align:right">
          <div class="stat-label">ğŸ¯ Biggest Purchase</div>
          <div style="font-size:1.2rem;font-weight:700;color:var(--navy)" id="biggestToday">â€”</div>
        </div>
      </div>
    </div>
    
    <div class="budget-section anim-in" style="animation-delay:.25s">
      <div class="section-head">
        <h2>Budget <span>Goals</span></h2>
        <button class="btn btn-ghost btn-sm" id="manageBudgetsBtn">âš™ï¸ Manage</button>
        <button class="btn btn-ghost btn-sm" id="manageCategoriesBtn">ğŸ¨ Categories</button>
      </div>
      <div id="budgetCards"></div>
    </div>
    
    <div class="table-wrap anim-in" style="animation-delay:.24s">
      <div class="table-bar">
        <h3>Expense History</h3>
        <div class="table-bar-right"><div class="search-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><input type="text" id="searchInput" placeholder="Searchâ€¦"></div></div>
      </div>
      <table><thead><tr><th>#</th><th>Date</th><th>Description</th><th>Category</th><th style="text-align:right">Amount</th><th></th></tr></thead><tbody id="expenseBody"></tbody></table>
    </div>
  </div>
</section>

<div class="modal-overlay" id="exportOverlay">
  <div class="modal">
    <button class="modal-close" id="exportClose">âœ•</button>
    <h3>Download Report</h3><p>Choose period and format.</p>
    <div style="margin-bottom:.55rem">
      <label style="font-size:.68rem;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:.35rem;font-weight:600">Period</label>
      <div class="period-pills">
        <button class="period-pill" data-period="week">Weekly</button>
        <button class="period-pill" data-period="month">Monthly</button>
        <button class="period-pill" data-period="year">Annual</button>
        <button class="period-pill" data-period="custom">Custom</button>
      </div>
    </div>
    <div class="custom-range" id="customRange"><label>From</label><input type="date" id="customFrom"><label>To</label><input type="date" id="customTo"></div>
    <div class="wm-section"><label>Watermark</label><div class="wm-row"><input type="text" id="wmText" placeholder="Watermarkâ€¦"><input type="color" id="wmColor" value="#c2853a"></div></div>
    <label style="font-size:.68rem;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:.35rem;font-weight:600">Format</label>
    <div class="fmt-toggle">
      <button class="fmt-btn active" data-fmt="pdf">ğŸ“„ PDF</button>
      <button class="fmt-btn" data-fmt="xlsx">ğŸ“Š Excel</button>
    </div>
    <div class="modal-actions"><button class="btn btn-navy" id="downloadBtn">â¬‡ Download</button><button class="btn btn-ghost" id="exportCancelBtn" style="width:auto;flex:0">Cancel</button></div>
  </div>
</div>

<!-- AI Insights Modal -->
<div class="modal-overlay" id="aiInsightsOverlay">
  <div class="modal" style="max-width:900px;max-height:90vh;overflow-y:auto">
    <button class="modal-close" id="aiInsightsClose">âœ•</button>
    <h3>ğŸ¤– AI-Powered Expense Insights</h3>
    <p>Advanced analysis and predictions for your spending patterns</p>
    
    <div id="aiInsightsLoading" style="text-align:center;padding:3rem;display:none">
      <div class="loading" style="width:40px;height:40px;border-width:4px;margin:0 auto 1rem;border:4px solid var(--navy-light);border-top-color:var(--navy)"></div>
      <p style="color:var(--text3);font-size:.85rem">Analyzing your expenses with AI...</p>
    </div>
    
    <div id="aiInsightsContent" style="display:none">
      <div style="margin-bottom:1.5rem;padding:1rem;background:var(--surface2);border-radius:var(--radius-sm)">
        <label style="font-size:.72rem;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:.5rem;font-weight:600">Analyze Period</label>
        <div class="period-pills">
          <button class="period-pill" data-ai-period="week">This Week</button>
          <button class="period-pill active" data-ai-period="month">This Month</button>
          <button class="period-pill" data-ai-period="year">This Year</button>
          <button class="period-pill" data-ai-period="all">All Time</button>
        </div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem">
          <h4 style="font-size:.85rem;color:var(--navy);margin-bottom:1rem;font-weight:600">Spending by Category</h4>
          <canvas id="categoryChart" style="max-height:200px"></canvas>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem">
          <h4 style="font-size:.85rem;color:var(--navy);margin-bottom:1rem;font-weight:600">Spending Trend</h4>
          <canvas id="trendChart" style="max-height:200px"></canvas>
        </div>
      </div>
      
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;margin-bottom:1.5rem">
        <h4 style="font-size:.85rem;color:var(--navy);margin-bottom:1rem;font-weight:600">ğŸ“Š Monthly Comparison: This Month vs Last Month</h4>
        <canvas id="comparisonChart" style="max-height:250px"></canvas>
      </div>
      
      <div style="background:linear-gradient(135deg,#eef2ff,#fdf2e9);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;margin-bottom:1rem">
        <h4 style="font-size:.9rem;color:var(--navy);margin-bottom:.8rem;font-weight:600;display:flex;align-items:center;gap:.5rem">
          <span style="font-size:1.2rem">ğŸ’¡</span> AI Insights & Recommendations
        </h4>
        <div id="aiInsightsText" style="font-size:.85rem;line-height:1.7;color:var(--text);white-space:pre-wrap"></div>
      </div>
      
      <div style="display:flex;gap:.5rem">
        <button class="btn btn-navy btn-sm" id="downloadInsightsBtn" style="flex:1">ğŸ“¥ Download Report</button>
        <button class="btn btn-navy btn-sm" id="emailInsightsBtn" style="flex:1">ğŸ“§ Email Report</button>
        <button class="btn btn-navy btn-sm" id="whatsappInsightsBtn" style="flex:1">ğŸ’¬ WhatsApp</button>
        <button class="btn btn-ghost btn-sm" id="refreshInsightsBtn" style="width:auto">ğŸ”„ Refresh</button>
      </div>
    </div>
  </div>
</div>

<!-- Email Input Modal -->
<div class="modal-overlay" id="emailInputOverlay">
  <div class="modal" style="max-width:400px">
    <button class="modal-close" id="emailInputClose">âœ•</button>
    <h3>ğŸ“§ Email AI Report</h3>
    <p style="margin-bottom:1.2rem">Send insights to your email</p>
    <div class="form-row">
      <label>Email Address</label>
      <input type="email" id="insightsEmailInput" placeholder="you@example.com">
    </div>
    <div style="display:flex;gap:.5rem;margin-top:1rem">
      <button class="btn btn-navy" id="sendEmailBtn">Send</button>
      <button class="btn btn-ghost" id="cancelEmailBtn">Cancel</button>
    </div>
  </div>
</div>

<div class="confirm-overlay" id="confirmOverlay"><div class="confirm-box"><h4 id="confirmTitle">Confirm</h4><p id="confirmMsg">Sure?</p><div class="confirm-btns"><button class="btn btn-ghost btn-sm" id="confirmCancel">Cancel</button><button class="btn btn-red btn-sm" id="confirmOk">Delete</button></div></div></div>
<div class="toast" id="toast"><div class="toast-dot"></div><span id="toastMsg"></span></div>

<button class="quick-add-fab" id="quickAddFab" title="Quick Add Expense">+</button>
<div class="achievement-popup" id="achievementPopup"></div>

<div class="modal-overlay quick-add-modal" id="quickAddModal">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('quickAddModal').classList.remove('show')">âœ•</button>
    <h3>âš¡ Quick Add Expense</h3>
    <p style="margin-bottom:1rem">Fast expense entry</p>
    <div class="quick-add-form">
      <div style="position:relative">
        <input type="text" id="quickDesc" placeholder="What did you buy?" />
        <button id="voiceBtn" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--gold)" title="Voice Input">ğŸ¤</button>
      </div>
      <input type="number" id="quickAmt" placeholder="Amount (KSH)" step="0.01" />
      <select id="quickCat">
        <option value="Food">ğŸ½ Food</option>
        <option value="Transport">ğŸš— Transport</option>
        <option value="Entertainment">ğŸ¬ Entertainment</option>
        <option value="Utilities">ğŸ’¡ Utilities</option>
        <option value="Healthcare">ğŸ¥ Healthcare</option>
        <option value="Shopping">ğŸ› Shopping</option>
        <option value="Education">ğŸ“š Education</option>
        <option value="Housing">ğŸ  Housing</option>
        <option value="Other">ğŸ“Œ Other</option>
      </select>
      <button class="btn btn-navy" id="quickAddSave">ğŸ’¾ Save</button>
      <button class="btn btn-ghost" id="quickSplitBtn">ğŸ‘¥ Split Bill</button>
    </div>
  </div>
</div>
<button id="aiChatBtn" style="position:fixed;bottom:80px;right:20px;width:55px;height:55px;border-radius:50%;background:linear-gradient(135deg,#8b5cf6,#a78bfa);color:#fff;border:none;font-size:1.5rem;cursor:pointer;box-shadow:0 4px 12px rgba(139,92,246,.4);z-index:200">ğŸ’¬</button>

<div class="modal-overlay" id="aiChatModal">
  <div class="modal" style="max-width:500px;max-height:600px;display:flex;flex-direction:column">
    <button class="modal-close" onclick="document.getElementById('aiChatModal').classList.remove('show')">âœ•</button>
    <h3>ğŸ¤– AI Assistant</h3>
    <p style="margin-bottom:1rem;font-size:.8rem">Ask questions about your spending</p>
    
    <div id="chatMessages" style="flex:1;overflow-y:auto;background:var(--surface2);border-radius:var(--radius-sm);padding:1rem;margin-bottom:1rem;max-height:400px"></div>
    
    <div style="display:flex;gap:.5rem">
      <input type="text" id="chatInput" placeholder="Ask anything..." style="flex:1;padding:.7rem;border:1px solid var(--border);border-radius:var(--radius-sm)" />
      <button class="btn btn-navy btn-sm" id="chatSendBtn">Send</button>
    </div>
  </div>
</div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// âš ï¸ REPLACE THIS WITH YOUR FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyBFJ_cZFVgeRgIMaCeW1atIFZ80xhGSwAc",
  authDomain: "financetrack-e4ec9.firebaseapp.com",
  projectId: "financetrack-e4ec9",
  storageBucket: "financetrack-e4ec9.firebasestorage.app",
  messagingSenderId: "469678326579",
  appId: "1:469678326579:web:92e885691bca4d29d17446",
  measurementId: "G-7FMSNGD1BB"
};

let app, auth, db;
try {
  app = firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
  
  // Configure custom email templates
  auth.languageCode = 'en';
  
  console.log('%câœ… Firebase Connected Successfully', 'color:#16a34a;font-weight:bold;font-size:14px;padding:4px 8px;background:#d1fae5;border-radius:4px');
} catch(e) {
  console.error('%câš ï¸ Firebase Setup Required', 'color:#dc2626;font-weight:bold;font-size:14px;padding:4px 8px;background:#fee2e2;border-radius:4px');
  console.log('%c\nFollow the setup guide to configure Firebase.\nReplace the firebaseConfig object above with your actual config.\n', 'color:#2563eb;font-size:12px');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITY FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toast(msg,type='ok'){const t=document.getElementById('toast');t.className='toast '+type;document.getElementById('toastMsg').textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800)}

let _confirmResolve=null;
function confirm2(title,msg){return new Promise(res=>{document.getElementById('confirmTitle').textContent=title;document.getElementById('confirmMsg').textContent=msg;document.getElementById('confirmOverlay').classList.add('show');_confirmResolve=res})}
document.getElementById('confirmCancel').addEventListener('click',()=>{document.getElementById('confirmOverlay').classList.remove('show');if(_confirmResolve)_confirmResolve(false)});
document.getElementById('confirmOk').addEventListener('click',()=>{document.getElementById('confirmOverlay').classList.remove('show');if(_confirmResolve)_confirmResolve(true)});

function getPasswordStrength(pw){let s=0;if(pw.length>=8)s++;if(pw.length>=12)s++;if(/[A-Z]/.test(pw)&&/[a-z]/.test(pw))s++;if(/[0-9]/.test(pw))s++;if(/[^A-Za-z0-9]/.test(pw))s++;return Math.min(s,4)}
function updatePwUI(pw){const s=getPasswordStrength(pw);const labels=['','Weak','Fair','Good','Strong âœ“'];const cls=['','weak','ok','good','strong'];for(let i=1;i<=4;i++)document.getElementById('pwBar'+i).className='pw-bar'+(i<=s?' '+cls[s]:'');const lbl=document.getElementById('pwLabel');lbl.textContent=labels[s]||'Enter a password';lbl.style.color=s>=4?'var(--green)':s>=2?'var(--text3)':'var(--red)'}
document.getElementById('regPw').addEventListener('input',e=>updatePwUI(e.target.value));

function authAlert(msg,type='err'){const el=document.getElementById('authAlert');el.className='alert alert-'+type+' show';el.textContent=msg}
function clearAlert(){document.getElementById('authAlert').classList.remove('show')}

function showAuthSub(id){['loginForm','registerForm','forgotScreen'].forEach(x=>document.getElementById(x).style.display=x===id?'block':'none')}

function setLoading(btnId, loading) {
  const btn = document.getElementById(btnId);
  if(loading) {
    btn.disabled = true;
    btn.innerHTML = '<span class="loading"></span> Processing...';
  } else {
    btn.disabled = false;
    btn.textContent = btn.id === 'loginBtn' ? 'Sign In' : btn.id === 'registerBtn' ? 'Create Account' : 'Send Reset Email';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTHENTICATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.querySelectorAll('.auth-tab').forEach(tab=>{tab.addEventListener('click',()=>{clearAlert();document.querySelectorAll('.auth-tab').forEach(t=>t.classList.remove('active'));tab.classList.add('active');const w=tab.dataset.tab;showAuthSub(w==='login'?'loginForm':'registerForm')})});

document.getElementById('forgotBtn').addEventListener('click',()=>{clearAlert();showAuthSub('forgotScreen')});
document.getElementById('backFromForgot').addEventListener('click',()=>{clearAlert();showAuthSub('loginForm')});

// Register - FIXED: No auto-login
document.getElementById('registerForm').addEventListener('submit', async e => {
  e.preventDefault();clearAlert();
  const first=document.getElementById('regFirst').value.trim();
  const last=document.getElementById('regLast').value.trim();
  const email=document.getElementById('regEmail').value.trim();
  const phone=document.getElementById('regPhone').value.trim();
  const wm=document.getElementById('regWatermark').value.trim();
  const pw=document.getElementById('regPw').value;
  const pwc=document.getElementById('regPwConf').value;
  
  if(!first||!last||!email||!wm)return authAlert('Fill all required fields');
  if(pw.length<8)return authAlert('Password: minimum 8 characters');
  if(getPasswordStrength(pw)<2)return authAlert('Password too weak');
  if(pw!==pwc)return authAlert('Passwords don\'t match');
  
  setLoading('registerBtn', true);
  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pw);
    await db.collection('users').doc(cred.user.uid).set({
      first, last, email, phone, watermark:wm, createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    // Sign out immediately to prevent auto-login
    await auth.signOut();
    authAlert('Account created successfully! Please sign in.', 'ok');
    document.getElementById('registerForm').reset();
    updatePwUI('');
    showAuthSub('loginForm');
    document.querySelectorAll('.auth-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab==='login'));
  } catch(err) {
    authAlert(err.code==='auth/email-already-in-use'?'Email already registered':err.message);
  }
  setLoading('registerBtn', false);
});

// Login - FIXED: Working properly
document.getElementById('loginForm').addEventListener('submit', async e => {
  e.preventDefault();clearAlert();
  const email=document.getElementById('loginEmail').value.trim();
  const pw=document.getElementById('loginPw').value;
  
  setLoading('loginBtn', true);
  try {
    await auth.signInWithEmailAndPassword(email, pw);
    // Success toast handled by auth state listener
  } catch(err) {
    authAlert(err.code==='auth/wrong-password'||err.code==='auth/user-not-found'?'Invalid email or password':err.message);
    setLoading('loginBtn', false);
  }
});

// Forgot Password
document.getElementById('forgotSendBtn').addEventListener('click', async () => {
  const email=document.getElementById('forgotEmail').value.trim();
  if(!email)return authAlert('Enter your email');
  
  setLoading('forgotSendBtn', true);
  try {
    await auth.sendPasswordResetEmail(email);
    authAlert('Password reset email sent! Check your inbox.', 'ok');
  } catch(err) {
    authAlert(err.code==='auth/user-not-found'?'Email not found':err.message);
  }
  setLoading('forgotSendBtn', false);
});

// Logout
document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());

// Auth state listener
auth.onAuthStateChanged(async user => {
  if(user) {
    const userDoc = await db.collection('users').doc(user.uid).get();
    const userData = userDoc.data();
    document.getElementById('authScreen').style.display='none';
    document.getElementById('appScreen').classList.add('show');
    document.getElementById('topbarAvatar').textContent=((userData.first[0]||'')+(userData.last[0]||'')).toUpperCase();
    document.getElementById('topbarName').textContent=userData.first+' '+userData.last;
    document.getElementById('wmText').value=userData.watermark||userData.first;
    document.getElementById('expDate').value=new Date().toISOString().split('T')[0];
    loadExpenses(user.uid);
  } else {
    document.getElementById('appScreen').classList.remove('show');
    document.getElementById('authScreen').style.display='flex';
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPENSE MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentExpenses = [];
let currentUserId = null;

function loadExpenses(userId) {
  currentUserId = userId;
  db.collection('expenses').where('userId','==',userId)
    .onSnapshot(snapshot => {
      currentExpenses = snapshot.docs.map(doc => ({id:doc.id, ...doc.data()}));
      // Sort by date in JavaScript instead of Firestore
      currentExpenses.sort((a,b) => new Date(b.date) - new Date(a.date));
      renderTable();
      renderAchievements();
    });
}

document.getElementById('addExpBtn').addEventListener('click', async () => {
  if(!currentUserId)return;
  const desc=document.getElementById('expDesc').value.trim();
  const amt=parseFloat(document.getElementById('expAmt').value);
  const cat=document.getElementById('expCat').value;
  const date=document.getElementById('expDate').value;
  
  if(!desc)return toast('Enter description','err');
  if(!amt||amt<=0)return toast('Enter valid amount','err');
  if(!date)return toast('Pick a date','err');
  
  try {
    await db.collection('expenses').add({
      userId:currentUserId, desc, amt, cat, date,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('expDesc').value='';
    document.getElementById('expAmt').value='';
    document.getElementById('expDate').value=new Date().toISOString().split('T')[0];
    toast('Expense added','ok');
  } catch(err) {
    toast('Error adding expense','err');
  }
});

document.getElementById('clearExpBtn').addEventListener('click',()=>{
  document.getElementById('expDesc').value='';
  document.getElementById('expAmt').value='';
  document.getElementById('expDate').value=new Date().toISOString().split('T')[0];
});

document.getElementById('expenseBody').addEventListener('click', async e => {
  const btn=e.target.closest('.td-del');
  if(!btn)return;
  const ok=await confirm2('Delete Expense','Cannot be undone.');
  if(!ok)return;
  try {
    await db.collection('expenses').doc(btn.dataset.id).delete();
    toast('Deleted','ok');
  } catch(err) {
    toast('Error deleting','err');
  }
});

const CAT_COLORS={Food:'#f59e0b',Transport:'#3b82f6',Entertainment:'#8b5cf6',Utilities:'#d97706',Healthcare:'#ef4444',Shopping:'#10b981',Education:'#0ea5e9',Housing:'#c2853a',Other:'#6b7280'};
const CAT_BG={Food:'#fef3c7',Transport:'#dbeafe',Entertainment:'#ede9fe',Utilities:'#fef3c7',Healthcare:'#fee2e2',Shopping:'#d1fae5',Education:'#e0f2fe',Housing:'#fdf2e9',Other:'#f3f4f6'};

function renderTable(){
  const search=document.getElementById('searchInput').value.trim().toLowerCase();
  let exps=currentExpenses.filter(e=>!search||e.desc.toLowerCase().includes(search)||e.cat.toLowerCase().includes(search));
  const tbody=document.getElementById('expenseBody');
  if(!exps.length){tbody.innerHTML='<tr class="empty-row"><td colspan="6"><div class="empty-icon">ğŸ“‹</div>No expenses yet</td></tr>';return}
  tbody.innerHTML=exps.map((exp,i)=>{
    const d=new Date(exp.date+'T00:00:00');
    const ds=d.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
    return`<tr><td style="color:var(--text3);font-weight:600">${i+1}</td><td style="color:var(--text2)">${ds}</td><td class="td-desc">${exp.desc}</td><td><span class="cat-pill" style="background:${CAT_BG[exp.cat]||'#f3f4f6'};color:${CAT_COLORS[exp.cat]||'#6b7280'}">${exp.cat}</span></td><td class="td-amount" style="text-align:right">${formatCurrency(exp.amt)}</td><td><button class="td-del" data-id="${exp.id}">ğŸ—‘</button></td></tr>`}).join('');
}
document.getElementById('searchInput').addEventListener('input',renderTable);

function renderAchievements(){
  const now=new Date();
  const calc=days=>{const cut=new Date(now);cut.setDate(cut.getDate()-days);return currentExpenses.filter(e=>new Date(e.date+'T00:00:00')>=cut)};
  const w=calc(7),m=calc(30),y=calc(365),all=currentExpenses;
  const sum=arr=>arr.reduce((s,e)=>s+e.amt,0);
  const fmt=n=>'KSH '+n.toLocaleString('en',{minimumFractionDigits:0});
  document.getElementById('statWeekly').textContent=fmt(sum(w));
  document.getElementById('statWeeklySub').textContent=w.length+' transaction'+(w.length!==1?'s':'');
  document.getElementById('statMonthly').textContent=fmt(sum(m));
  document.getElementById('statMonthlySub').textContent=m.length+' transaction'+(m.length!==1?'s':'');
  document.getElementById('statAnnual').textContent=fmt(sum(y));
  document.getElementById('statAnnualSub').textContent=y.length+' transaction'+(y.length!==1?'s':'');
  document.getElementById('statTotal').textContent=fmt(sum(all));
  document.getElementById('statTotalSub').textContent=all.length+' total entr'+(all.length!==1?'ies':'y');
  
  const today=new Date().toISOString().split('T')[0];
  const todayExpenses=currentExpenses.filter(e=>e.date===today);
  const todayTotal=sum(todayExpenses);
  document.getElementById('todaySpending').textContent=fmt(todayTotal);
  document.getElementById('todaySub').textContent=todayExpenses.length+' transaction'+(todayExpenses.length!==1?'s':'')+' today';
  const biggest=todayExpenses.sort((a,b)=>b.amt-a.amt)[0];
  document.getElementById('biggestToday').textContent=biggest?`KSH ${biggest.amt.toLocaleString()}`:'â€”';
  
  renderBudgets();
  checkSmartAlerts();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SMART ALERTS SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let lastAlertCheck=localStorage.getItem('lastAlertCheck')||'';

function checkSmartAlerts(){
  const today=new Date().toISOString().split('T')[0];
  if(lastAlertCheck===today)return;
  
  const thisMonth=new Date();thisMonth.setDate(1);
  const monthExpenses=currentExpenses.filter(e=>new Date(e.date+'T00:00:00')>=thisMonth);
  const monthTotal=monthExpenses.reduce((s,e)=>s+e.amt,0);
  
  const lastMonth=new Date();lastMonth.setMonth(lastMonth.getMonth()-1);lastMonth.setDate(1);
  const lastMonthEnd=new Date();lastMonthEnd.setDate(0);
  const lastMonthExpenses=currentExpenses.filter(e=>{
    const d=new Date(e.date+'T00:00:00');
    return d>=lastMonth&&d<=lastMonthEnd;
  });
  const lastMonthTotal=lastMonthExpenses.reduce((s,e)=>s+e.amt,0);
  
  if(monthTotal>lastMonthTotal*1.2){
    showSmartAlert('ğŸ“ˆ Spending Alert','Your spending this month is 20% higher than last month. Review your expenses!','warning');
  }
  
  const categoryTotals={};
  monthExpenses.forEach(e=>{categoryTotals[e.cat]=(categoryTotals[e.cat]||0)+e.amt});
  Object.entries(categoryTotals).forEach(([cat,amt])=>{
    if(amt>monthTotal*0.4){
      showSmartAlert(`ğŸ¯ ${cat} Alert`,`${cat} is ${((amt/monthTotal)*100).toFixed(0)}% of your spending this month!`,'info');
    }
  });
  
  const weekExpenses=currentExpenses.filter(e=>{
    const d=new Date(e.date+'T00:00:00');
    const weekAgo=new Date();weekAgo.setDate(weekAgo.getDate()-7);
    return d>=weekAgo;
  });
  if(weekExpenses.length===0){
    showSmartAlert('ğŸ“ Reminder','No expenses logged this week. Keep tracking for better insights!','info');
  }
  
  localStorage.setItem('lastAlertCheck',today);
}

function showSmartAlert(title,message,type='info'){
  const alertDiv=document.createElement('div');
  alertDiv.style.cssText=`position:fixed;top:80px;right:20px;z-index:500;background:${type==='warning'?'#fef3c7':'#dbeafe'};border:2px solid ${type==='warning'?'#f59e0b':'#3b82f6'};border-radius:12px;padding:1rem 1.5rem;max-width:350px;box-shadow:0 10px 40px rgba(0,0,0,.2);animation:slideIn .4s ease`;
  alertDiv.innerHTML=`<div style="display:flex;align-items:start;gap:.8rem">
    <span style="font-size:1.5rem">${type==='warning'?'âš ï¸':'ğŸ’¡'}</span>
    <div style="flex:1">
      <div style="font-weight:700;color:#1e293b;margin-bottom:.3rem">${title}</div>
      <div style="font-size:.85rem;color:#475569">${message}</div>
    </div>
    <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:#94a3b8;cursor:pointer;font-size:1.2rem">Ã—</button>
  </div>`;
  document.body.appendChild(alertDiv);
  setTimeout(()=>alertDiv.remove(),8000);
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACHIEVEMENT SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ACHIEVEMENTS=[
  {id:'first',icon:'ğŸ‰',label:'First Expense',check:()=>currentExpenses.length>=1},
  {id:'week',icon:'ğŸ“…',label:'7 Day Streak',check:()=>parseInt(localStorage.getItem('expenseStreak')||'0')>=7},
  {id:'hundred',icon:'ğŸ’¯',label:'100 Expenses',check:()=>currentExpenses.length>=100},
  {id:'saver',icon:'ğŸ’°',label:'Budget Master',check:()=>Object.keys(JSON.parse(localStorage.getItem('budgets')||'{}')).length>=3},
  {id:'goal',icon:'ğŸ¯',label:'Goal Setter',check:()=>JSON.parse(localStorage.getItem('financialGoals')||'[]').length>=1},
  {id:'organized',icon:'ğŸ“Š',label:'All Categories',check:()=>{
    const cats=new Set(currentExpenses.map(e=>e.cat));
    return cats.size>=5;
  }}
];

function renderAchievements(){
  const container=document.getElementById('achievementsBanner');
  if(!container)return;
  
  const unlocked=ACHIEVEMENTS.filter(a=>a.check());
  if(unlocked.length===0)return;
  
  container.innerHTML=`<div class="achievements-container">
    <span style="font-weight:700;color:var(--gold);white-space:nowrap">ğŸ† Achievements:</span>
    ${ACHIEVEMENTS.map(a=>{
      const isUnlocked=a.check();
      return`<div class="achievement-badge ${isUnlocked?'':'achievement-locked'}" title="${a.label}">
        <div class="achievement-icon">${a.icon}</div>
        <div class="achievement-label">${a.label}</div>
      </div>`;
    }).join('')}
  </div>`;
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FINANCIAL GOALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let goals=JSON.parse(localStorage.getItem('financialGoals')||'[]');

function renderGoals(){
  const container=document.getElementById('goalsContainer');
  if(!container)return;
  
  if(goals.length===0){
    container.innerHTML=`<div class="no-goals">
      <div class="no-goals-icon">ğŸ¯</div>
      <div class="no-goals-text">No financial goals yet. Set a goal to start saving!</div>
      <button class="btn btn-navy btn-sm" onclick="openGoalModal()">Create Your First Goal</button>
    </div>`;
    return;
  }
  
  container.innerHTML=goals.map((goal,idx)=>{
    const percentage=Math.min((goal.saved/goal.target)*100,100);
    const remaining=goal.target-goal.saved;
    const daysLeft=goal.deadline?Math.ceil((new Date(goal.deadline)-new Date())/(1000*60*60*24)):'';
    
    return`<div class="goal-card">
      <div class="goal-header">
        <div>
          <div class="goal-title">${goal.name}</div>
          <div class="goal-amount">Target: KSH ${goal.target.toLocaleString()}</div>
          ${goal.deadline?`<div style="font-size:.7rem;color:var(--text3);margin-top:.3rem">ğŸ—“ ${daysLeft} days left</div>`:''}
        </div>
      </div>
      <div class="goal-progress-container">
        <div class="goal-progress-bg">
          <div class="goal-progress-fill" style="width:${percentage}%"></div>
        </div>
      </div>
      <div class="goal-stats">
        <span class="goal-saved">Saved: KSH ${goal.saved.toLocaleString()} (${percentage.toFixed(1)}%)</span>
        <span class="goal-remaining">${remaining>0?`KSH ${remaining.toLocaleString()} to go`:'âœ… Goal Achieved!'}</span>
      </div>
      <div class="goal-actions">
        <button class="goal-action-btn" onclick="addToGoal(${idx})" title="Add Money">ğŸ’°</button>
        <button class="goal-action-btn" onclick="editGoal(${idx})" title="Edit">âœï¸</button>
        <button class="goal-action-btn" onclick="deleteGoal(${idx})" title="Delete">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('');
  
  goals.forEach((goal,idx)=>{
    if(goal.saved>=goal.target&&!goal.achieved){
      goals[idx].achieved=true;
      localStorage.setItem('financialGoals',JSON.stringify(goals));
      showAchievement(`ğŸ‰ Goal Achieved: ${goal.name}!`);
    }
  });
}

document.getElementById('addGoalBtn').addEventListener('click',()=>openGoalModal());

function openGoalModal(editIdx=null){
  const goal=editIdx!==null?goals[editIdx]:{name:'',target:0,saved:0,deadline:''};
  const html=`<div class="quick-add-form">
    <input type="text" id="goalName" placeholder="Goal Name (e.g. New Car)" value="${goal.name}" />
    <input type="number" id="goalTarget" placeholder="Target Amount (KSH)" value="${goal.target||''}" />
    <input type="number" id="goalSaved" placeholder="Already Saved (KSH)" value="${goal.saved||0}" />
    <input type="date" id="goalDeadline" value="${goal.deadline||''}" />
    <small style="color:var(--text3)">Optional: Set a deadline to track progress</small>
  </div>
  <div style="display:flex;gap:.5rem;margin-top:1rem">
    <button class="btn btn-navy" onclick="saveGoal(${editIdx})">ğŸ’¾ Save Goal</button>
    <button class="btn btn-ghost" onclick="document.getElementById('goalModal').classList.remove('show')">Cancel</button>
  </div>`;
  showCustomModal(editIdx!==null?'Edit Financial Goal':'Create Financial Goal',html);
  document.getElementById('goalModal').id='goalModal';
}

function saveGoal(editIdx){
  const name=document.getElementById('goalName').value.trim();
  const target=parseFloat(document.getElementById('goalTarget').value);
  const saved=parseFloat(document.getElementById('goalSaved').value)||0;
  const deadline=document.getElementById('goalDeadline').value;
  
  if(!name||!target||target<=0){toast('Fill required fields','err');return}
  if(saved>target){toast('Saved amount cannot exceed target','err');return}
  
  const goalData={name,target,saved,deadline,achieved:saved>=target};
  
  if(editIdx!==null){
    goals[editIdx]=goalData;
  }else{
    goals.push(goalData);
  }
  
  localStorage.setItem('financialGoals',JSON.stringify(goals));
  document.getElementById('goalModal').classList.remove('show');
  renderGoals();
  toast(editIdx!==null?'Goal updated!':'Goal created!','ok');
}

function addToGoal(idx){
  const goal=goals[idx];
  const amount=prompt(`Add money to "${goal.name}"?\n\nCurrent: KSH ${goal.saved.toLocaleString()}\nTarget: KSH ${goal.target.toLocaleString()}\n\nEnter amount to add:`);
  if(!amount)return;
  const amt=parseFloat(amount);
  if(isNaN(amt)||amt<=0){toast('Invalid amount','err');return}
  goals[idx].saved+=amt;
  localStorage.setItem('financialGoals',JSON.stringify(goals));
  renderGoals();
  toast(`Added KSH ${amt.toLocaleString()} to ${goal.name}!`,'ok');
}

function editGoal(idx){
  openGoalModal(idx);
}

function deleteGoal(idx){
  if(!confirm(`Delete goal "${goals[idx].name}"?`))return;
  goals.splice(idx,1);
  localStorage.setItem('financialGoals',JSON.stringify(goals));
  renderGoals();
  toast('Goal deleted','ok');
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECEIPT SCANNER (SIMULATED OCR)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.getElementById('receiptUpload').addEventListener('change',async(e)=>{
  const file=e.target.files[0];
  if(!file)return;
  
  toast('ğŸ“¸ Scanning receipt...','ok');
  
  setTimeout(()=>{
    const amounts=[150,250,350,450,550,750,1000,1250,1500];
    const descs=['Grocery Shopping','Restaurant Bill','Fuel','Medicine','Coffee','Taxi','Utilities','Shopping'];
    const amount=amounts[Math.floor(Math.random()*amounts.length)];
    const desc=descs[Math.floor(Math.random()*descs.length)];
    
    document.getElementById('expDesc').value=desc;
    document.getElementById('expAmt').value=amount;
    document.getElementById('expDate').value=new Date().toISOString().split('T')[0];
    
    toast('âœ… Receipt scanned! Review and save.','ok');
    e.target.value='';
  },1500);
});
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKUP & RESTORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.getElementById('backupBtn').addEventListener('click',()=>{
  const html=`<div style="text-align:center">
    <p style="margin-bottom:1rem;color:var(--text2)">Export or import all your data</p>
    <div style="display:flex;flex-direction:column;gap:.8rem">
      <button class="btn btn-navy" onclick="exportBackup()">ğŸ“¥ Download Backup</button>
      <button class="btn btn-ghost" onclick="document.getElementById('restoreInput').click()">ğŸ“¤ Restore from Backup</button>
      <input type="file" id="restoreInput" accept=".json" style="display:none" onchange="importBackup(event)" />
    </div>
    <p style="margin-top:1rem;font-size:.75rem;color:var(--text3)">Backup includes: expenses, budgets, goals, recurring expenses</p>
  </div>`;
  showCustomModal('ğŸ’¾ Backup & Restore',html);
});

function exportBackup(){
  const backup={
    version:'1.0',
    timestamp:new Date().toISOString(),
    expenses:currentExpenses,
    budgets:JSON.parse(localStorage.getItem('budgets')||'{}'),
    goals:JSON.parse(localStorage.getItem('financialGoals')||'[]'),
    recurring:JSON.parse(localStorage.getItem('recurring')||'[]')
  };
  
  const blob=new Blob([JSON.stringify(backup,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`FinanceFlow_Backup_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  toast('âœ… Backup downloaded!','ok');
}

function importBackup(e){
  const file=e.target.files[0];
  if(!file)return;
  
  const reader=new FileReader();
  reader.onload=async(event)=>{
    try{
      const backup=JSON.parse(event.target.result);
      
      if(confirm('âš ï¸ This will replace all current data. Continue?')){
        localStorage.setItem('budgets',JSON.stringify(backup.budgets||{}));
        localStorage.setItem('financialGoals',JSON.stringify(backup.goals||[]));
        localStorage.setItem('recurring',JSON.stringify(backup.recurring||[]));
        
        for(const exp of backup.expenses||[]){
          if(!exp.userId)exp.userId=currentUserId;
          await db.collection('expenses').add(exp);
        }
        
        toast('âœ… Backup restored! Refreshing...','ok');
        setTimeout(()=>location.reload(),2000);
      }
    }catch(err){
      toast('âŒ Invalid backup file','err');
    }
  };
  reader.readAsText(file);
  e.target.value='';
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT TO GOOGLE SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.getElementById('exportSheetsBtn').addEventListener('click',()=>{
  const csv=generateCSV();
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`FinanceFlow_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  
  toast('âœ… CSV downloaded! Upload to Google Sheets','ok');
  setTimeout(()=>{
    if(confirm('Open Google Sheets import guide?')){
      window.open('https://support.google.com/docs/answer/40608','_blank');
    }
  },1000);
});

function generateCSV(){
  const headers=['Date','Description','Category','Amount','Notes'];
  const rows=currentExpenses.map(e=>[
    e.date,
    `"${e.desc}"`,
    e.cat,
    e.amt,
    `"${e.notes||''}"`
  ]);
  
  const csv=[headers.join(','),...rows.map(r=>r.join(','))].join('\n');
  return csv;
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOICE INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.getElementById('voiceBtn').addEventListener('click',()=>{
  if(!('webkitSpeechRecognition' in window)&&!('SpeechRecognition' in window)){
    toast('Voice input not supported in this browser','err');
    return;
  }
  
  const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
  const recognition=new SpeechRecognition();
  
  recognition.lang='en-US';
  recognition.interimResults=false;
  
  document.getElementById('voiceBtn').textContent='ğŸ”´';
  toast('ğŸ¤ Listening... Speak now!','ok');
  
  recognition.onresult=(event)=>{
    const transcript=event.results[0][0].transcript;
    document.getElementById('quickDesc').value=transcript;
    
    const amountMatch=transcript.match(/(\d+(?:\.\d+)?)\s*(?:shillings?|ksh|bob)?/i);
    if(amountMatch){
      document.getElementById('quickAmt').value=amountMatch[1];
    }
    
    const categories=['food','transport','entertainment','utilities','healthcare','shopping','education','housing'];
    const foundCat=categories.find(cat=>transcript.toLowerCase().includes(cat));
    if(foundCat){
      document.getElementById('quickCat').value=foundCat.charAt(0).toUpperCase()+foundCat.slice(1);
    }
    
    toast('âœ… Voice captured!','ok');
    document.getElementById('voiceBtn').textContent='ğŸ¤';
  };
  
  recognition.onerror=()=>{
    toast('Voice input failed. Try again.','err');
    document.getElementById('voiceBtn').textContent='ğŸ¤';
  };
  
  recognition.start();
});
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADVANCED ANALYTICS DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let weeklyChart,topExpensesChart,quarterlyChart;

document.getElementById('toggleDashboard').addEventListener('click',()=>{
  const dashboard=document.getElementById('analyticsDashboard');
  const isVisible=dashboard.style.display!=='none';
  dashboard.style.display=isVisible?'none':'block';
  
  if(!isVisible){
    renderAdvancedDashboard();
  }
});

function renderAdvancedDashboard(){
  const last90Days=new Date();
  last90Days.setDate(last90Days.getDate()-90);
  const recentExpenses=currentExpenses.filter(e=>new Date(e.date+'T00:00:00')>=last90Days);
  
  if(weeklyChart)weeklyChart.destroy();
  const weeklyData={};
  const weeks=['Week 1','Week 2','Week 3','Week 4'];
  weeks.forEach(w=>weeklyData[w]=0);
  
  recentExpenses.forEach(e=>{
    const daysDiff=Math.floor((new Date()-new Date(e.date+'T00:00:00'))/(1000*60*60*24));
    const weekNum=Math.floor(daysDiff/7);
    if(weekNum<4){
      weeklyData[`Week ${4-weekNum}`]+=e.amt;
    }
  });
  
  const weeklyCtx=document.getElementById('weeklyChart').getContext('2d');
  weeklyChart=new Chart(weeklyCtx,{
    type:'line',
    data:{
      labels:weeks,
      datasets:[{
        label:'Spending',
        data:Object.values(weeklyData),
        borderColor:'#3b82f6',
        backgroundColor:'rgba(59,130,246,0.1)',
        borderWidth:3,
        fill:true,
        tension:0.4
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:true,
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{label:ctx=>`KSH ${ctx.parsed.y.toLocaleString()}`}}
      },
      scales:{
        y:{beginAtZero:true,ticks:{callback:v=>'KSH '+v.toLocaleString()}}
      }
    }
  });
  
  if(topExpensesChart)topExpensesChart.destroy();
  const topExpenses=recentExpenses.sort((a,b)=>b.amt-a.amt).slice(0,5);
  const topCtx=document.getElementById('topExpensesChart').getContext('2d');
  topExpensesChart=new Chart(topCtx,{
    type:'bar',
    data:{
      labels:topExpenses.map(e=>e.desc.substring(0,15)),
      datasets:[{
        label:'Amount',
        data:topExpenses.map(e=>e.amt),
        backgroundColor:['#ef4444','#f59e0b','#10b981','#3b82f6','#8b5cf6'],
        borderWidth:0
      }]
    },
    options:{
      indexAxis:'y',
      responsive:true,
      maintainAspectRatio:true,
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{label:ctx=>`KSH ${ctx.parsed.x.toLocaleString()}`}}
      },
      scales:{
        x:{ticks:{callback:v=>'KSH '+v.toLocaleString()}}
      }
    }
  });
  
  if(quarterlyChart)quarterlyChart.destroy();
  const categoryData={};
  recentExpenses.forEach(e=>{categoryData[e.cat]=(categoryData[e.cat]||0)+e.amt});
  
  const qtrCtx=document.getElementById('quarterlyChart').getContext('2d');
  quarterlyChart=new Chart(qtrCtx,{
    type:'bar',
    data:{
      labels:Object.keys(categoryData),
      datasets:[{
        label:'Last 90 Days',
        data:Object.values(categoryData),
        backgroundColor:Object.keys(categoryData).map(cat=>CAT_COLORS[cat]||'#6b7280'),
        borderWidth:1,
        borderColor:'#fff'
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:true,
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{label:ctx=>`KSH ${ctx.parsed.y.toLocaleString()}`}}
      },
      scales:{
        y:{beginAtZero:true,ticks:{callback:v=>'KSH '+v.toLocaleString()}}
      }
    }
  });
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CUSTOM CATEGORIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let customCategories=JSON.parse(localStorage.getItem('customCategories')||'[]');

document.getElementById('manageCategoriesBtn').addEventListener('click',()=>{
  const allCategories=[
    ...['Food','Transport','Entertainment','Utilities','Healthcare','Shopping','Education','Housing','Other'],
    ...customCategories.map(c=>c.name)
  ];
  
  const html=`<div style="max-height:400px;overflow-y:auto">
    <h4 style="margin-bottom:1rem;color:var(--navy)">Existing Categories:</h4>
    ${allCategories.map(cat=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem;border-bottom:1px solid var(--border)">
      <span>${cat}</span>
      ${customCategories.find(c=>c.name===cat)?`<button onclick="deleteCategory('${cat}')" style="background:none;border:none;color:var(--red);cursor:pointer">ğŸ—‘ï¸</button>`:''}
    </div>`).join('')}
    <h4 style="margin:1.5rem 0 1rem;color:var(--navy)">Add New Category:</h4>
    <div style="display:flex;gap:.5rem">
      <input type="text" id="newCategoryName" placeholder="Category name" style="flex:1;padding:.5rem;border:1px solid var(--border);border-radius:var(--radius-sm)" />
      <input type="text" id="newCategoryIcon" placeholder="Emoji" maxlength="2" style="width:60px;padding:.5rem;border:1px solid var(--border);border-radius:var(--radius-sm);text-align:center" />
      <button onclick="addCustomCategory()" class="btn btn-navy btn-sm">Add</button>
    </div>
  </div>
  <div style="margin-top:1rem;text-align:center">
    <button class="btn btn-ghost" onclick="document.getElementById('categoriesModal').classList.remove('show')">Close</button>
  </div>`;
  
  showCustomModal('ğŸ¨ Manage Categories',html);
  document.getElementById('categoriesModal').id='categoriesModal';
});

function addCustomCategory(){
  const name=document.getElementById('newCategoryName').value.trim();
  const icon=document.getElementById('newCategoryIcon').value.trim();
  
  if(!name){toast('Enter category name','err');return}
  
  customCategories.push({name,icon:icon||'ğŸ“Œ'});
  localStorage.setItem('customCategories',JSON.stringify(customCategories));
  
  updateCategorySelects();
  document.getElementById('manageCategoriesBtn').click();
  toast('Category added!','ok');
}

function deleteCategory(name){
  customCategories=customCategories.filter(c=>c.name!==name);
  localStorage.setItem('customCategories',JSON.stringify(customCategories));
  document.getElementById('manageCategoriesBtn').click();
  toast('Category deleted','ok');
}

function updateCategorySelects(){
  const selects=document.querySelectorAll('#expCat,#quickCat');
  selects.forEach(select=>{
    const currentValue=select.value;
    select.innerHTML=`
      <option value="Food">ğŸ½ Food</option>
      <option value="Transport">ğŸš— Transport</option>
      <option value="Entertainment">ğŸ¬ Entertainment</option>
      <option value="Utilities">ğŸ’¡ Utilities</option>
      <option value="Healthcare">ğŸ¥ Healthcare</option>
      <option value="Shopping">ğŸ› Shopping</option>
      <option value="Education">ğŸ“š Education</option>
      <option value="Housing">ğŸ  Housing</option>
      <option value="Other">ğŸ“Œ Other</option>
      ${customCategories.map(c=>`<option value="${c.name}">${c.icon} ${c.name}</option>`).join('')}
    `;
    select.value=currentValue;
  });
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MULTI-CURRENCY SUPPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentCurrency=localStorage.getItem('currency')||'KSH';
const currencyRates={KSH:1,USD:0.0077,EUR:0.0071,GBP:0.0061};
const currencySymbols={KSH:'KSH',USD:'$',EUR:'â‚¬',GBP:'Â£'};

document.getElementById('currencySelector').value=currentCurrency;

document.getElementById('currencySelector').addEventListener('change',e=>{
  currentCurrency=e.target.value;
  localStorage.setItem('currency',currentCurrency);
  renderTable();
  renderStats();
  toast(`Currency changed to ${currentCurrency}`,'ok');
});

function formatCurrency(amount){
  const converted=amount*currencyRates[currentCurrency];
  const symbol=currencySymbols[currentCurrency];
  return currentCurrency==='KSH'?`${symbol} ${converted.toLocaleString('en',{minimumFractionDigits:2})}`:`${symbol}${converted.toLocaleString('en',{minimumFractionDigits:2})}`;
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DESKTOP NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function requestNotificationPermission(){
  if('Notification' in window&&Notification.permission==='default'){
    Notification.requestPermission();
  }
}

function sendNotification(title,body,icon='ğŸ’°'){
  if('Notification' in window&&Notification.permission==='granted'){
    new Notification(title,{body,icon:'/favicon.ico',badge:icon});
  }
}

setTimeout(requestNotificationPermission,3000);

function checkDailyReminder(){
  const lastReminder=localStorage.getItem('lastReminder')||'';
  const today=new Date().toISOString().split('T')[0];
  
  if(lastReminder!==today){
    const todayExpenses=currentExpenses.filter(e=>e.date===today);
    if(todayExpenses.length===0&&new Date().getHours()>=18){
      sendNotification('ğŸ“ Daily Reminder','Don\'t forget to log your expenses today!');
      localStorage.setItem('lastReminder',today);
    }
  }
}

setInterval(checkDailyReminder,3600000);
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PWA INSTALL PROMPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let deferredPrompt;

window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  deferredPrompt=e;
  
  const installBtn=document.createElement('button');
  installBtn.className='btn btn-gold btn-sm';
  installBtn.innerHTML='ğŸ“± Install App';
  installBtn.style.cssText='position:fixed;bottom:20px;left:20px;z-index:200;box-shadow:0 4px 12px rgba(0,0,0,.2)';
  installBtn.onclick=async()=>{
    if(deferredPrompt){
      deferredPrompt.prompt();
      const{outcome}=await deferredPrompt.userChoice;
      if(outcome==='accepted'){
        toast('âœ… App installed!','ok');
        installBtn.remove();
      }
      deferredPrompt=null;
    }
  };
  document.body.appendChild(installBtn);
  
  setTimeout(()=>installBtn.remove(),10000);
});
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARE TO WHATSAPP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.getElementById('whatsappInsightsBtn').addEventListener('click',()=>{
  if(!currentInsightsText){toast('Generate insights first','err');return}
  
  const summary=currentInsightsText.split('\n').slice(0,15).join('\n');
  const message=`*FinanceFlow AI Insights*\n\n${summary}\n\n_Full report available in app_`;
  const url=`https://wa.me/?text=${encodeURIComponent(message)}`;
  
  window.open(url,'_blank');
  toast('âœ… Opening WhatsApp...','ok');
});
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD SHORTCUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const shortcuts=document.createElement('div');
shortcuts.className='shortcuts-hint';
shortcuts.innerHTML=`âŒ¨ï¸ Shortcuts: <br>
<kbd>Ctrl+N</kbd> Quick Add | 
<kbd>Ctrl+F</kbd> Search | 
<kbd>Ctrl+E</kbd> Export | 
<kbd>?</kbd> Help`;
document.body.appendChild(shortcuts);

document.addEventListener('keydown',e=>{
  if(e.ctrlKey&&e.key==='n'){
    e.preventDefault();
    document.getElementById('quickAddFab').click();
  }
  if(e.ctrlKey&&e.key==='f'){
    e.preventDefault();
    document.getElementById('searchInput').focus();
  }
  if(e.ctrlKey&&e.key==='e'){
    e.preventDefault();
    document.getElementById('exportBtn').click();
  }
  if(e.ctrlKey&&e.key==='i'){
    e.preventDefault();
    document.getElementById('aiInsightsBtn').click();
  }
  if(e.key==='?'){
    shortcuts.classList.toggle('show');
    setTimeout(()=>shortcuts.classList.remove('show'),5000);
  }
  if(e.key==='Escape'){
    document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.remove('show'));
  }
});
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI CHAT ASSISTANT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.getElementById('aiChatBtn').addEventListener('click',()=>{
  document.getElementById('aiChatModal').classList.add('show');
  addChatMessage('bot','Hi! I can answer questions about your spending. Try asking: "What did I spend most on?" or "How much did I spend this week?"');
});

document.getElementById('chatSendBtn').addEventListener('click',()=>sendChatMessage());
document.getElementById('chatInput').addEventListener('keypress',e=>{
  if(e.key==='Enter')sendChatMessage();
});

function addChatMessage(sender,text){
  const messages=document.getElementById('chatMessages');
  const div=document.createElement('div');
  div.style.cssText=`margin-bottom:.8rem;padding:.7rem 1rem;border-radius:var(--radius-sm);${sender==='bot'?'background:var(--navy-light);margin-right:3rem':'background:var(--gold-light);margin-left:3rem;text-align:right'}`;
  div.innerHTML=`<div style="font-size:.7rem;color:var(--text3);margin-bottom:.2rem">${sender==='bot'?'ğŸ¤– AI':'You'}</div><div style="font-size:.85rem;color:var(--text)">${text}</div>`;
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;
}

function sendChatMessage(){
  const input=document.getElementById('chatInput');
  const question=input.value.trim().toLowerCase();
  if(!question)return;
  
  addChatMessage('user',input.value);
  input.value='';
  
  setTimeout(()=>{
    let answer='';
    
    if(question.includes('most')||question.includes('top')){
      const categoryTotals={};
      currentExpenses.forEach(e=>categoryTotals[e.cat]=(categoryTotals[e.cat]||0)+e.amt);
      const top=Object.entries(categoryTotals).sort((a,b)=>b[1]-a[1])[0];
      answer=`You spent the most on ${top[0]}: ${formatCurrency(top[1])}`;
    }
    else if(question.includes('week')||question.includes('7 day')){
      const weekAgo=new Date();weekAgo.setDate(weekAgo.getDate()-7);
      const weekExpenses=currentExpenses.filter(e=>new Date(e.date+'T00:00:00')>=weekAgo);
      const total=weekExpenses.reduce((s,e)=>s+e.amt,0);
      answer=`This week you spent ${formatCurrency(total)} across ${weekExpenses.length} transactions.`;
    }
    else if(question.includes('month')||question.includes('30 day')){
      const monthAgo=new Date();monthAgo.setMonth(monthAgo.getMonth()-1);
      const monthExpenses=currentExpenses.filter(e=>new Date(e.date+'T00:00:00')>=monthAgo);
      const total=monthExpenses.reduce((s,e)=>s+e.amt,0);
      answer=`This month you spent ${formatCurrency(total)} across ${monthExpenses.length} transactions.`;
    }
    else if(question.includes('today')){
      const today=new Date().toISOString().split('T')[0];
      const todayExpenses=currentExpenses.filter(e=>e.date===today);
      const total=todayExpenses.reduce((s,e)=>s+e.amt,0);
      answer=todayExpenses.length>0?`Today you spent ${formatCurrency(total)} on ${todayExpenses.length} items.`:'No expenses logged today yet.';
    }
    else if(question.includes('average')||question.includes('avg')){
      const total=currentExpenses.reduce((s,e)=>s+e.amt,0);
      const avg=total/currentExpenses.length;
      answer=`Your average expense is ${formatCurrency(avg)} per transaction.`;
    }
    else if(question.includes('total')||question.includes('all time')){
      const total=currentExpenses.reduce((s,e)=>s+e.amt,0);
      answer=`All time total: ${formatCurrency(total)} across ${currentExpenses.length} transactions.`;
    }
    else{
      answer='I can help you analyze your spending! Try asking: "What did I spend this week?" or "What\'s my top category?"';
    }
    
    addChatMessage('bot',answer);
  },800);
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPENSE SPLITTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.getElementById('quickSplitBtn').addEventListener('click',()=>{
  document.getElementById('quickAddModal').classList.remove('show');
  const html=`<div class="quick-add-form">
    <input type="text" id="splitDesc" placeholder="What are you splitting?" />
    <input type="number" id="splitTotal" placeholder="Total Amount (KSH)" step="0.01" />
    <input type="number" id="splitPeople" placeholder="Number of People" min="2" value="2" />
    <div style="background:var(--surface2);padding:.8rem;border-radius:var(--radius-sm);margin-top:.5rem">
      <div style="font-size:.8rem;font-weight:600;color:var(--navy);margin-bottom:.3rem">Split Result:</div>
      <div id="splitResult" style="font-size:1.2rem;font-weight:700;color:var(--gold)">â€”</div>
    </div>
  </div>
  <div style="display:flex;gap:.5rem;margin-top:1rem">
    <button class="btn btn-navy" onclick="saveSplitExpense()">ğŸ’¾ Save My Share</button>
    <button class="btn btn-ghost" onclick="document.getElementById('splitModal').classList.remove('show')">Cancel</button>
  </div>`;
  showCustomModal('ğŸ‘¥ Split Bill',html);
  document.getElementById('splitModal').id='splitModal';
  
  const calc=()=>{
    const total=parseFloat(document.getElementById('splitTotal').value)||0;
    const people=parseInt(document.getElementById('splitPeople').value)||2;
    const share=total/people;
    document.getElementById('splitResult').textContent=share>0?`Your share: KSH ${share.toFixed(2)}`:'â€”';
  };
  document.getElementById('splitTotal').addEventListener('input',calc);
  document.getElementById('splitPeople').addEventListener('input',calc);
});

async function saveSplitExpense(){
  const desc=document.getElementById('splitDesc').value.trim();
  const total=parseFloat(document.getElementById('splitTotal').value);
  const people=parseInt(document.getElementById('splitPeople').value);
  
  if(!desc||!total||total<=0||!people||people<2){
    toast('Fill all fields','err');
    return;
  }
  
  const myShare=total/people;
  
  try{
    await db.collection('expenses').add({
      userId:currentUserId,
      desc:`${desc} (Split ${people} ways)`,
      amt:myShare,
      cat:'Other',
      date:new Date().toISOString().split('T')[0],
      notes:`Total: KSH ${total} / ${people} people = KSH ${myShare.toFixed(2)} each`,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    
    document.getElementById('splitModal').classList.remove('show');
    toast(`âœ… Split expense saved! Your share: KSH ${myShare.toFixed(2)}`,'ok');
  }catch(err){
    toast('Error saving','err');
  }
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUDGET MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let budgets=JSON.parse(localStorage.getItem('budgets')||'{}');

function renderBudgets(){
  const container=document.getElementById('budgetCards');
  if(!container)return;
  const thisMonth=new Date();thisMonth.setDate(1);
  const monthlyExpenses=currentExpenses.filter(e=>new Date(e.date+'T00:00:00')>=thisMonth);
  const categorySpending={};
  monthlyExpenses.forEach(e=>{categorySpending[e.cat]=(categorySpending[e.cat]||0)+e.amt});
  const categories=['Food','Transport','Entertainment','Utilities','Healthcare','Shopping','Education','Housing'];
  if(Object.keys(budgets).length===0){
    container.innerHTML=`<div class="budget-card" style="text-align:center;padding:2rem"><p style="color:var(--text3);margin-bottom:1rem">No budgets set yet. Set monthly limits to track your spending!</p><button class="set-budget-btn" onclick="openBudgetModal()">+ Set Your First Budget</button></div>`;
    return;
  }
  container.innerHTML=categories.filter(cat=>budgets[cat]).map(cat=>{
    const budget=budgets[cat];const spent=categorySpending[cat]||0;const remaining=budget-spent;
    const percentage=Math.min((spent/budget)*100,100);
    let status='safe';
    if(percentage>=90)status='danger';else if(percentage>=70)status='warning';
    if(percentage>=90&&percentage<100)toast(`âš ï¸ ${cat}: 90% of budget used!`,'err');
    else if(percentage>=100)toast(`ğŸš¨ ${cat}: Budget exceeded!`,'err');
    return`<div class="budget-card"><div class="budget-header"><span class="budget-category">${cat}</span><span class="budget-amount">Budget: KSH ${budget.toLocaleString()}</span></div><div class="budget-progress-bg"><div class="budget-progress-bar ${status}" style="width:${percentage}%"></div></div><div class="budget-status"><span class="budget-spent">Spent: KSH ${spent.toLocaleString()} (${percentage.toFixed(0)}%)</span><span class="budget-remaining ${remaining<0?'over':''}">${remaining>=0?`Remaining: KSH ${remaining.toLocaleString()}`:`Over by KSH ${Math.abs(remaining).toLocaleString()}!`}</span></div></div>`}).join('');
}

document.getElementById('manageBudgetsBtn').addEventListener('click',()=>{
  const categories=['Food','Transport','Entertainment','Utilities','Healthcare','Shopping','Education','Housing'];
  const html=`<div style="max-height:400px;overflow-y:auto">${categories.map(cat=>`<div style="display:flex;gap:.5rem;align-items:center;margin-bottom:.8rem"><label style="flex:1;font-size:.8rem;font-weight:600">${cat}</label><input type="number" id="budget-${cat}" value="${budgets[cat]||''}" placeholder="0" style="width:150px;padding:.5rem;border:1px solid var(--border);border-radius:var(--radius-sm)"/></div>`).join('')}</div><div style="display:flex;gap:.5rem;margin-top:1rem"><button class="btn btn-navy" onclick="saveBudgets()">Save Budgets</button><button class="btn btn-ghost" onclick="document.getElementById('budgetModal').classList.remove('show')">Cancel</button></div>`;
  showCustomModal('Set Monthly Budgets',html);
});

function showCustomModal(title,content){
  let modal=document.getElementById('budgetModal');
  if(!modal){modal=document.createElement('div');modal.id='budgetModal';modal.className='modal-overlay';modal.innerHTML=`<div class="modal"><button class="modal-close" onclick="this.parentElement.parentElement.classList.remove('show')">âœ•</button><h3 id="budgetModalTitle"></h3><div id="budgetModalContent"></div></div>`;document.body.appendChild(modal)}
  document.getElementById('budgetModalTitle').textContent=title;
  document.getElementById('budgetModalContent').innerHTML=content;
  modal.classList.add('show');
}

function saveBudgets(){
  const categories=['Food','Transport','Entertainment','Utilities','Healthcare','Shopping','Education','Housing'];
  categories.forEach(cat=>{const value=parseFloat(document.getElementById(`budget-${cat}`).value);if(value>0)budgets[cat]=value;else delete budgets[cat]});
  localStorage.setItem('budgets',JSON.stringify(budgets));
  document.getElementById('budgetModal').classList.remove('show');
  renderBudgets();toast('Budgets updated!','ok');
}

function openBudgetModal(){document.getElementById('manageBudgetsBtn').click()}

// Quick Add
document.getElementById('quickAddFab').addEventListener('click',()=>{document.getElementById('quickAddModal').classList.add('show');document.getElementById('quickDesc').focus()});

document.getElementById('quickAddSave').addEventListener('click',async()=>{
  const desc=document.getElementById('quickDesc').value.trim();
  const amt=parseFloat(document.getElementById('quickAmt').value);
  const cat=document.getElementById('quickCat').value;
  if(!desc)return toast('Enter description','err');
  if(!amt||amt<=0)return toast('Enter amount','err');
  try{
    await db.collection('expenses').add({userId:currentUserId,desc,amt,cat,date:new Date().toISOString().split('T')[0],createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    document.getElementById('quickAddModal').classList.remove('show');
    document.getElementById('quickDesc').value='';
    document.getElementById('quickAmt').value='';
    toast('Expense added!','ok');
  }catch(err){toast('Error','err')}
});

// Streak
function checkStreak(){
  const today=new Date().toISOString().split('T')[0];
  const todayExpenses=currentExpenses.filter(e=>e.date===today);
  let streak=parseInt(localStorage.getItem('expenseStreak')||'0');
  const lastLogged=localStorage.getItem('lastExpenseDate');
  if(todayExpenses.length>0&&lastLogged!==today){
    streak++;localStorage.setItem('expenseStreak',streak);localStorage.setItem('lastExpenseDate',today);
    if(streak===7||streak===30||streak===100)showAchievement(streak);
  }
  const badge=document.getElementById('streakBadge');
  if(streak>=3)badge.innerHTML=`<div class="streak-badge">ğŸ”¥ <div><span class="streak-number">${streak}</span> Day Streak!</div></div>`;
}

function showAchievement(days){
  const popup=document.getElementById('achievementPopup');
  let message='';
  if(days===7)message='ğŸ‰ 7-Day Streak!';
  else if(days===30)message='ğŸ† 30-Day Master!';
  else if(days===100)message='ğŸ’ 100-Day Legend!';
  popup.innerHTML=`<h2>${message}</h2><p>You're building great financial habits!</p>`;
  popup.classList.add('show');
  setTimeout(()=>popup.classList.remove('show'),3000);
}
setInterval(checkStreak,5000);

// Dark Mode
document.getElementById('themeToggle').addEventListener('click',()=>{
  document.body.classList.toggle('dark-mode');
  const isDark=document.body.classList.contains('dark-mode');
  document.getElementById('themeToggle').textContent=isDark?'â˜€ï¸':'ğŸŒ™';
  localStorage.setItem('darkMode',isDark);
});
if(localStorage.getItem('darkMode')==='true'){document.body.classList.add('dark-mode');document.getElementById('themeToggle').textContent='â˜€ï¸'}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.getElementById('exportBtn').addEventListener('click',()=>document.getElementById('exportOverlay').classList.add('show'));
document.getElementById('exportClose').addEventListener('click',()=>document.getElementById('exportOverlay').classList.remove('show'));
document.getElementById('exportCancelBtn').addEventListener('click',()=>document.getElementById('exportOverlay').classList.remove('show'));

let selectedPeriod='month';
document.querySelectorAll('.period-pill').forEach(pill=>{pill.addEventListener('click',()=>{document.querySelectorAll('.period-pill').forEach(p=>p.classList.remove('active'));pill.classList.add('active');selectedPeriod=pill.dataset.period;document.getElementById('customRange').classList.toggle('show',selectedPeriod==='custom')})});

let selectedFormat='pdf';
document.querySelectorAll('.fmt-btn').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.fmt-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');selectedFormat=btn.dataset.fmt})});

document.getElementById('downloadBtn').addEventListener('click',async()=>{
  if(!currentExpenses.length)return toast('No expenses','err');
  
  let from,to;const now=new Date();to=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  if(selectedPeriod==='week'){from=new Date(to);from.setDate(from.getDate()-6)}
  else if(selectedPeriod==='month'){from=new Date(to);from.setMonth(from.getMonth()-1);from.setDate(from.getDate()+1)}
  else if(selectedPeriod==='year'){from=new Date(to);from.setFullYear(from.getFullYear()-1);from.setDate(from.getDate()+1)}
  else{from=new Date(document.getElementById('customFrom').value+'T00:00:00');to=new Date(document.getElementById('customTo').value+'T00:00:00');if(isNaN(from.getTime())||isNaN(to.getTime()))return toast('Pick dates','err');if(from>to)return toast('Invalid range','err')}
  
  const filtered=currentExpenses.filter(e=>{const d=new Date(e.date+'T00:00:00');return d>=from&&d<=to});
  if(!filtered.length)return toast('No expenses in period','err');
  
  const userDoc=await db.collection('users').doc(currentUserId).get();
  const user=userDoc.data();
  const wmText=document.getElementById('wmText').value.trim()||user.watermark;
  const wmColor=document.getElementById('wmColor').value;
  
  if(selectedFormat==='xlsx')exportExcel({first:user.first,last:user.last},filtered,from,to,wmText);
  else exportPDF({first:user.first,last:user.last},filtered,from,to,wmText,wmColor);
  
  document.getElementById('exportOverlay').classList.remove('show');
});

function fmtDate(d){return d.toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit',year:'numeric'}).replace(/\//g,'-')}
function fmtDateLong(d){return d.toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'})}
function hexToRgb(hex){hex=hex.replace(/^#/,'');if(hex.length===3)hex=hex.split('').map(c=>c+c).join('');return{r:parseInt(hex.substr(0,2),16),g:parseInt(hex.substr(2,2),16),b:parseInt(hex.substr(4,2),16)}}

// Helper to lighten a color for category badges
function lightenColor(r, g, b, percent) {
  const amt = percent / 100;
  return {
    r: Math.round(r + (255 - r) * amt),
    g: Math.round(g + (255 - g) * amt),
    b: Math.round(b + (255 - b) * amt)
  };
}

function exportExcel(user,data,from,to,wmText){
  const rows=data.sort((a,b)=>new Date(a.date)-new Date(b.date)).map(e=>({Date:new Date(e.date+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}),Description:e.desc,Category:e.cat,'Amount (KSH)':e.amt}));
  const total=data.reduce((s,e)=>s+e.amt,0);
  const sheet=[{Date:'REPORT:',Description:`${user.first} ${user.last}`,Category:'','Amount (KSH)':''},{Date:'Period:',Description:`${fmtDate(from)} â€“ ${fmtDate(to)}`,Category:'','Amount (KSH)':''},{Date:'Watermark:',Description:wmText,Category:'','Amount (KSH)':''},{Date:'Total:',Description:'',Category:'','Amount (KSH)':total},{Date:'',Description:'',Category:'','Amount (KSH)':''},...rows];
  const ws=XLSX.utils.json_to_sheet(sheet);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Expenses');
  XLSX.writeFile(wb,`${user.first}_${user.last}_${fmtDate(from)}_to_${fmtDate(to)}.xlsx`);toast('Excel downloaded!','ok');
}

// FIXED PDF EXPORT: Category badges now have proper light backgrounds, no black boxes
function exportPDF(user,data,from,to,wmText,wmColorHex){
  const{jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const PW=210,PH=297,ML=8,MR=8,MT=8,MB=8,CW=PW-ML-MR;
  
  const wc=hexToRgb(wmColorHex);
  const wmR=Math.round(wc.r*.08+255*.92),wmG=Math.round(wc.g*.08+255*.92),wmB=Math.round(wc.b*.08+255*.92);
  const sorted=[...data].sort((a,b)=>new Date(a.date)-new Date(b.date));
  
  function addPageBg(){
    doc.setFont('Helvetica','normal');doc.setFontSize(8);doc.setTextColor(wmR,wmG,wmB);
    const sp=24;
    for(let y=15;y<PH-10;y+=sp){
      for(let x=(Math.floor(y/sp)%2===0?-10:6);x<PW+15;x+=sp){
        doc.text(wmText,x,y,{angle:20});
      }
    }
    doc.setFillColor(194,133,58);doc.rect(0,0,PW,.8,'F');
  }
  
  addPageBg();
  let y=MT+2;
  
  // Header
  doc.setTextColor(30,58,95);doc.setFont('Helvetica','bold');doc.setFontSize(22);
  doc.text('FinanceFlow',ML,y+8);
  doc.setFontSize(8);doc.setFont('Helvetica','normal');doc.setTextColor(148,163,184);
  doc.text('EXPENSE REPORT',ML,y+14);
  doc.setFontSize(7.5);doc.setTextColor(71,85,105);
  doc.text(`${fmtDateLong(from)} â€“ ${fmtDateLong(to)}`,PW-MR,y+6,{align:'right'});
  doc.setFontSize(6.5);doc.setTextColor(148,163,184);
  doc.text(`Generated ${new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit',year:'numeric'})}`,PW-MR,y+11,{align:'right'});
  
  doc.setFillColor(239,246,255);
  const userName=`${user.first} ${user.last}`;
  const nameW=doc.getTextWidth(userName)+8;
  doc.roundedRect(PW-MR-nameW,y+13,nameW,6,1.5,1.5,'F');
  doc.setTextColor(30,58,95);doc.setFont('Helvetica','bold');doc.setFontSize(7);
  doc.text(userName,PW-MR-nameW+4,y+17.5);
  
  y+=23;
  doc.setDrawColor(226,232,240);doc.setLineWidth(.3);doc.line(ML,y,PW-MR,y);
  
  y+=5;
  const total=data.reduce((s,e)=>s+e.amt,0);
  const cats={};
  data.forEach(e=>{cats[e.cat]=(cats[e.cat]||0)+e.amt});
  const topCat=Object.entries(cats).sort((a,b)=>b[1]-a[1])[0];
  const cardW=(CW-4)/3;
  
  // Summary Cards
  let cx=ML;
  doc.setFillColor(254,243,199);doc.roundedRect(cx,y,cardW,18,2,2,'F');
  doc.setDrawColor(251,191,36);doc.setLineWidth(.4);doc.roundedRect(cx,y,cardW,18,2,2,'S');
  doc.setTextColor(146,64,14);doc.setFontSize(5.5);doc.setFont('Helvetica','bold');
  doc.text('TOTAL SPENT',cx+3,y+5);
  doc.setTextColor(194,133,58);doc.setFontSize(12);
  doc.text('KSH '+total.toLocaleString('en',{minimumFractionDigits:0}),cx+3,y+13);
  
  cx+=cardW+2;
  doc.setFillColor(219,234,254);doc.roundedRect(cx,y,cardW,18,2,2,'F');
  doc.setDrawColor(59,130,246);doc.setLineWidth(.4);doc.roundedRect(cx,y,cardW,18,2,2,'S');
  doc.setTextColor(30,58,138);doc.setFontSize(5.5);
  doc.text('TRANSACTIONS',cx+3,y+5);
  doc.setTextColor(37,99,235);doc.setFontSize(12);
  doc.text(String(data.length),cx+3,y+13);
  doc.setFontSize(6);doc.setTextColor(71,85,105);doc.setFont('Helvetica','normal');
  doc.text('entries',cx+3,y+16.5);
  
  cx+=cardW+2;
  doc.setFillColor(237,233,254);doc.roundedRect(cx,y,cardW,18,2,2,'F');
  doc.setDrawColor(139,92,246);doc.setLineWidth(.4);doc.roundedRect(cx,y,cardW,18,2,2,'S');
  doc.setTextColor(76,29,149);doc.setFontSize(5.5);doc.setFont('Helvetica','bold');
  doc.text('TOP CATEGORY',cx+3,y+5);
  doc.setTextColor(124,58,237);doc.setFontSize(9);
  doc.text(topCat?topCat[0]:'â€”',cx+3,y+12);
  if(topCat){
    doc.setFontSize(6);doc.setTextColor(71,85,105);doc.setFont('Helvetica','normal');
    doc.text('KSH '+topCat[1].toLocaleString('en',{minimumFractionDigits:0}),cx+3,y+16.5);
  }
  
  y+=24;
  doc.setFontSize(9);doc.setTextColor(30,58,95);doc.setFont('Helvetica','bold');
  doc.text('Expense Transactions',ML,y);
  y+=5;
  
  // Table Header
  doc.setFillColor(248,250,252);doc.rect(ML,y,CW,7,'F');
  doc.setDrawColor(226,232,240);doc.setLineWidth(.2);doc.line(ML,y+7,PW-MR,y+7);
  doc.setTextColor(71,85,105);doc.setFontSize(6);doc.setFont('Helvetica','bold');
  doc.text('#',ML+2,y+4.5);
  doc.text('DATE',ML+10,y+4.5);
  doc.text('DESCRIPTION',ML+35,y+4.5);
  doc.text('CATEGORY',ML+115,y+4.5);
  doc.text('AMOUNT',PW-MR-2,y+4.5,{align:'right'});
  y+=7;
  
  let rowIdx=0;
  sorted.forEach(exp=>{
    // Page break
    if(y>PH-MB-15){
      doc.addPage();addPageBg();
      let hy=MT+2;
      doc.setTextColor(30,58,95);doc.setFont('Helvetica','bold');doc.setFontSize(9);
      doc.text('FinanceFlow â€” Expense Report (continued)',ML,hy+5);
      doc.setDrawColor(226,232,240);doc.setLineWidth(.3);doc.line(ML,hy+8,PW-MR,hy+8);
      y=hy+13;
      doc.setFillColor(248,250,252);doc.rect(ML,y,CW,7,'F');
      doc.setDrawColor(226,232,240);doc.setLineWidth(.2);doc.line(ML,y+7,PW-MR,y+7);
      doc.setTextColor(71,85,105);doc.setFontSize(6);doc.setFont('Helvetica','bold');
      doc.text('#',ML+2,y+4.5);doc.text('DATE',ML+10,y+4.5);
      doc.text('DESCRIPTION',ML+35,y+4.5);doc.text('CATEGORY',ML+115,y+4.5);
      doc.text('AMOUNT',PW-MR-2,y+4.5,{align:'right'});
      y+=7;
    }
    
    rowIdx++;
    if(rowIdx%2===0){doc.setFillColor(249,250,251);doc.rect(ML,y,CW,6,'F')}
    
    const d=new Date(exp.date+'T00:00:00');
    const ds=d.toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit',year:'numeric'});
    
    doc.setTextColor(148,163,184);doc.setFontSize(6);doc.setFont('Helvetica','normal');
    doc.text(String(rowIdx),ML+2,y+4);
    doc.setTextColor(100,116,139);doc.setFontSize(6.2);
    doc.text(ds,ML+10,y+4);
    doc.setTextColor(30,58,95);doc.setFont('Helvetica','bold');doc.setFontSize(6.5);
    doc.text(exp.desc.substring(0,35),ML+35,y+4);
    
    // FIXED: Category badge with light background (85% lighter than original color)
    const catColor=hexToRgb(CAT_COLORS[exp.cat]||'#6b7280');
    const lightBg=lightenColor(catColor.r,catColor.g,catColor.b,85);
    doc.setFillColor(lightBg.r,lightBg.g,lightBg.b);
    const catText=exp.cat;
    const catW=doc.getTextWidth(catText)+4;
    doc.roundedRect(ML+115,y+1,catW,4,1,1,'F');
    doc.setTextColor(catColor.r,catColor.g,catColor.b);
    doc.setFont('Helvetica','bold');doc.setFontSize(5.5);
    doc.text(catText,ML+117,y+4);
    
    doc.setTextColor(194,133,58);doc.setFont('Helvetica','bold');doc.setFontSize(7);
    doc.text('KSH '+exp.amt.toLocaleString('en',{minimumFractionDigits:2}),PW-MR-2,y+4,{align:'right'});
    doc.setDrawColor(241,245,249);doc.setLineWidth(.15);doc.line(ML,y+6,PW-MR,y+6);
    y+=6;
  });
  
  // Category Analysis
  y+=6;
  if(y>PH-MB-45){doc.addPage();addPageBg();y=MT+10}
  doc.setFontSize(9);doc.setTextColor(30,58,95);doc.setFont('Helvetica','bold');
  doc.text('Category Analysis',ML,y);
  y+=6;
  
  Object.entries(cats).sort((a,b)=>b[1]-a[1]).forEach(([cat,amt])=>{
    if(y>PH-MB-10){doc.addPage();addPageBg();y=MT+10}
    const pct=((amt/total)*100).toFixed(1);
    const barW=(amt/total)*(CW*.6);
    const catColor=hexToRgb(CAT_COLORS[cat]||'#6b7280');
    doc.setFillColor(241,245,249);doc.roundedRect(ML,y,CW*.6,5,1.5,1.5,'F');
    doc.setFillColor(catColor.r,catColor.g,catColor.b);doc.roundedRect(ML,y,barW,5,1.5,1.5,'F');
    doc.setTextColor(30,58,95);doc.setFontSize(6.5);doc.setFont('Helvetica','bold');
    doc.text(cat,ML+CW*.62,y+3.5);
    doc.setTextColor(100,116,139);doc.setFont('Helvetica','normal');doc.setFontSize(6);
    doc.text(pct+'%',ML+CW*.62+25,y+3.5);
    doc.setTextColor(194,133,58);doc.setFont('Helvetica','bold');doc.setFontSize(6.5);
    doc.text('KSH '+amt.toLocaleString('en',{minimumFractionDigits:0}),PW-MR,y+3.5,{align:'right'});
    y+=7;
  });
  
  // Footer
  const pages=doc.internal.getNumberOfPages();
  for(let p=1;p<=pages;p++){
    doc.setPage(p);
    doc.setDrawColor(226,232,240);doc.setLineWidth(.2);doc.line(ML,PH-MB+2,PW-MR,PH-MB+2);
    doc.setTextColor(148,163,184);doc.setFontSize(5.5);doc.setFont('Helvetica','normal');
    doc.text(`Page ${p} of ${pages}`,ML,PH-MB+6);
    doc.text(`Â© ${user.first} ${user.last} â€” FinanceFlow`,PW-MR,PH-MB+6,{align:'right'});
  }
  
doc.save(`${user.first}_${user.last}_Report_${fmtDate(from)}_to_${fmtDate(to)}.pdf`);
  toast('PDF downloaded!','ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI INSIGHTS & VISUALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let categoryChart,trendChart;
let currentAIPeriod='month';
let currentInsightsText='';
let currentChartsData=null;

document.getElementById('aiInsightsBtn').addEventListener('click',()=>{
  document.getElementById('aiInsightsOverlay').classList.add('show');
  generateAIInsights(currentAIPeriod);
});

document.getElementById('aiInsightsClose').addEventListener('click',()=>{
  document.getElementById('aiInsightsOverlay').classList.remove('show');
});

document.getElementById('emailInputClose').addEventListener('click',()=>{
  document.getElementById('emailInputOverlay').classList.remove('show');
});

document.getElementById('cancelEmailBtn').addEventListener('click',()=>{
  document.getElementById('emailInputOverlay').classList.remove('show');
});

document.addEventListener('click',e=>{
  const btn=e.target.closest('[data-ai-period]');
  if(!btn)return;
  document.querySelectorAll('[data-ai-period]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  currentAIPeriod=btn.dataset.aiPeriod;
  generateAIInsights(currentAIPeriod);
});

document.getElementById('refreshInsightsBtn').addEventListener('click',()=>{
  generateAIInsights(currentAIPeriod);
});

function getExpensesByPeriod(period){
  const now=new Date();
  let cutoff;
  if(period==='week'){cutoff=new Date(now);cutoff.setDate(cutoff.getDate()-7)}
  else if(period==='month'){cutoff=new Date(now);cutoff.setMonth(cutoff.getMonth()-1)}
  else if(period==='year'){cutoff=new Date(now);cutoff.setFullYear(cutoff.getFullYear()-1)}
  else return currentExpenses;
  return currentExpenses.filter(e=>new Date(e.date+'T00:00:00')>=cutoff);
}

async function generateAIInsights(period){
  document.getElementById('aiInsightsLoading').style.display='block';
  document.getElementById('aiInsightsContent').style.display='none';
  
  const expenses=getExpensesByPeriod(period);
  
  if(expenses.length===0){
    document.getElementById('aiInsightsLoading').style.display='none';
    document.getElementById('aiInsightsContent').style.display='block';
    document.getElementById('aiInsightsText').textContent='No expenses found for this period. Start tracking your expenses to get AI insights!';
    return;
  }
  
  const categoryData={};
  expenses.forEach(e=>{categoryData[e.cat]=(categoryData[e.cat]||0)+e.amt});
  
  const trendData={};
  expenses.forEach(e=>{
    const date=new Date(e.date+'T00:00:00');
    const weekStart=new Date(date);
    weekStart.setDate(date.getDate()-date.getDay());
    const weekKey=weekStart.toISOString().split('T')[0];
    trendData[weekKey]=(trendData[weekKey]||0)+e.amt;
  });
  
  currentChartsData={categoryData,trendData};
  createCharts(categoryData,trendData);
  
  const total=expenses.reduce((s,e)=>s+e.amt,0);
  const avgPerTransaction=total/expenses.length;
  const topCategory=Object.entries(categoryData).sort((a,b)=>b[1]-a[1])[0];
  
  const analysis=generateBasicAnalysis(expenses,period,categoryData,total,avgPerTransaction,topCategory);
  currentInsightsText=analysis;
  document.getElementById('aiInsightsText').textContent=analysis;
  
  document.getElementById('aiInsightsLoading').style.display='none';
  document.getElementById('aiInsightsContent').style.display='block';
}

function createCharts(categoryData,trendData){
  if(categoryChart)categoryChart.destroy();
  if(trendChart)trendChart.destroy();
  
  const catCtx=document.getElementById('categoryChart').getContext('2d');
  categoryChart=new Chart(catCtx,{
    type:'doughnut',
    data:{
      labels:Object.keys(categoryData),
      datasets:[{
        data:Object.values(categoryData),
        backgroundColor:Object.keys(categoryData).map(cat=>CAT_COLORS[cat]||'#6b7280'),
        borderWidth:2,
        borderColor:'#fff'
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:true,
      plugins:{
        legend:{position:'bottom',labels:{font:{size:11},padding:8}},
        tooltip:{callbacks:{label:ctx=>{
          const label=ctx.label||'';
          const value=ctx.parsed||0;
          const total=ctx.dataset.data.reduce((a,b)=>a+b,0);
          const percentage=((value/total)*100).toFixed(1);
          return `${label}: KSH ${value.toLocaleString()} (${percentage}%)`;
        }}}
      }
    }
  });
  
  const trendCtx=document.getElementById('trendChart').getContext('2d');
  const sortedDates=Object.keys(trendData).sort();
  trendChart=new Chart(trendCtx,{
    type:'line',
    data:{
      labels:sortedDates.map(d=>new Date(d).toLocaleDateString('en-GB',{day:'numeric',month:'short'})),
      datasets:[{
        label:'Weekly Spending',
        data:sortedDates.map(d=>trendData[d]),
        borderColor:'#c2853a',
        backgroundColor:'rgba(194,133,58,0.1)',
        borderWidth:2,
        fill:true,
        tension:0.4
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:true,
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{label:ctx=>`KSH ${ctx.parsed.y.toLocaleString()}`}}
      },
      scales:{
        y:{beginAtZero:true,ticks:{callback:value=>'KSH '+value.toLocaleString()}}
      }
    }
  });
  
  const comparisonCtx=document.getElementById('comparisonChart').getContext('2d');
  const now=new Date();
  const thisMonthStart=new Date(now.getFullYear(),now.getMonth(),1);
  const lastMonthStart=new Date(now.getFullYear(),now.getMonth()-1,1);
  const lastMonthEnd=new Date(now.getFullYear(),now.getMonth(),0);
  const thisMonthExpenses=currentExpenses.filter(e=>new Date(e.date+'T00:00:00')>=thisMonthStart);
  const lastMonthExpenses=currentExpenses.filter(e=>{const d=new Date(e.date+'T00:00:00');return d>=lastMonthStart&&d<=lastMonthEnd});
  const thisMonthByCategory={};const lastMonthByCategory={};
  thisMonthExpenses.forEach(e=>thisMonthByCategory[e.cat]=(thisMonthByCategory[e.cat]||0)+e.amt);
  lastMonthExpenses.forEach(e=>lastMonthByCategory[e.cat]=(lastMonthByCategory[e.cat]||0)+e.amt);
  const allCategories=[...new Set([...Object.keys(thisMonthByCategory),...Object.keys(lastMonthByCategory)])];
  const comparisonChart=new Chart(comparisonCtx,{type:'bar',data:{labels:allCategories,datasets:[{label:'Last Month',data:allCategories.map(cat=>lastMonthByCategory[cat]||0),backgroundColor:'rgba(148,163,184,0.6)',borderColor:'rgba(148,163,184,1)',borderWidth:1},{label:'This Month',data:allCategories.map(cat=>thisMonthByCategory[cat]||0),backgroundColor:'rgba(194,133,58,0.6)',borderColor:'rgba(194,133,58,1)',borderWidth:1}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'top'},tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: KSH ${ctx.parsed.y.toLocaleString()}`}}},scales:{y:{beginAtZero:true,ticks:{callback:value=>'KSH '+value.toLocaleString()}}}}});
}

function generateBasicAnalysis(expenses,period,categoryData,total,avgPerTransaction,topCategory){
  const periodNames={week:'this week',month:'this month',year:'this year',all:'all time'};
  const periodName=periodNames[period]||period;
  const sortedCats=Object.entries(categoryData).sort((a,b)=>b[1]-a[1]);
  
  // Calculate financial health metrics
  const essentialCats=['Food','Housing','Utilities','Healthcare','Transport'];
  const discretionaryCats=['Entertainment','Shopping','Other'];
  const essentialSpend=sortedCats.filter(([cat])=>essentialCats.includes(cat)).reduce((s,[,amt])=>s+amt,0);
  const discretionarySpend=sortedCats.filter(([cat])=>discretionaryCats.includes(cat)).reduce((s,[,amt])=>s+amt,0);
  const essentialRatio=(essentialSpend/total)*100;
  const discretionaryRatio=(discretionarySpend/total)*100;
  
  // Detect spending patterns
  const dailyAvg=total/(period==='week'?7:period==='month'?30:period==='year'?365:expenses.length);
  const expensesByDay={};
  expenses.forEach(e=>{
    const day=new Date(e.date+'T00:00:00').toLocaleDateString('en-GB',{weekday:'long'});
    expensesByDay[day]=(expensesByDay[day]||0)+1;
  });
  const busiestDay=Object.entries(expensesByDay).sort((a,b)=>b[1]-a[1])[0];
  
  // Detect large transactions
  const largeTransactions=expenses.filter(e=>e.amt>avgPerTransaction*2).length;
  const largeTransactionRatio=(largeTransactions/expenses.length)*100;
  
  // Calculate monthly burn rate
  let monthlyBurnRate=0;
  if(period==='week')monthlyBurnRate=total*4.33;
  else if(period==='month')monthlyBurnRate=total;
  else if(period==='year')monthlyBurnRate=total/12;
  else monthlyBurnRate=(total/expenses.length)*30;
  
  // Financial health score (0-100)
  let healthScore=100;
  if(essentialRatio>70)healthScore-=20;
  if(discretionaryRatio>30)healthScore-=15;
  if(topCategory[1]/total>0.4)healthScore-=15;
  if(largeTransactionRatio>20)healthScore-=10;
  healthScore=Math.max(0,Math.min(100,healthScore));
  
  // Generate comprehensive analysis
  let analysis=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  analysis+=`ğŸ“Š FINANCIAL OVERVIEW - ${periodName.toUpperCase()}\n`;
  analysis+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  analysis+=`ğŸ’° Total Spending: KSH ${total.toLocaleString('en',{minimumFractionDigits:2})}\n`;
  analysis+=`ğŸ“ Transactions: ${expenses.length} entries\n`;
  analysis+=`ğŸ“ˆ Average/Transaction: KSH ${avgPerTransaction.toLocaleString('en',{minimumFractionDigits:2})}\n`;
  analysis+=`ğŸ“… Daily Average: KSH ${dailyAvg.toLocaleString('en',{minimumFractionDigits:2})}\n`;
  analysis+=`ğŸ”¥ Monthly Burn Rate: KSH ${monthlyBurnRate.toLocaleString('en',{minimumFractionDigits:0})}\n\n`;
  
  // Financial Health Score
  analysis+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  analysis+=`ğŸ¥ FINANCIAL HEALTH SCORE: ${healthScore}/100\n`;
  analysis+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  if(healthScore>=80)analysis+=`âœ… Excellent! You're managing your finances very well.\n\n`;
  else if(healthScore>=60)analysis+=`ğŸ‘ Good! Minor improvements could optimize your spending.\n\n`;
  else if(healthScore>=40)analysis+=`âš ï¸ Fair. Consider reviewing your spending habits.\n\n`;
  else analysis+=`ğŸš¨ Attention needed! Significant improvements recommended.\n\n`;
  
  // Spending Distribution
  analysis+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  analysis+=`ğŸ“Š SPENDING DISTRIBUTION ANALYSIS\n`;
  analysis+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  analysis+=`ğŸ  Essential Expenses: ${essentialRatio.toFixed(1)}% (KSH ${essentialSpend.toLocaleString()})\n`;
  analysis+=`   â”œâ”€ Recommended: 50-70%\n`;
  if(essentialRatio>70)analysis+=`   â””â”€ âš ï¸ Too high - look for savings in essentials\n\n`;
  else if(essentialRatio<50)analysis+=`   â””â”€ âœ… Excellent control on essential spending\n\n`;
  else analysis+=`   â””â”€ âœ… Well balanced\n\n`;
  
  analysis+=`ğŸ‰ Discretionary Spending: ${discretionaryRatio.toFixed(1)}% (KSH ${discretionarySpend.toLocaleString()})\n`;
  analysis+=`   â”œâ”€ Recommended: 20-30%\n`;
  if(discretionaryRatio>30)analysis+=`   â””â”€ âš ï¸ Consider reducing non-essential spending\n\n`;
  else if(discretionaryRatio<20)analysis+=`   â””â”€ âœ… Very disciplined - you can afford occasional treats!\n\n`;
  else analysis+=`   â””â”€ âœ… Balanced lifestyle spending\n\n`;
  
  // Category Deep Dive
  analysis+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  analysis+=`ğŸ“ˆ TOP SPENDING CATEGORIES\n`;
  analysis+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  sortedCats.slice(0,5).forEach(([cat,amt],idx)=>{
    const pct=((amt/total)*100).toFixed(1);
    const icon=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ï¸âƒ£','5ï¸âƒ£'][idx];
    analysis+=`${icon} ${cat}: KSH ${amt.toLocaleString()} (${pct}%)\n`;
    
    // Category-specific insights
    if(cat==='Food'&&amt/total>0.3)analysis+=`   â””â”€ ğŸ’¡ Food is ${pct}% of spending. Meal planning could save KSH ${(amt*0.15).toFixed(0)}/month\n`;
    if(cat==='Transport'&&amt/total>0.25)analysis+=`   â””â”€ ğŸ’¡ High transport costs. Consider carpooling or public transit\n`;
    if(cat==='Entertainment'&&amt/total>0.15)analysis+=`   â””â”€ ğŸ’¡ Entertainment is significant. Look for free/low-cost alternatives\n`;
    if(cat==='Shopping'&&amt/total>0.2)analysis+=`   â””â”€ ğŸ’¡ Shopping expenses high. Implement 24-hour rule before purchases\n`;
    if(cat==='Utilities'&&amt/total>0.15)analysis+=`   â””â”€ ğŸ’¡ Utilities seem high. Energy-saving measures could help\n`;
  });
  analysis+=`\n`;
  
  // Spending Patterns
  analysis+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  analysis+=`ğŸ” SPENDING PATTERN ANALYSIS\n`;
  analysis+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  if(busiestDay)analysis+=`ğŸ“… Busiest Spending Day: ${busiestDay[0]} (${busiestDay[1]} transactions)\n`;
  analysis+=`ğŸ’³ Large Transactions: ${largeTransactions} (${largeTransactionRatio.toFixed(1)}% of total)\n`;
  if(largeTransactionRatio>20)analysis+=`   â””â”€ âš ï¸ Many large purchases - plan big expenses in advance\n\n`;
  else analysis+=`   â””â”€ âœ… Good mix of small and large transactions\n\n`;
  
  // AI Recommendations
  analysis+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  analysis+=`ğŸ¤– AI-POWERED RECOMMENDATIONS\n`;
  analysis+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  let recNum=1;
  
  // Top category recommendation
  if(topCategory[1]/total>0.35){
    analysis+=`${recNum}. ğŸ¯ PRIORITY: Reduce ${topCategory[0]} spending\n`;
    analysis+=`   â”œâ”€ Current: KSH ${topCategory[1].toLocaleString()} (${((topCategory[1]/total)*100).toFixed(0)}%)\n`;
    analysis+=`   â”œâ”€ Target: Reduce by 15%\n`;
    analysis+=`   â”œâ”€ Savings: KSH ${(topCategory[1]*0.15).toFixed(0)}/month\n`;
    analysis+=`   â””â”€ Action: Track every ${topCategory[0]} expense for 2 weeks\n\n`;
    recNum++;
  }
  
  // Second category recommendation
  if(sortedCats[1]&&sortedCats[1][1]/total>0.2){
    analysis+=`${recNum}. ğŸ“‰ Optimize ${sortedCats[1][0]} expenses\n`;
    analysis+=`   â”œâ”€ Current: KSH ${sortedCats[1][1].toLocaleString()}\n`;
    analysis+=`   â”œâ”€ Potential Savings: KSH ${(sortedCats[1][1]*0.12).toFixed(0)}/month (12% reduction)\n`;
    analysis+=`   â””â”€ Action: Compare prices, find alternatives, negotiate better rates\n\n`;
    recNum++;
  }
  
  // Small purchase tracking
  const smallPurchases=expenses.filter(e=>e.amt<avgPerTransaction*0.5).length;
  if(smallPurchases>expenses.length*0.4){
    analysis+=`${recNum}. ğŸ”¬ Track small purchases carefully\n`;
    analysis+=`   â”œâ”€ ${smallPurchases} small transactions detected\n`;
    analysis+=`   â”œâ”€ These add up to significant amounts\n`;
    analysis+=`   â””â”€ Action: Review all purchases under KSH ${(avgPerTransaction*0.5).toFixed(0)}\n\n`;
    recNum++;
  }
  
  // Budget recommendation
  analysis+=`${recNum}. ğŸ’¼ Set category budgets\n`;
  analysis+=`   â”œâ”€ ${topCategory[0]}: KSH ${(topCategory[1]*0.9).toFixed(0)}/month\n`;
  if(sortedCats[1])analysis+=`   â”œâ”€ ${sortedCats[1][0]}: KSH ${(sortedCats[1][1]*0.95).toFixed(0)}/month\n`;
  if(sortedCats[2])analysis+=`   â”œâ”€ ${sortedCats[2][0]}: KSH ${(sortedCats[2][1]*0.95).toFixed(0)}/month\n`;
  analysis+=`   â””â”€ Action: Set alerts when approaching limits\n\n`;
  recNum++;
  
  // Emergency fund recommendation
  if(discretionarySpend>essentialSpend*0.3){
    analysis+=`${recNum}. ğŸ¦ Build emergency savings\n`;
    analysis+=`   â”œâ”€ Redirect KSH ${(discretionarySpend*0.2).toFixed(0)}/month from discretionary to savings\n`;
    analysis+=`   â”œâ”€ Annual savings potential: KSH ${(discretionarySpend*0.2*12).toFixed(0)}\n`;
    analysis+=`   â””â”€ Action: Set up automatic transfer to savings account\n\n`;
    recNum++;
  }
  
  // Future Predictions
  analysis+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  analysis+=`ğŸ”® SPENDING FORECAST\n`;
  analysis+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  const nextMonthProjection=monthlyBurnRate;
  const threeMonthProjection=monthlyBurnRate*3;
  const yearProjection=monthlyBurnRate*12;
  
  analysis+=`ğŸ“… Next Month Projection: KSH ${nextMonthProjection.toLocaleString('en',{minimumFractionDigits:0})}\n`;
  analysis+=`ğŸ“… 3-Month Projection: KSH ${threeMonthProjection.toLocaleString('en',{minimumFractionDigits:0})}\n`;
  analysis+=`ğŸ“… Annual Projection: KSH ${yearProjection.toLocaleString('en',{minimumFractionDigits:0})}\n\n`;
  
  // Savings Opportunities
  analysis+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  analysis+=`ğŸ’° SAVINGS OPPORTUNITIES\n`;
  analysis+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  const savingsPotential=[
    {action:`Reduce ${topCategory[0]} by 15%`,monthly:topCategory[1]*0.15,annual:topCategory[1]*0.15*12},
    {action:'Cut discretionary spending by 10%',monthly:discretionarySpend*0.1,annual:discretionarySpend*0.1*12},
    {action:'Eliminate unnecessary subscriptions',monthly:avgPerTransaction*2,annual:avgPerTransaction*2*12},
    {action:'Cook at home 2 extra days/week',monthly:categoryData.Food?categoryData.Food*0.1:0,annual:categoryData.Food?categoryData.Food*0.1*12:0}
  ].filter(s=>s.monthly>0).sort((a,b)=>b.monthly-a.monthly);
  
  savingsPotential.forEach((s,i)=>{
    analysis+=`${i+1}. ${s.action}\n`;
    analysis+=`   â”œâ”€ Monthly: KSH ${s.monthly.toFixed(0)}\n`;
    analysis+=`   â””â”€ Annual: KSH ${s.annual.toFixed(0)}\n\n`;
  });
  
  const totalMonthlySavings=savingsPotential.reduce((s,o)=>s+o.monthly,0);
  const totalAnnualSavings=savingsPotential.reduce((s,o)=>s+o.annual,0);
  
  analysis+=`ğŸ¯ TOTAL POTENTIAL SAVINGS:\n`;
  analysis+=`   â”œâ”€ Monthly: KSH ${totalMonthlySavings.toFixed(0)}\n`;
  analysis+=`   â””â”€ Annual: KSH ${totalAnnualSavings.toFixed(0)}\n\n`;
  
  // Final motivation
  analysis+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  analysis+=`âœ¨ FINAL THOUGHTS\n`;
  analysis+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  if(healthScore>=80){
    analysis+=`Excellent financial discipline! Keep tracking your expenses and\n`;
    analysis+=`look for small optimizations. You're on the path to financial freedom! ğŸš€\n`;
  }else if(healthScore>=60){
    analysis+=`You're doing well! Implementing 2-3 recommendations above could\n`;
    analysis+=`significantly improve your financial health. Small changes = Big results! ğŸ’ª\n`;
  }else{
    analysis+=`Don't worry - awareness is the first step! Start with one category,\n`;
    analysis+=`implement the top recommendation, and track your progress weekly. You got this! ğŸ¯\n`;
  }
  
  return analysis;
}

document.getElementById('downloadInsightsBtn').addEventListener('click',async()=>{
  if(!currentInsightsText||!currentChartsData){toast('Generate insights first','err');return}
  
  const userDoc=await db.collection('users').doc(currentUserId).get();
  const user=userDoc.data();
  const period=currentAIPeriod;
  const expenses=getExpensesByPeriod(period);
  const total=expenses.reduce((s,e)=>s+e.amt,0);
  
  const{jsPDF}=window.jspdf;
  const doc=new jsPDF({compress:true});
  const PW=210,PH=297,M=15,CW=PW-(M*2);
  let currentPage=1;
  
  function addPageTemplate(pageNum){
    doc.setFillColor(30,58,95);
    doc.rect(0,0,PW,30,'F');
    doc.setFillColor(194,133,58);
    doc.rect(0,30,PW,3,'F');
    
    doc.setTextColor(255,255,255);
    doc.setFont('helvetica','bold');
    doc.setFontSize(20);
    doc.text('AI EXPENSE INSIGHTS',M,15);
    
    doc.setFontSize(8);
    doc.setFont('helvetica','normal');
    doc.text(`${user.first} ${user.last}`,M,23);
    doc.text(`${period.toUpperCase()} Analysis`,M,27);
    
    doc.setFontSize(7);
    const dateStr=new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});
    doc.text(dateStr,PW-M,23,{align:'right'});
    doc.text(`Page ${pageNum}`,PW-M,27,{align:'right'});
    
    doc.setDrawColor(226,232,240);
    doc.setLineWidth(0.5);
    doc.line(M,PH-12,PW-M,PH-12);
    doc.setTextColor(148,163,184);
    doc.setFontSize(6);
    doc.text('FinanceFlow - AI-Powered Financial Analysis',M,PH-8);
    doc.text('Proudly Designed By Benjamin',PW-M,PH-8,{align:'right'});
  }
  
  addPageTemplate(currentPage);
  let y=40;
  
  doc.setFillColor(239,246,255);
  doc.roundedRect(M,y,CW,25,2,2,'F');
  doc.setDrawColor(30,58,95);
  doc.setLineWidth(1);
  doc.roundedRect(M,y,CW,25,2,2,'S');
  
  doc.setTextColor(30,58,95);
  doc.setFont('helvetica','bold');
  doc.setFontSize(14);
  doc.text('EXECUTIVE SUMMARY',M+3,y+8);
  
  doc.setFont('helvetica','normal');
  doc.setFontSize(9);
  doc.setTextColor(71,85,105);
  doc.text(`Total Expenses: KSH ${total.toLocaleString('en',{minimumFractionDigits:2})}`,M+3,y+15);
  doc.text(`Transactions: ${expenses.length}`,M+3,y+20);
  doc.text(`Period: ${period==='week'?'Last 7 Days':period==='month'?'Last 30 Days':period==='year'?'Last 365 Days':'All Time'}`,PW-M-3,y+15,{align:'right'});
  doc.text(`Avg/Transaction: KSH ${(total/expenses.length).toLocaleString('en',{minimumFractionDigits:2})}`,PW-M-3,y+20,{align:'right'});
  
  y+=32;
  
  doc.setFillColor(253,242,233);
  doc.roundedRect(M,y,CW,10,2,2,'F');
  doc.setTextColor(30,58,95);
  doc.setFont('helvetica','bold');
  doc.setFontSize(12);
  doc.text('ğŸ“Š VISUAL ANALYSIS',M+3,y+7);
  y+=15;
  
  try{
    const catCanvas=document.getElementById('categoryChart');
    if(catCanvas){
      const catImg=catCanvas.toDataURL('image/png',1.0);
      doc.addImage(catImg,'PNG',M,y,80,80);
    }
    
    const trendCanvas=document.getElementById('trendChart');
    if(trendCanvas){
      const trendImg=trendCanvas.toDataURL('image/png',1.0);
      doc.addImage(trendImg,'PNG',M+85,y,80,80);
    }
    y+=85;
    
    const compCanvas=document.getElementById('comparisonChart');
    if(compCanvas){
      if(y>PH-100){doc.addPage();currentPage++;addPageTemplate(currentPage);y=40}
      y+=5;
      doc.setFillColor(253,242,233);
      doc.roundedRect(M,y,CW,10,2,2,'F');
      doc.setTextColor(30,58,95);
      doc.setFont('helvetica','bold');
      doc.setFontSize(12);
      doc.text('ğŸ“ˆ MONTHLY COMPARISON',M+3,y+7);
      y+=15;
      const compImg=compCanvas.toDataURL('image/png',1.0);
      doc.addImage(compImg,'PNG',M,y,CW,55);
      y+=60;
    }
  }catch(err){
    console.error('Chart error:',err);
  }
  
  if(y>PH-40){doc.addPage();currentPage++;addPageTemplate(currentPage);y=40}
  
  y+=5;
  doc.setFillColor(254,243,199);
  doc.roundedRect(M,y,CW,10,2,2,'F');
  doc.setTextColor(30,58,95);
  doc.setFont('helvetica','bold');
  doc.setFontSize(12);
  doc.text('ğŸ¤– AI-POWERED INSIGHTS',M+3,y+7);
  y+=15;
  
  const lines=currentInsightsText.split('\n');
  doc.setFont('helvetica','normal');
  doc.setFontSize(8);
  
  lines.forEach(line=>{
    if(!line.trim())return;
    
    if(y>PH-20){
      doc.addPage();
      currentPage++;
      addPageTemplate(currentPage);
      y=40;
    }
    
    if(line.match(/^â”â”â”â”/)){
      y+=2;
      doc.setDrawColor(226,232,240);
      doc.setLineWidth(0.3);
      doc.line(M,y,PW-M,y);
      y+=3;
      return;
    }
    
    if(line.match(/^[ğŸ“ŠğŸ“ˆğŸ’¡ğŸ”®ğŸ’°ğŸ¥ğŸ¯ğŸš¨âš ï¸âœ…]/)){
      if(y>40){
        doc.setFillColor(249,250,251);
        doc.roundedRect(M,y-2,CW,8,1,1,'F');
      }
      doc.setFont('helvetica','bold');
      doc.setFontSize(9);
      doc.setTextColor(30,58,95);
      doc.text(line.substring(0,60),M+2,y+3);
      y+=9;
      return;
    }
    
    if(line.match(/^[ğŸ¥‡ğŸ¥ˆğŸ¥‰4ï¸âƒ£5ï¸âƒ£]/)){
      doc.setFont('helvetica','bold');
      doc.setFontSize(8);
      doc.setTextColor(194,133,58);
    }else if(line.match(/^[â€¢â”œâ””â”€]/)||line.trim().startsWith('â””â”€')||line.trim().startsWith('â”œâ”€')){
      doc.setFont('helvetica','normal');
      doc.setFontSize(7.5);
      doc.setTextColor(100,116,139);
    }else{
      doc.setFont('helvetica','normal');
      doc.setFontSize(8);
      doc.setTextColor(71,85,105);
    }
    
    const wrappedLines=doc.splitTextToSize(line,CW-4);
    wrappedLines.forEach(wLine=>{
      if(y>PH-20){
        doc.addPage();
        currentPage++;
        addPageTemplate(currentPage);
        y=40;
      }
      doc.text(wLine,M+2,y);
      y+=4;
    });
  });
  
  const fileName=`AI_Insights_${user.first}_${user.last}_${period.toUpperCase()}_${new Date().getTime()}.pdf`;
  doc.save(fileName);
  toast('âœ… Professional AI Report Downloaded!','ok');
});

document.getElementById('emailInsightsBtn').addEventListener('click',()=>{
  document.getElementById('emailInputOverlay').classList.add('show');
});

document.getElementById('sendEmailBtn').addEventListener('click',async()=>{
  const email=document.getElementById('insightsEmailInput').value.trim();
  if(!email||!email.includes('@')){
    toast('Enter valid email','err');
    return;
  }
  
  if(!currentInsightsText){
    toast('Generate insights first','err');
    return;
  }
  
  const userDoc=await db.collection('users').doc(currentUserId).get();
  const user=userDoc.data();
  
  const subject=`Your AI Expense Insights - ${currentAIPeriod.toUpperCase()}`;
  const body=`Hi ${user.first},\n\nHere are your AI-powered expense insights:\n\n${currentInsightsText}\n\n---\nGenerated by FinanceFlow Expense Tracker\n${new Date().toLocaleString()}`;
  
  const mailtoLink=`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href=mailtoLink;
  
  document.getElementById('emailInputOverlay').classList.remove('show');
  toast('Email client opened!','ok');
});
</script>
</script>
</body>
</html>

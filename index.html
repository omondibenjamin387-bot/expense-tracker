<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FinanceFlow ‚Äî Cloud Expense Management</title>
<title>FinanceFlow ‚Äî Cloud Expense Management</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%231e3a5f'/%3E%3Cstop offset='100%25' style='stop-color:%232d5a8e'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23g)'/%3E%3Ctext x='50' y='70' font-family='Arial,sans-serif' font-size='50' font-weight='bold' fill='%23c2853a' text-anchor='middle'%3EF%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%231e3a5f'/%3E%3Cstop offset='100%25' style='stop-color:%232d5a8e'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23g)'/%3E%3Ctext x='50' y='70' font-family='Arial,sans-serif' font-size='50' font-weight='bold' fill='%23c2853a' text-anchor='middle'%3EF%3C/text%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=DM+Sans:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#f4f6f9;--surface:#fff;--surface2:#f0f3f7;
  --text:#1e293b;--text2:#475569;--text3:#94a3b8;
  --border:#e2e8f0;--border2:#cbd5e1;
  --navy:#1e3a5f;--navy2:#2d5a8e;--navy-light:rgba(30,58,95,.07);
  --gold:#c2853a;--gold2:#d4975a;--gold-light:rgba(194,133,58,.12);--gold-glow:rgba(194,133,58,.25);
  --red:#dc2626;--red-light:rgba(220,38,38,.1);
  --green:#16a34a;--green-light:rgba(22,163,74,.1);
  --blue:#2563eb;--blue-light:rgba(37,99,235,.1);
  --purple:#7c3aed;
  --radius:12px;--radius-sm:8px;
  --font-display:'Cormorant Garamond',serif;--font-body:'DM Sans',sans-serif;--font-mono:'JetBrains Mono',monospace;
  --shadow:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);
  --shadow-md:0 4px 16px rgba(30,58,95,.08);--shadow-lg:0 8px 32px rgba(30,58,95,.12);
}
html{scroll-behavior:smooth}
body{font-family:var(--font-body);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;line-height:1.6}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
.z1{position:relative;z-index:1}
#authScreen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem;background:linear-gradient(135deg,#eef2ff 0%,#f4f6f9 40%,#fdf2e9 100%);position:relative}
#authScreen::before{content:'';position:fixed;inset:0;pointer-events:none;opacity:.4;background:radial-gradient(circle at 15% 25%,rgba(30,58,95,.06) 0%,transparent 50%),radial-gradient(circle at 85% 75%,rgba(194,133,58,.08) 0%,transparent 50%)}
.auth-logo{text-align:center;margin-bottom:2.2rem;position:relative;z-index:1}
.auth-logo h1{font-family:var(--font-display);font-size:3rem;font-weight:700;color:var(--navy);letter-spacing:-.5px;line-height:1.1}
.auth-logo h1 em{color:var(--gold);font-style:normal}
.auth-logo p{color:var(--text3);font-size:.85rem;margin-top:.45rem;letter-spacing:.6px;text-transform:uppercase}
.auth-card{width:100%;max-width:440px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-lg);position:relative;z-index:1;overflow:hidden}
.auth-tabs{display:flex;border-bottom:1px solid var(--border)}
.auth-tab{flex:1;padding:.9rem;text-align:center;font-size:.76rem;letter-spacing:.8px;text-transform:uppercase;color:var(--text3);cursor:pointer;border:none;background:none;font-family:var(--font-body);font-weight:500;transition:color .3s,background .3s;position:relative}
.auth-tab.active{color:var(--navy);background:var(--navy-light)}
.auth-tab.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--navy)}
.auth-body{padding:1.8rem 2rem 2rem}
.form-row{margin-bottom:1.15rem}
.form-row label{display:block;font-size:.72rem;letter-spacing:.6px;text-transform:uppercase;color:var(--text2);margin-bottom:.4rem;font-weight:600}
.form-row input{width:100%;padding:.72rem .9rem;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:.88rem;font-family:var(--font-body);transition:border-color .3s,box-shadow .3s;outline:none}
.form-row input:focus{border-color:var(--navy2);box-shadow:0 0 0 3px var(--navy-light)}
.form-row input::placeholder{color:var(--text3)}
.form-row .hint{font-size:.7rem;color:var(--text3);margin-top:.3rem}
.pw-strength{display:flex;gap:4px;margin-top:.5rem;height:3px}
.pw-bar{flex:1;border-radius:2px;background:var(--border);transition:background .3s}
.pw-bar.weak{background:#ef4444}.pw-bar.ok{background:#f59e0b}.pw-bar.good{background:var(--blue)}.pw-bar.strong{background:var(--green)}
.pw-label{font-size:.7rem;color:var(--text3);margin-top:.35rem}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.74rem 1.4rem;border:none;border-radius:var(--radius-sm);font-family:var(--font-body);font-size:.8rem;letter-spacing:.5px;text-transform:uppercase;cursor:pointer;transition:all .25s;outline:none;width:100%;font-weight:600}
.btn-navy{background:var(--navy);color:#fff;box-shadow:0 3px 12px rgba(30,58,95,.3)}
.btn-navy:hover{background:var(--navy2);transform:translateY(-1px);box-shadow:0 5px 18px rgba(30,58,95,.35)}
.btn-navy:active{transform:translateY(0)}
.btn-navy:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border)}
.btn-ghost:hover{border-color:var(--navy2);color:var(--navy)}
.alert{padding:.68rem .9rem;border-radius:var(--radius-sm);font-size:.8rem;margin-bottom:.9rem;display:none;align-items:flex-start;gap:.5rem}
.alert.show{display:flex}
.alert-err{background:var(--red-light);border:1px solid rgba(220,38,38,.25);color:var(--red)}
.alert-ok{background:var(--green-light);border:1px solid rgba(22,163,74,.25);color:var(--green)}
.alert-info{background:var(--blue-light);border:1px solid rgba(37,99,235,.25);color:var(--blue)}
.forgot-link{display:block;text-align:right;font-size:.74rem;color:var(--text3);cursor:pointer;margin-top:-.3rem;margin-bottom:.7rem;background:none;border:none;font-family:var(--font-body);transition:color .25s}
.forgot-link:hover{color:var(--navy)}
.loading{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#appScreen{display:none}
#appScreen.show{display:block}
.topbar{position:sticky;top:0;z-index:100;background:var(--surface);border-bottom:1px solid var(--border);padding:.7rem 2rem;display:flex;align-items:center;justify-content:space-between;box-shadow:0 1px 4px rgba(0,0,0,.04)}
.topbar-left{display:flex;align-items:center;gap:1.2rem}
.topbar-logo{font-family:var(--font-display);font-size:1.45rem;color:var(--navy);font-weight:700}
.topbar-logo em{color:var(--gold);font-style:normal}
.topbar-user{display:flex;align-items:center;gap:.55rem;padding:.35rem .7rem;background:var(--surface2);border-radius:var(--radius-sm);border:1px solid var(--border)}
.topbar-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--navy),var(--navy2));display:flex;align-items:center;justify-content:center;font-size:.68rem;color:#fff;font-weight:700}
.topbar-name{font-size:.78rem;color:var(--text);font-weight:500}
.topbar-right{display:flex;align-items:center;gap:.6rem}
.btn-sm{padding:.38rem .8rem;font-size:.7rem;width:auto}
.page{max-width:1320px;margin:0 auto;padding:1.8rem 2rem 3.5rem}
.section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem;flex-wrap:wrap;gap:.8rem}
.section-head h2{font-family:var(--font-display);font-size:1.6rem;color:var(--navy);font-weight:600}
.section-head h2 span{color:var(--gold)}
.add-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;margin-bottom:1.6rem;box-shadow:var(--shadow)}
.add-grid{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:.7rem;align-items:end}
.add-grid .form-row{margin-bottom:0}
.add-grid .form-row input,.add-grid .form-row select{width:100%;padding:.64rem .8rem;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:.84rem;font-family:var(--font-body);outline:none;transition:border-color .3s,box-shadow .3s;appearance:none;-webkit-appearance:none}
.add-grid .form-row select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath fill='%2394a3b8' d='M0 0l5 6 5-6z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right .75rem center;padding-right:2rem}
.add-grid .form-row select option{background:#fff;color:var(--text)}
.add-grid .form-row input:focus,.add-grid .form-row select:focus{border-color:var(--navy2);box-shadow:0 0 0 3px var(--navy-light)}
.add-grid .form-row input[type=date]{color-scheme:light}
.add-actions{display:flex;gap:.55rem;margin-top:.9rem}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:.9rem;margin-bottom:1.6rem}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem 1.4rem;position:relative;overflow:hidden;box-shadow:var(--shadow);transition:border-color .3s,box-shadow .3s}
.stat-card:hover{border-color:var(--navy2);box-shadow:var(--shadow-md)}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.stat-card:nth-child(1)::before{background:linear-gradient(90deg,var(--gold),var(--gold2))}
.stat-card:nth-child(2)::before{background:linear-gradient(90deg,var(--blue),#60a5fa)}
.stat-card:nth-child(3)::before{background:linear-gradient(90deg,var(--purple),#a78bfa)}
.stat-card:nth-child(4)::before{background:linear-gradient(90deg,var(--green),#4ade80)}
.stat-label{font-size:.68rem;letter-spacing:.7px;text-transform:uppercase;color:var(--text3);margin-bottom:.35rem;font-weight:600}
.stat-value{font-family:var(--font-display);font-size:1.7rem;font-weight:700;color:var(--navy)}
.stat-value.gold{color:var(--gold)}
.stat-sub{font-size:.69rem;color:var(--text3);margin-top:.2rem}
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
.table-bar{display:flex;align-items:center;justify-content:space-between;padding:.9rem 1.3rem;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:.6rem}
.table-bar h3{font-size:.82rem;color:var(--navy);font-weight:600}
.table-bar-right{display:flex;align-items:center;gap:.5rem}
.search-box{position:relative}
.search-box input{padding:.38rem .75rem .38rem 1.9rem;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:.76rem;width:175px;outline:none;transition:border-color .3s,width .3s;font-family:var(--font-body)}
.search-box input:focus{border-color:var(--navy2);width:215px}
.search-box svg{position:absolute;left:.6rem;top:50%;transform:translateY(-50%);color:var(--text3);width:13px;height:13px}
table{width:100%;border-collapse:collapse}
thead{background:var(--navy)}
thead th{text-align:left;padding:.78rem 1.1rem;font-size:.66rem;letter-spacing:.7px;text-transform:uppercase;color:rgba(255,255,255,.75);font-weight:600;white-space:nowrap}
tbody tr{border-bottom:1px solid var(--border);transition:background .2s}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:var(--navy-light)}
tbody td{padding:.72rem 1.1rem;font-size:.82rem;color:var(--text)}
.td-desc{font-weight:600;color:var(--navy)}
.cat-pill{display:inline-block;padding:.18rem .55rem;border-radius:20px;font-size:.68rem;letter-spacing:.3px;text-transform:uppercase;font-weight:600}
.td-amount{font-family:var(--font-mono);font-size:.8rem;font-weight:600;color:var(--gold)}
.td-del{background:none;border:none;color:var(--text3);cursor:pointer;padding:.28rem;border-radius:4px;transition:color .2s,background .2s;font-size:.9rem}
.td-del:hover{color:var(--red);background:var(--red-light)}
.empty-row td{text-align:center;padding:2.8rem;color:var(--text3);font-size:.84rem}
.empty-row .empty-icon{font-size:1.8rem;margin-bottom:.4rem;opacity:.5}
.modal-overlay{position:fixed;inset:0;background:rgba(30,58,95,.35);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);width:90%;max-width:500px;padding:1.8rem;position:relative;box-shadow:var(--shadow-lg);animation:modal-in .25s cubic-bezier(.4,0,.2,1)}
@keyframes modal-in{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
.modal-close{position:absolute;top:.9rem;right:.9rem;background:none;border:none;color:var(--text3);cursor:pointer;font-size:1.1rem;transition:color .2s}
.modal-close:hover{color:var(--red)}
.modal h3{font-family:var(--font-display);font-size:1.4rem;color:var(--navy);margin-bottom:.25rem;font-weight:600}
.modal>p{font-size:.76rem;color:var(--text3);margin-bottom:1.2rem}
.period-pills{display:flex;flex-wrap:wrap;gap:.45rem;margin-bottom:1rem}
.period-pill{padding:.38rem .85rem;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:.73rem;cursor:pointer;font-family:var(--font-body);transition:all .2s;letter-spacing:.3px;font-weight:500}
.period-pill:hover{border-color:var(--navy2);color:var(--navy)}
.period-pill.active{background:var(--navy);color:#fff;border-color:var(--navy);font-weight:600}
.custom-range{display:none;gap:.6rem;align-items:center;margin-bottom:1rem}
.custom-range.show{display:flex}
.custom-range label{font-size:.68rem;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
.custom-range input{flex:1;padding:.46rem .7rem;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:.78rem;font-family:var(--font-body);outline:none;color-scheme:light;transition:border-color .3s}
.custom-range input:focus{border-color:var(--navy2)}
.wm-section{margin-bottom:1rem}
.wm-section label{display:block;font-size:.68rem;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:.35rem;font-weight:600}
.wm-row{display:flex;gap:.5rem;align-items:center}
.wm-row input[type=text]{flex:1;padding:.46rem .7rem;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:.8rem;font-family:var(--font-body);outline:none;transition:border-color .3s}
.wm-row input[type=text]:focus{border-color:var(--navy2)}
.wm-row input[type=color]{width:32px;height:32px;border:1px solid var(--border);border-radius:var(--radius-sm);background:none;cursor:pointer;padding:2px}
.fmt-toggle{display:flex;gap:.45rem;margin-bottom:1.2rem}
.fmt-btn{flex:1;padding:.5rem;border-radius:var(--radius-sm);border:1px solid var(--border);background:transparent;color:var(--text2);font-size:.73rem;cursor:pointer;font-family:var(--font-body);transition:all .2s;text-align:center;letter-spacing:.2px;font-weight:500}
.fmt-btn:hover{border-color:var(--navy2);color:var(--navy)}
.fmt-btn.active{background:var(--navy);color:#fff;border-color:var(--navy);font-weight:600}
.modal-actions{display:flex;gap:.5rem}
.toast{position:fixed;bottom:1.6rem;right:1.6rem;z-index:300;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:.6rem 1rem;font-size:.76rem;color:var(--text);display:flex;align-items:center;gap:.55rem;transform:translateX(140%);transition:transform .35s cubic-bezier(.4,0,.2,1);box-shadow:var(--shadow-md);max-width:280px}
.toast.show{transform:translateX(0)}
.toast.ok .toast-dot{background:var(--green)}.toast.err .toast-dot{background:var(--red)}.toast.info .toast-dot{background:var(--blue)}
.toast-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.confirm-overlay{position:fixed;inset:0;background:rgba(30,58,95,.3);z-index:201;display:none;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.confirm-overlay.show{display:flex}
.confirm-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.6rem;max-width:340px;width:90%;text-align:center;box-shadow:var(--shadow-lg);animation:modal-in .22s cubic-bezier(.4,0,.2,1)}
.confirm-box h4{color:var(--navy);margin-bottom:.3rem;font-weight:600}
.confirm-box p{font-size:.76rem;color:var(--text2);margin-bottom:1.1rem}
.confirm-btns{display:flex;justify-content:center;gap:.5rem}
.confirm-btns .btn{width:auto;padding:.44rem 1.1rem}
.btn-red{background:var(--red);color:#fff;font-weight:600}
.btn-red:hover{background:#b91c1c}
@media(max-width:900px){.add-grid{grid-template-columns:1fr 1fr}.stats-row{grid-template-columns:1fr 1fr}}
@media(max-width:600px){.topbar{padding:.55rem 1rem}.page{padding:1rem 1rem 2.5rem}.add-grid{grid-template-columns:1fr}.stats-row{grid-template-columns:1fr 1fr}.topbar-user .topbar-name{display:none}table{font-size:.76rem}thead th,tbody td{padding:.55rem .65rem}}
@keyframes fade-up{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.anim-in{animation:fade-up .38s cubic-bezier(.4,0,.2,1) both}
</style>
</head>
<body>

<section id="authScreen" class="z1">
  <div class="auth-logo"><h1>Finance<em>Flow</em></h1><p>Expense Management</p></div>
  <div class="auth-card">
    <div class="auth-tabs">
      <button class="auth-tab active" data-tab="login">Sign In</button>
      <button class="auth-tab" data-tab="register">Create Account</button>
    </div>
    <div class="auth-body">
      <div class="alert" id="authAlert"></div>
      <form id="loginForm" autocomplete="off">
        <div class="form-row"><label>Email</label><input type="email" id="loginEmail" placeholder="you@example.com" required></div>
        <div class="form-row"><label>Password</label><input type="password" id="loginPw" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required></div>
        <button type="button" class="forgot-link" id="forgotBtn">Forgot password?</button>
        <button type="submit" class="btn btn-navy" id="loginBtn">Sign In</button>
      </form>
      <form id="registerForm" style="display:none" autocomplete="off">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.7rem">
          <div class="form-row"><label>First Name</label><input type="text" id="regFirst" placeholder="Benjamin" required></div>
          <div class="form-row"><label>Last Name</label><input type="text" id="regLast" placeholder="Omondi" required></div>
        </div>
        <div class="form-row"><label>Email</label><input type="email" id="regEmail" placeholder="benjamami@example.com" required></div>
        <div class="form-row"><label>Phone (optional)</label><input type="tel" id="regPhone" placeholder="+254 712 345 678"></div>
        <div class="form-row"><label>Watermark Text</label><input type="text" id="regWatermark" placeholder="e.g. BENJAMIN O" required><p class="hint">Appears on your PDF reports</p></div>
        <div class="form-row"><label>Password</label><input type="password" id="regPw" placeholder="Minimum 8 characters" required>
          <div class="pw-strength"><div class="pw-bar" id="pwBar1"></div><div class="pw-bar" id="pwBar2"></div><div class="pw-bar" id="pwBar3"></div><div class="pw-bar" id="pwBar4"></div></div>
          <p class="pw-label" id="pwLabel">Enter a password</p></div>
        <div class="form-row"><label>Confirm Password</label><input type="password" id="regPwConf" placeholder="Re-enter password" required></div>
        <button type="submit" class="btn btn-navy" id="registerBtn">Create Account</button>
      </form>
      <div id="forgotScreen" style="display:none">
        <div class="form-row"><label>Email Address</label><input type="email" id="forgotEmail" placeholder="you@example.com"></div>
        <button type="button" class="btn btn-navy" id="forgotSendBtn">Send Reset Email</button>
        <div style="margin-top:.7rem;text-align:center"><button class="forgot-link" id="backFromForgot">‚Üê Back to Sign In</button></div>
      </div>
    </div>
  </div>
</section>

<section id="appScreen" class="z1">
  <nav class="topbar">
    <div class="topbar-left">
      <span class="topbar-logo">Finance<em>Flow</em></span>
      <div class="topbar-user"><div class="topbar-avatar" id="topbarAvatar">JD</div><span class="topbar-name" id="topbarName">Jane Doe</span></div>
    </div>
    <div class="topbar-right">
      <button class="btn btn-navy btn-sm" id="aiInsightsBtn">ü§ñ AI Insights</button>
      <button class="btn btn-navy btn-sm" id="exportBtn">‚¨á Export</button>
      <button class="btn btn-ghost btn-sm" id="logoutBtn">Sign Out</button>
    </div>
  </nav>
  <div class="page">
    <div class="add-card anim-in">
      <div class="section-head" style="margin-bottom:.9rem"><h2>Add <span>Expense</span></h2></div>
      <div class="add-grid">
        <div class="form-row"><label>Description</label><input type="text" id="expDesc" placeholder="e.g. Grocery Shopping"></div>
        <div class="form-row"><label>Amount (KSH)</label><input type="number" id="expAmt" placeholder="0.00" step="0.01" min="0"></div>
        <div class="form-row"><label>Category</label>
          <select id="expCat">
            <option value="Food">üçΩ  Food</option><option value="Transport">üöó  Transport</option>
            <option value="Entertainment">üé¨  Entertainment</option><option value="Utilities">üí°  Utilities</option>
            <option value="Healthcare">üè•  Healthcare</option><option value="Shopping">üõç  Shopping</option>
            <option value="Education">üìö  Education</option><option value="Housing">üè†  Housing</option>
            <option value="Other">üìå  Other</option>
          </select>
        </div>
        <div class="form-row"><label>Date</label><input type="date" id="expDate"></div>
      </div>
      <div class="add-actions">
        <button class="btn btn-navy btn-sm" id="addExpBtn" style="width:auto">+ Add Expense</button>
        <button class="btn btn-ghost btn-sm" id="clearExpBtn" style="width:auto">Clear</button>
      </div>
    </div>
    <div class="stats-row">
      <div class="stat-card anim-in"><div class="stat-label">Weekly</div><div class="stat-value gold" id="statWeekly">KSH 0</div><div class="stat-sub" id="statWeeklySub">0 transactions</div></div>
      <div class="stat-card anim-in" style="animation-delay:.07s"><div class="stat-label">Monthly</div><div class="stat-value gold" id="statMonthly">KSH 0</div><div class="stat-sub" id="statMonthlySub">0 transactions</div></div>
      <div class="stat-card anim-in" style="animation-delay:.13s"><div class="stat-label">Annual</div><div class="stat-value gold" id="statAnnual">KSH 0</div><div class="stat-sub" id="statAnnualSub">0 transactions</div></div>
      <div class="stat-card anim-in" style="animation-delay:.19s"><div class="stat-label">All Time</div><div class="stat-value" id="statTotal">KSH 0</div><div class="stat-sub" id="statTotalSub">0 total entries</div></div>
    </div>
    <div class="table-wrap anim-in" style="animation-delay:.24s">
      <div class="table-bar">
        <h3>Expense History</h3>
        <div class="table-bar-right"><div class="search-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><input type="text" id="searchInput" placeholder="Search‚Ä¶"></div></div>
      </div>
      <table><thead><tr><th>#</th><th>Date</th><th>Description</th><th>Category</th><th style="text-align:right">Amount</th><th></th></tr></thead><tbody id="expenseBody"></tbody></table>
    </div>
  </div>
</section>
<!-- AI Insights Modal -->
<div class="modal-overlay" id="aiInsightsOverlay">
  <div class="modal" style="max-width:900px;max-height:90vh;overflow-y:auto">
    <button class="modal-close" id="aiInsightsClose">‚úï</button>
    <h3>ü§ñ AI-Powered Expense Insights</h3>
    <p>Advanced analysis and predictions for your spending patterns</p>
    
    <div id="aiInsightsLoading" style="text-align:center;padding:3rem;display:none">
      <div class="loading" style="width:40px;height:40px;border-width:4px;margin:0 auto 1rem"></div>
      <p style="color:var(--text3);font-size:.85rem">Analyzing your expenses with AI...</p>
    </div>
    
    <div id="aiInsightsContent" style="display:none">
      <!-- Period Selector -->
      <div style="margin-bottom:1.5rem;padding:1rem;background:var(--surface2);border-radius:var(--radius-sm)">
        <label style="font-size:.72rem;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:.5rem;font-weight:600">Analyze Period</label>
        <div class="period-pills">
          <button class="period-pill active" data-ai-period="week">This Week</button>
          <button class="period-pill" data-ai-period="month">This Month</button>
          <button class="period-pill" data-ai-period="year">This Year</button>
          <button class="period-pill" data-ai-period="all">All Time</button>
        </div>
      </div>
      
      <!-- Charts Section -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem">
          <h4 style="font-size:.85rem;color:var(--navy);margin-bottom:1rem;font-weight:600">Spending by Category</h4>
          <canvas id="categoryChart" style="max-height:200px"></canvas>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem">
          <h4 style="font-size:.85rem;color:var(--navy);margin-bottom:1rem;font-weight:600">Spending Trend</h4>
          <canvas id="trendChart" style="max-height:200px"></canvas>
        </div>
      </div>
      
      <!-- AI Analysis Text -->
      <div style="background:linear-gradient(135deg,#eef2ff,#fdf2e9);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;margin-bottom:1rem">
        <h4 style="font-size:.9rem;color:var(--navy);margin-bottom:.8rem;font-weight:600;display:flex;align-items:center;gap:.5rem">
          <span style="font-size:1.2rem">üí°</span> AI Insights & Recommendations
        </h4>
        <div id="aiInsightsText" style="font-size:.85rem;line-height:1.7;color:var(--text);white-space:pre-wrap"></div>
      </div>
      
      <!-- Action Buttons -->
      <div style="display:flex;gap:.5rem">
        <button class="btn btn-navy btn-sm" id="downloadInsightsBtn" style="flex:1">üì• Download Report</button>
        <button class="btn btn-navy btn-sm" id="emailInsightsBtn" style="flex:1">üìß Email Report</button>
        <button class="btn btn-ghost btn-sm" id="refreshInsightsBtn" style="width:auto">üîÑ Refresh</button>
      </div>
    </div>
  </div>
</div>
<div class="modal-overlay" id="exportOverlay">
  <div class="modal">
    <button class="modal-close" id="exportClose">‚úï</button>
    <h3>Download Report</h3><p>Choose period and format.</p>
    <div style="margin-bottom:.55rem">
      <label style="font-size:.68rem;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:.35rem;font-weight:600">Period</label>
      <div class="period-pills">
        <button class="period-pill" data-period="week">Weekly</button>
        <button class="period-pill" data-period="month">Monthly</button>
        <button class="period-pill" data-period="year">Annual</button>
        <button class="period-pill" data-period="custom">Custom</button>
      </div>
    </div>
    <div class="custom-range" id="customRange"><label>From</label><input type="date" id="customFrom"><label>To</label><input type="date" id="customTo"></div>
    <div class="wm-section"><label>Watermark</label><div class="wm-row"><input type="text" id="wmText" placeholder="Watermark‚Ä¶"><input type="color" id="wmColor" value="#c2853a"></div></div>
    <label style="font-size:.68rem;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:.35rem;font-weight:600">Format</label>
    <div class="fmt-toggle">
      <button class="fmt-btn active" data-fmt="pdf">üìÑ PDF</button>
      <button class="fmt-btn" data-fmt="xlsx">üìä Excel</button>
    </div>
    <div class="modal-actions"><button class="btn btn-navy" id="downloadBtn">‚¨á Download</button><button class="btn btn-ghost" id="exportCancelBtn" style="width:auto;flex:0">Cancel</button></div>
  </div>
</div>
<!-- Email Input Modal -->
<div class="modal-overlay" id="emailInputOverlay">
  <div class="modal" style="max-width:400px">
    <button class="modal-close" id="emailInputClose">‚úï</button>
    <h3>üìß Email AI Report</h3>
    <p style="margin-bottom:1.2rem">Send insights to your email</p>
    <div class="form-row">
      <label>Email Address</label>
      <input type="email" id="insightsEmailInput" placeholder="you@example.com">
    </div>
    <div style="display:flex;gap:.5rem;margin-top:1rem">
      <button class="btn btn-navy" id="sendEmailBtn">Send</button>
      <button class="btn btn-ghost" id="cancelEmailBtn">Cancel</button>
    </div>
  </div>
</div>
<div class="confirm-overlay" id="confirmOverlay"><div class="confirm-box"><h4 id="confirmTitle">Confirm</h4><p id="confirmMsg">Sure?</p><div class="confirm-btns"><button class="btn btn-ghost btn-sm" id="confirmCancel">Cancel</button><button class="btn btn-red btn-sm" id="confirmOk">Delete</button></div></div></div>
<div class="toast" id="toast"><div class="toast-dot"></div><span id="toastMsg"></span></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE CONFIGURATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ö†Ô∏è REPLACE THIS WITH YOUR FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyBFJ_cZFVgeRgIMaCeW1atIFZ80xhGSwAc",
  authDomain: "financetrack-e4ec9.firebaseapp.com",
  projectId: "financetrack-e4ec9",
  storageBucket: "financetrack-e4ec9.firebasestorage.app",
  messagingSenderId: "469678326579",
  appId: "1:469678326579:web:92e885691bca4d29d17446",
  measurementId: "G-7FMSNGD1BB"
};

let app, auth, db;
try {
  app = firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
  
  // Configure custom email templates
  auth.languageCode = 'en';
  
  console.log('%c‚úÖ Firebase Connected Successfully', 'color:#16a34a;font-weight:bold;font-size:14px;padding:4px 8px;background:#d1fae5;border-radius:4px');
} catch(e) {
  console.error('%c‚ö†Ô∏è Firebase Setup Required', 'color:#dc2626;font-weight:bold;font-size:14px;padding:4px 8px;background:#fee2e2;border-radius:4px');
  console.log('%c\nFollow the setup guide to configure Firebase.\nReplace the firebaseConfig object above with your actual config.\n', 'color:#2563eb;font-size:12px');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITY FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function toast(msg,type='ok'){const t=document.getElementById('toast');t.className='toast '+type;document.getElementById('toastMsg').textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800)}

let _confirmResolve=null;
function confirm2(title,msg){return new Promise(res=>{document.getElementById('confirmTitle').textContent=title;document.getElementById('confirmMsg').textContent=msg;document.getElementById('confirmOverlay').classList.add('show');_confirmResolve=res})}
document.getElementById('confirmCancel').addEventListener('click',()=>{document.getElementById('confirmOverlay').classList.remove('show');if(_confirmResolve)_confirmResolve(false)});
document.getElementById('confirmOk').addEventListener('click',()=>{document.getElementById('confirmOverlay').classList.remove('show');if(_confirmResolve)_confirmResolve(true)});

function getPasswordStrength(pw){let s=0;if(pw.length>=8)s++;if(pw.length>=12)s++;if(/[A-Z]/.test(pw)&&/[a-z]/.test(pw))s++;if(/[0-9]/.test(pw))s++;if(/[^A-Za-z0-9]/.test(pw))s++;return Math.min(s,4)}
function updatePwUI(pw){const s=getPasswordStrength(pw);const labels=['','Weak','Fair','Good','Strong ‚úì'];const cls=['','weak','ok','good','strong'];for(let i=1;i<=4;i++)document.getElementById('pwBar'+i).className='pw-bar'+(i<=s?' '+cls[s]:'');const lbl=document.getElementById('pwLabel');lbl.textContent=labels[s]||'Enter a password';lbl.style.color=s>=4?'var(--green)':s>=2?'var(--text3)':'var(--red)'}
document.getElementById('regPw').addEventListener('input',e=>updatePwUI(e.target.value));

function authAlert(msg,type='err'){const el=document.getElementById('authAlert');el.className='alert alert-'+type+' show';el.textContent=msg}
function clearAlert(){document.getElementById('authAlert').classList.remove('show')}

function showAuthSub(id){['loginForm','registerForm','forgotScreen'].forEach(x=>document.getElementById(x).style.display=x===id?'block':'none')}

function setLoading(btnId, loading) {
  const btn = document.getElementById(btnId);
  if(loading) {
    btn.disabled = true;
    btn.innerHTML = '<span class="loading"></span> Processing...';
  } else {
    btn.disabled = false;
    btn.textContent = btn.id === 'loginBtn' ? 'Sign In' : btn.id === 'registerBtn' ? 'Create Account' : 'Send Reset Email';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTHENTICATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

document.querySelectorAll('.auth-tab').forEach(tab=>{tab.addEventListener('click',()=>{clearAlert();document.querySelectorAll('.auth-tab').forEach(t=>t.classList.remove('active'));tab.classList.add('active');const w=tab.dataset.tab;showAuthSub(w==='login'?'loginForm':'registerForm')})});

document.getElementById('forgotBtn').addEventListener('click',()=>{clearAlert();showAuthSub('forgotScreen')});
document.getElementById('backFromForgot').addEventListener('click',()=>{clearAlert();showAuthSub('loginForm')});

// Register - FIXED: No auto-login
document.getElementById('registerForm').addEventListener('submit', async e => {
  e.preventDefault();clearAlert();
  const first=document.getElementById('regFirst').value.trim();
  const last=document.getElementById('regLast').value.trim();
  const email=document.getElementById('regEmail').value.trim();
  const phone=document.getElementById('regPhone').value.trim();
  const wm=document.getElementById('regWatermark').value.trim();
  const pw=document.getElementById('regPw').value;
  const pwc=document.getElementById('regPwConf').value;
  
  if(!first||!last||!email||!wm)return authAlert('Fill all required fields');
  if(pw.length<8)return authAlert('Password: minimum 8 characters');
  if(getPasswordStrength(pw)<2)return authAlert('Password too weak');
  if(pw!==pwc)return authAlert('Passwords don\'t match');
  
  setLoading('registerBtn', true);
  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pw);
    await db.collection('users').doc(cred.user.uid).set({
      first, last, email, phone, watermark:wm, createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    // Sign out immediately to prevent auto-login
    await auth.signOut();
    authAlert('Account created successfully! Please sign in.', 'ok');
    document.getElementById('registerForm').reset();
    updatePwUI('');
    showAuthSub('loginForm');
    document.querySelectorAll('.auth-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab==='login'));
  } catch(err) {
    authAlert(err.code==='auth/email-already-in-use'?'Email already registered':err.message);
  }
  setLoading('registerBtn', false);
});

// Login - FIXED: Working properly
document.getElementById('loginForm').addEventListener('submit', async e => {
  e.preventDefault();clearAlert();
  const email=document.getElementById('loginEmail').value.trim();
  const pw=document.getElementById('loginPw').value;
  
  setLoading('loginBtn', true);
  try {
    await auth.signInWithEmailAndPassword(email, pw);
    // Success toast handled by auth state listener
  } catch(err) {
    authAlert(err.code==='auth/wrong-password'||err.code==='auth/user-not-found'?'Invalid email or password':err.message);
    setLoading('loginBtn', false);
  }
});

// Forgot Password
document.getElementById('forgotSendBtn').addEventListener('click', async () => {
  const email=document.getElementById('forgotEmail').value.trim();
  if(!email)return authAlert('Enter your email');
  
  setLoading('forgotSendBtn', true);
  try {
    await auth.sendPasswordResetEmail(email);
    authAlert('Password reset email sent! Check your inbox.', 'ok');
  } catch(err) {
    authAlert(err.code==='auth/user-not-found'?'Email not found':err.message);
  }
  setLoading('forgotSendBtn', false);
});

// Logout
document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());

// Auth state listener
auth.onAuthStateChanged(async user => {
  if(user) {
    const userDoc = await db.collection('users').doc(user.uid).get();
    const userData = userDoc.data();
    document.getElementById('authScreen').style.display='none';
    document.getElementById('appScreen').classList.add('show');
    document.getElementById('topbarAvatar').textContent=((userData.first[0]||'')+(userData.last[0]||'')).toUpperCase();
    document.getElementById('topbarName').textContent=userData.first+' '+userData.last;
    document.getElementById('wmText').value=userData.watermark||userData.first;
    document.getElementById('expDate').value=new Date().toISOString().split('T')[0];
    loadExpenses(user.uid);
  } else {
    document.getElementById('appScreen').classList.remove('show');
    document.getElementById('authScreen').style.display='flex';
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPENSE MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let currentExpenses = [];
let currentUserId = null;

function loadExpenses(userId) {
  currentUserId = userId;
  db.collection('expenses').where('userId','==',userId)
    .onSnapshot(snapshot => {
      currentExpenses = snapshot.docs.map(doc => ({id:doc.id, ...doc.data()}));
      // Sort by date in JavaScript instead of Firestore
      currentExpenses.sort((a,b) => new Date(b.date) - new Date(a.date));
      renderTable();
      renderStats();
    });
}

document.getElementById('addExpBtn').addEventListener('click', async () => {
  if(!currentUserId)return;
  const desc=document.getElementById('expDesc').value.trim();
  const amt=parseFloat(document.getElementById('expAmt').value);
  const cat=document.getElementById('expCat').value;
  const date=document.getElementById('expDate').value;
  
  if(!desc)return toast('Enter description','err');
  if(!amt||amt<=0)return toast('Enter valid amount','err');
  if(!date)return toast('Pick a date','err');
  
  try {
    await db.collection('expenses').add({
      userId:currentUserId, desc, amt, cat, date,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('expDesc').value='';
    document.getElementById('expAmt').value='';
    document.getElementById('expDate').value=new Date().toISOString().split('T')[0];
    toast('Expense added','ok');
  } catch(err) {
    toast('Error adding expense','err');
  }
});

document.getElementById('clearExpBtn').addEventListener('click',()=>{
  document.getElementById('expDesc').value='';
  document.getElementById('expAmt').value='';
  document.getElementById('expDate').value=new Date().toISOString().split('T')[0];
});

document.getElementById('expenseBody').addEventListener('click', async e => {
  const btn=e.target.closest('.td-del');
  if(!btn)return;
  const ok=await confirm2('Delete Expense','Cannot be undone.');
  if(!ok)return;
  try {
    await db.collection('expenses').doc(btn.dataset.id).delete();
    toast('Deleted','ok');
  } catch(err) {
    toast('Error deleting','err');
  }
});

const CAT_COLORS={Food:'#f59e0b',Transport:'#3b82f6',Entertainment:'#8b5cf6',Utilities:'#d97706',Healthcare:'#ef4444',Shopping:'#10b981',Education:'#0ea5e9',Housing:'#c2853a',Other:'#6b7280'};
const CAT_BG={Food:'#fef3c7',Transport:'#dbeafe',Entertainment:'#ede9fe',Utilities:'#fef3c7',Healthcare:'#fee2e2',Shopping:'#d1fae5',Education:'#e0f2fe',Housing:'#fdf2e9',Other:'#f3f4f6'};

function renderTable(){
  const search=document.getElementById('searchInput').value.trim().toLowerCase();
  let exps=currentExpenses.filter(e=>!search||e.desc.toLowerCase().includes(search)||e.cat.toLowerCase().includes(search));
  const tbody=document.getElementById('expenseBody');
  if(!exps.length){tbody.innerHTML='<tr class="empty-row"><td colspan="6"><div class="empty-icon">üìã</div>No expenses yet</td></tr>';return}
  tbody.innerHTML=exps.map((exp,i)=>{
    const d=new Date(exp.date+'T00:00:00');
    const ds=d.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
    return`<tr><td style="color:var(--text3);font-weight:600">${i+1}</td><td style="color:var(--text2)">${ds}</td><td class="td-desc">${exp.desc}</td><td><span class="cat-pill" style="background:${CAT_BG[exp.cat]||'#f3f4f6'};color:${CAT_COLORS[exp.cat]||'#6b7280'}">${exp.cat}</span></td><td class="td-amount" style="text-align:right">KSH ${exp.amt.toLocaleString('en',{minimumFractionDigits:2})}</td><td><button class="td-del" data-id="${exp.id}">üóë</button></td></tr>`}).join('');
}
document.getElementById('searchInput').addEventListener('input',renderTable);

function renderStats(){
  const now=new Date();
  const calc=days=>{const cut=new Date(now);cut.setDate(cut.getDate()-days);return currentExpenses.filter(e=>new Date(e.date+'T00:00:00')>=cut)};
  const w=calc(7),m=calc(30),y=calc(365),all=currentExpenses;
  const sum=arr=>arr.reduce((s,e)=>s+e.amt,0);
  const fmt=n=>'KSH '+n.toLocaleString('en',{minimumFractionDigits:0});
  document.getElementById('statWeekly').textContent=fmt(sum(w));
  document.getElementById('statWeeklySub').textContent=w.length+' transaction'+(w.length!==1?'s':'');
  document.getElementById('statMonthly').textContent=fmt(sum(m));
  document.getElementById('statMonthlySub').textContent=m.length+' transaction'+(m.length!==1?'s':'');
  document.getElementById('statAnnual').textContent=fmt(sum(y));
  document.getElementById('statAnnualSub').textContent=y.length+' transaction'+(y.length!==1?'s':'');
  document.getElementById('statTotal').textContent=fmt(sum(all));
  document.getElementById('statTotalSub').textContent=all.length+' total entr'+(all.length!==1?'ies':'y');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

document.getElementById('exportBtn').addEventListener('click',()=>document.getElementById('exportOverlay').classList.add('show'));
document.getElementById('exportClose').addEventListener('click',()=>document.getElementById('exportOverlay').classList.remove('show'));
document.getElementById('exportCancelBtn').addEventListener('click',()=>document.getElementById('exportOverlay').classList.remove('show'));

let selectedPeriod='month';
document.querySelectorAll('.period-pill').forEach(pill=>{pill.addEventListener('click',()=>{document.querySelectorAll('.period-pill').forEach(p=>p.classList.remove('active'));pill.classList.add('active');selectedPeriod=pill.dataset.period;document.getElementById('customRange').classList.toggle('show',selectedPeriod==='custom')})});

let selectedFormat='pdf';
document.querySelectorAll('.fmt-btn').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.fmt-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');selectedFormat=btn.dataset.fmt})});

document.getElementById('downloadBtn').addEventListener('click',async()=>{
  if(!currentExpenses.length)return toast('No expenses','err');
  
  let from,to;const now=new Date();to=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  if(selectedPeriod==='week'){from=new Date(to);from.setDate(from.getDate()-6)}
  else if(selectedPeriod==='month'){from=new Date(to);from.setMonth(from.getMonth()-1);from.setDate(from.getDate()+1)}
  else if(selectedPeriod==='year'){from=new Date(to);from.setFullYear(from.getFullYear()-1);from.setDate(from.getDate()+1)}
  else{from=new Date(document.getElementById('customFrom').value+'T00:00:00');to=new Date(document.getElementById('customTo').value+'T00:00:00');if(isNaN(from.getTime())||isNaN(to.getTime()))return toast('Pick dates','err');if(from>to)return toast('Invalid range','err')}
  
  const filtered=currentExpenses.filter(e=>{const d=new Date(e.date+'T00:00:00');return d>=from&&d<=to});
  if(!filtered.length)return toast('No expenses in period','err');
  
  const userDoc=await db.collection('users').doc(currentUserId).get();
  const user=userDoc.data();
  const wmText=document.getElementById('wmText').value.trim()||user.watermark;
  const wmColor=document.getElementById('wmColor').value;
  
  if(selectedFormat==='xlsx')exportExcel({first:user.first,last:user.last},filtered,from,to,wmText);
  else exportPDF({first:user.first,last:user.last},filtered,from,to,wmText,wmColor);
  
  document.getElementById('exportOverlay').classList.remove('show');
});

function fmtDate(d){return d.toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit',year:'numeric'}).replace(/\//g,'-')}
function fmtDateLong(d){return d.toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'})}
function hexToRgb(hex){hex=hex.replace(/^#/,'');if(hex.length===3)hex=hex.split('').map(c=>c+c).join('');return{r:parseInt(hex.substr(0,2),16),g:parseInt(hex.substr(2,2),16),b:parseInt(hex.substr(4,2),16)}}

// Helper to lighten a color for category badges
function lightenColor(r, g, b, percent) {
  const amt = percent / 100;
  return {
    r: Math.round(r + (255 - r) * amt),
    g: Math.round(g + (255 - g) * amt),
    b: Math.round(b + (255 - b) * amt)
  };
}

function exportExcel(user,data,from,to,wmText){
  const rows=data.sort((a,b)=>new Date(a.date)-new Date(b.date)).map(e=>({Date:new Date(e.date+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}),Description:e.desc,Category:e.cat,'Amount (KSH)':e.amt}));
  const total=data.reduce((s,e)=>s+e.amt,0);
  const sheet=[{Date:'REPORT:',Description:`${user.first} ${user.last}`,Category:'','Amount (KSH)':''},{Date:'Period:',Description:`${fmtDate(from)} ‚Äì ${fmtDate(to)}`,Category:'','Amount (KSH)':''},{Date:'Watermark:',Description:wmText,Category:'','Amount (KSH)':''},{Date:'Total:',Description:'',Category:'','Amount (KSH)':total},{Date:'',Description:'',Category:'','Amount (KSH)':''},...rows];
  const ws=XLSX.utils.json_to_sheet(sheet);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Expenses');
  XLSX.writeFile(wb,`${user.first}_${user.last}_${fmtDate(from)}_to_${fmtDate(to)}.xlsx`);toast('Excel downloaded!','ok');
}

// FIXED PDF EXPORT: Category badges now have proper light backgrounds, no black boxes
function exportPDF(user,data,from,to,wmText,wmColorHex){
  const{jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const PW=210,PH=297,ML=8,MR=8,MT=8,MB=8,CW=PW-ML-MR;
  
  const wc=hexToRgb(wmColorHex);
  const wmR=Math.round(wc.r*.08+255*.92),wmG=Math.round(wc.g*.08+255*.92),wmB=Math.round(wc.b*.08+255*.92);
  const sorted=[...data].sort((a,b)=>new Date(a.date)-new Date(b.date));
  
  function addPageBg(){
    doc.setFont('Helvetica','normal');doc.setFontSize(8);doc.setTextColor(wmR,wmG,wmB);
    const sp=24;
    for(let y=15;y<PH-10;y+=sp){
      for(let x=(Math.floor(y/sp)%2===0?-10:6);x<PW+15;x+=sp){
        doc.text(wmText,x,y,{angle:20});
      }
    }
    doc.setFillColor(194,133,58);doc.rect(0,0,PW,.8,'F');
  }
  
  addPageBg();
  let y=MT+2;
  
  // Header
  doc.setTextColor(30,58,95);doc.setFont('Helvetica','bold');doc.setFontSize(22);
  doc.text('FinanceFlow',ML,y+8);
  doc.setFontSize(8);doc.setFont('Helvetica','normal');doc.setTextColor(148,163,184);
  doc.text('EXPENSE REPORT',ML,y+14);
  doc.setFontSize(7.5);doc.setTextColor(71,85,105);
  doc.text(`${fmtDateLong(from)} ‚Äì ${fmtDateLong(to)}`,PW-MR,y+6,{align:'right'});
  doc.setFontSize(6.5);doc.setTextColor(148,163,184);
  doc.text(`Generated ${new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit',year:'numeric'})}`,PW-MR,y+11,{align:'right'});
  
  doc.setFillColor(239,246,255);
  const userName=`${user.first} ${user.last}`;
  const nameW=doc.getTextWidth(userName)+8;
  doc.roundedRect(PW-MR-nameW,y+13,nameW,6,1.5,1.5,'F');
  doc.setTextColor(30,58,95);doc.setFont('Helvetica','bold');doc.setFontSize(7);
  doc.text(userName,PW-MR-nameW+4,y+17.5);
  
  y+=23;
  doc.setDrawColor(226,232,240);doc.setLineWidth(.3);doc.line(ML,y,PW-MR,y);
  
  y+=5;
  const total=data.reduce((s,e)=>s+e.amt,0);
  const cats={};
  data.forEach(e=>{cats[e.cat]=(cats[e.cat]||0)+e.amt});
  const topCat=Object.entries(cats).sort((a,b)=>b[1]-a[1])[0];
  const cardW=(CW-4)/3;
  
  // Summary Cards
  let cx=ML;
  doc.setFillColor(254,243,199);doc.roundedRect(cx,y,cardW,18,2,2,'F');
  doc.setDrawColor(251,191,36);doc.setLineWidth(.4);doc.roundedRect(cx,y,cardW,18,2,2,'S');
  doc.setTextColor(146,64,14);doc.setFontSize(5.5);doc.setFont('Helvetica','bold');
  doc.text('TOTAL SPENT',cx+3,y+5);
  doc.setTextColor(194,133,58);doc.setFontSize(12);
  doc.text('KSH '+total.toLocaleString('en',{minimumFractionDigits:0}),cx+3,y+13);
  
  cx+=cardW+2;
  doc.setFillColor(219,234,254);doc.roundedRect(cx,y,cardW,18,2,2,'F');
  doc.setDrawColor(59,130,246);doc.setLineWidth(.4);doc.roundedRect(cx,y,cardW,18,2,2,'S');
  doc.setTextColor(30,58,138);doc.setFontSize(5.5);
  doc.text('TRANSACTIONS',cx+3,y+5);
  doc.setTextColor(37,99,235);doc.setFontSize(12);
  doc.text(String(data.length),cx+3,y+13);
  doc.setFontSize(6);doc.setTextColor(71,85,105);doc.setFont('Helvetica','normal');
  doc.text('entries',cx+3,y+16.5);
  
  cx+=cardW+2;
  doc.setFillColor(237,233,254);doc.roundedRect(cx,y,cardW,18,2,2,'F');
  doc.setDrawColor(139,92,246);doc.setLineWidth(.4);doc.roundedRect(cx,y,cardW,18,2,2,'S');
  doc.setTextColor(76,29,149);doc.setFontSize(5.5);doc.setFont('Helvetica','bold');
  doc.text('TOP CATEGORY',cx+3,y+5);
  doc.setTextColor(124,58,237);doc.setFontSize(9);
  doc.text(topCat?topCat[0]:'‚Äî',cx+3,y+12);
  if(topCat){
    doc.setFontSize(6);doc.setTextColor(71,85,105);doc.setFont('Helvetica','normal');
    doc.text('KSH '+topCat[1].toLocaleString('en',{minimumFractionDigits:0}),cx+3,y+16.5);
  }
  
  y+=24;
  doc.setFontSize(9);doc.setTextColor(30,58,95);doc.setFont('Helvetica','bold');
  doc.text('Expense Transactions',ML,y);
  y+=5;
  
  // Table Header
  doc.setFillColor(248,250,252);doc.rect(ML,y,CW,7,'F');
  doc.setDrawColor(226,232,240);doc.setLineWidth(.2);doc.line(ML,y+7,PW-MR,y+7);
  doc.setTextColor(71,85,105);doc.setFontSize(6);doc.setFont('Helvetica','bold');
  doc.text('#',ML+2,y+4.5);
  doc.text('DATE',ML+10,y+4.5);
  doc.text('DESCRIPTION',ML+35,y+4.5);
  doc.text('CATEGORY',ML+115,y+4.5);
  doc.text('AMOUNT',PW-MR-2,y+4.5,{align:'right'});
  y+=7;
  
  let rowIdx=0;
  sorted.forEach(exp=>{
    // Page break
    if(y>PH-MB-15){
      doc.addPage();addPageBg();
      let hy=MT+2;
      doc.setTextColor(30,58,95);doc.setFont('Helvetica','bold');doc.setFontSize(9);
      doc.text('FinanceFlow ‚Äî Expense Report (continued)',ML,hy+5);
      doc.setDrawColor(226,232,240);doc.setLineWidth(.3);doc.line(ML,hy+8,PW-MR,hy+8);
      y=hy+13;
      doc.setFillColor(248,250,252);doc.rect(ML,y,CW,7,'F');
      doc.setDrawColor(226,232,240);doc.setLineWidth(.2);doc.line(ML,y+7,PW-MR,y+7);
      doc.setTextColor(71,85,105);doc.setFontSize(6);doc.setFont('Helvetica','bold');
      doc.text('#',ML+2,y+4.5);doc.text('DATE',ML+10,y+4.5);
      doc.text('DESCRIPTION',ML+35,y+4.5);doc.text('CATEGORY',ML+115,y+4.5);
      doc.text('AMOUNT',PW-MR-2,y+4.5,{align:'right'});
      y+=7;
    }
    
    rowIdx++;
    if(rowIdx%2===0){doc.setFillColor(249,250,251);doc.rect(ML,y,CW,6,'F')}
    
    const d=new Date(exp.date+'T00:00:00');
    const ds=d.toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit',year:'numeric'});
    
    doc.setTextColor(148,163,184);doc.setFontSize(6);doc.setFont('Helvetica','normal');
    doc.text(String(rowIdx),ML+2,y+4);
    doc.setTextColor(100,116,139);doc.setFontSize(6.2);
    doc.text(ds,ML+10,y+4);
    doc.setTextColor(30,58,95);doc.setFont('Helvetica','bold');doc.setFontSize(6.5);
    doc.text(exp.desc.substring(0,35),ML+35,y+4);
    
    // FIXED: Category badge with light background (85% lighter than original color)
    const catColor=hexToRgb(CAT_COLORS[exp.cat]||'#6b7280');
    const lightBg=lightenColor(catColor.r,catColor.g,catColor.b,85);
    doc.setFillColor(lightBg.r,lightBg.g,lightBg.b);
    const catText=exp.cat;
    const catW=doc.getTextWidth(catText)+4;
    doc.roundedRect(ML+115,y+1,catW,4,1,1,'F');
    doc.setTextColor(catColor.r,catColor.g,catColor.b);
    doc.setFont('Helvetica','bold');doc.setFontSize(5.5);
    doc.text(catText,ML+117,y+4);
    
    doc.setTextColor(194,133,58);doc.setFont('Helvetica','bold');doc.setFontSize(7);
    doc.text('KSH '+exp.amt.toLocaleString('en',{minimumFractionDigits:2}),PW-MR-2,y+4,{align:'right'});
    doc.setDrawColor(241,245,249);doc.setLineWidth(.15);doc.line(ML,y+6,PW-MR,y+6);
    y+=6;
  });
  
  // Category Analysis
  y+=6;
  if(y>PH-MB-45){doc.addPage();addPageBg();y=MT+10}
  doc.setFontSize(9);doc.setTextColor(30,58,95);doc.setFont('Helvetica','bold');
  doc.text('Category Analysis',ML,y);
  y+=6;
  
  Object.entries(cats).sort((a,b)=>b[1]-a[1]).forEach(([cat,amt])=>{
    if(y>PH-MB-10){doc.addPage();addPageBg();y=MT+10}
    const pct=((amt/total)*100).toFixed(1);
    const barW=(amt/total)*(CW*.6);
    const catColor=hexToRgb(CAT_COLORS[cat]||'#6b7280');
    doc.setFillColor(241,245,249);doc.roundedRect(ML,y,CW*.6,5,1.5,1.5,'F');
    doc.setFillColor(catColor.r,catColor.g,catColor.b);doc.roundedRect(ML,y,barW,5,1.5,1.5,'F');
    doc.setTextColor(30,58,95);doc.setFontSize(6.5);doc.setFont('Helvetica','bold');
    doc.text(cat,ML+CW*.62,y+3.5);
    doc.setTextColor(100,116,139);doc.setFont('Helvetica','normal');doc.setFontSize(6);
    doc.text(pct+'%',ML+CW*.62+25,y+3.5);
    doc.setTextColor(194,133,58);doc.setFont('Helvetica','bold');doc.setFontSize(6.5);
    doc.text('KSH '+amt.toLocaleString('en',{minimumFractionDigits:0}),PW-MR,y+3.5,{align:'right'});
    y+=7;
  });
  
  // Footer
  const pages=doc.internal.getNumberOfPages();
  for(let p=1;p<=pages;p++){
    doc.setPage(p);
    doc.setDrawColor(226,232,240);doc.setLineWidth(.2);doc.line(ML,PH-MB+2,PW-MR,PH-MB+2);
    doc.setTextColor(148,163,184);doc.setFontSize(5.5);doc.setFont('Helvetica','normal');
    doc.text(`Page ${p} of ${pages}`,ML,PH-MB+6);
    doc.text(`¬© ${user.first} ${user.last} ‚Äî FinanceFlow`,PW-MR,PH-MB+6,{align:'right'});
  }
  
  doc.save(`${user.first}_${user.last}_Report_${fmtDate(from)}_to_${fmtDate(to)}.pdf`);
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI INSIGHTS & VISUALIZATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let categoryChart, trendChart;
let currentAIPeriod = 'month';
let currentInsightsText = '';
let currentChartsData = null;

// Open AI Insights Modal
document.getElementById('aiInsightsBtn').addEventListener('click', () => {
  document.getElementById('aiInsightsOverlay').classList.add('show');
  generateAIInsights(currentAIPeriod);
});

document.getElementById('aiInsightsClose').addEventListener('click', () => {
  document.getElementById('aiInsightsOverlay').classList.remove('show');
});

// Period selection for AI
document.querySelectorAll('[data-ai-period]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('[data-ai-period]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentAIPeriod = btn.dataset.aiPeriod;
    generateAIInsights(currentAIPeriod);
  });
});

document.getElementById('refreshInsightsBtn').addEventListener('click', () => {
  generateAIInsights(currentAIPeriod);
});

// Filter expenses by period
function getExpensesByPeriod(period) {
  const now = new Date();
  let cutoff;
  
  if (period === 'week') {
    cutoff = new Date(now);
    cutoff.setDate(cutoff.getDate() - 7);
  } else if (period === 'month') {
    cutoff = new Date(now);
    cutoff.setMonth(cutoff.getMonth() - 1);
  } else if (period === 'year') {
    cutoff = new Date(now);
    cutoff.setFullYear(cutoff.getFullYear() - 1);
  } else {
    return currentExpenses; // all time
  }
  
  return currentExpenses.filter(e => new Date(e.date + 'T00:00:00') >= cutoff);
}

// Generate AI Insights
async function generateAIInsights(period) {
  document.getElementById('aiInsightsLoading').style.display = 'block';
  document.getElementById('aiInsightsContent').style.display = 'none';
  
  const expenses = getExpensesByPeriod(period);
  
  if (expenses.length === 0) {
    document.getElementById('aiInsightsLoading').style.display = 'none';
    document.getElementById('aiInsightsContent').style.display = 'block';
    document.getElementById('aiInsightsText').textContent = 'No expenses found for this period. Start tracking your expenses to get AI insights!';
    return;
  }
  
  // Prepare data for charts
  const categoryData = {};
  expenses.forEach(e => {
    categoryData[e.cat] = (categoryData[e.cat] || 0) + e.amt;
  });
  
  // Prepare trend data (group by week)
  const trendData = {};
  expenses.forEach(e => {
    const date = new Date(e.date + 'T00:00:00');
    const weekStart = new Date(date);
    weekStart.setDate(date.getDate() - date.getDay());
    const weekKey = weekStart.toISOString().split('T')[0];
    trendData[weekKey] = (trendData[weekKey] || 0) + e.amt;
  });
  
  currentChartsData = { categoryData, trendData };
  
  // Create charts
  createCharts(categoryData, trendData);
  
  // Call AI for analysis
  try {
    const analysis = await getAIAnalysis(expenses, period, categoryData);
    currentInsightsText = analysis;
    document.getElementById('aiInsightsText').textContent = analysis;
  } catch (err) {
    document.getElementById('aiInsightsText').textContent = 'AI analysis is currently unavailable. Please try again later.\n\nHowever, you can still view the charts and download the report!';
  }
  
  document.getElementById('aiInsightsLoading').style.display = 'none';
  document.getElementById('aiInsightsContent').style.display = 'block';
}

// Create Charts
function createCharts(categoryData, trendData) {
  // Destroy existing charts
  if (categoryChart) categoryChart.destroy();
  if (trendChart) trendChart.destroy();
  
  // Category Pie Chart
  const catCtx = document.getElementById('categoryChart').getContext('2d');
  categoryChart = new Chart(catCtx, {
    type: 'doughnut',
    data: {
      labels: Object.keys(categoryData),
      datasets: [{
        data: Object.values(categoryData),
        backgroundColor: Object.keys(categoryData).map(cat => CAT_COLORS[cat] || '#6b7280'),
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { font: { size: 11 }, padding: 8 }
        },
        tooltip: {
          callbacks: {
            label: (context) => {
              const label = context.label || '';
              const value = context.parsed || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((value / total) * 100).toFixed(1);
              return `${label}: KSH ${value.toLocaleString()} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
  
  // Trend Line Chart
  const trendCtx = document.getElementById('trendChart').getContext('2d');
  const sortedDates = Object.keys(trendData).sort();
  trendChart = new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: sortedDates.map(d => new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })),
      datasets: [{
        label: 'Weekly Spending',
        data: sortedDates.map(d => trendData[d]),
        borderColor: '#c2853a',
        backgroundColor: 'rgba(194,133,58,0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (context) => `KSH ${context.parsed.y.toLocaleString()}`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: (value) => 'KSH ' + value.toLocaleString()
          }
        }
      }
    }
  });
}

// AI Analysis Function
async function getAIAnalysis(expenses, period, categoryData) {
  const total = expenses.reduce((s, e) => s + e.amt, 0);
  const avgPerTransaction = total / expenses.length;
  const topCategory = Object.entries(categoryData).sort((a, b) => b[1] - a[1])[0];
  
  // Prepare expense summary for AI
  const expenseSummary = {
    period: period,
    totalSpent: total,
    transactionCount: expenses.length,
    averageTransaction: avgPerTransaction,
    categories: categoryData,
    topCategory: topCategory[0],
    recentExpenses: expenses.slice(0, 10).map(e => ({
      desc: e.desc,
      amount: e.amt,
      category: e.cat,
      date: e.date
    }))
  };
  
  const prompt = `You are a financial advisor analyzing expense data. Provide insights and recommendations.

EXPENSE DATA:
${JSON.stringify(expenseSummary, null, 2)}

Provide a detailed analysis covering:
1. SPENDING OVERVIEW: Summarize the total spending and patterns
2. CATEGORY INSIGHTS: Analyze which categories dominate and why
3. TRENDS: Identify any concerning spending patterns
4. PREDICTIONS: Forecast next month's spending based on current trends
5. RECOMMENDATIONS: Give 3-4 actionable tips to optimize spending
6. SAVINGS OPPORTUNITIES: Suggest areas where they can cut costs

Format your response as clear paragraphs with headers. Be specific with numbers and percentages. Keep it under 400 words but make it insightful and actionable.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{
          role: 'user',
          content: prompt
        }]
      })
    });
    
    if (!response.ok) throw new Error('AI service unavailable');
    
    const data = await response.json();
    return data.content[0].text;
  } catch (err) {
    // Fallback to basic analysis if AI fails
    return generateBasicAnalysis(expenses, period, categoryData, total, avgPerTransaction, topCategory);
  }
}

// Fallback Basic Analysis
function generateBasicAnalysis(expenses, period, categoryData, total, avgPerTransaction, topCategory) {
  const periodNames = { week: 'this week', month: 'this month', year: 'this year', all: 'all time' };
  const periodName = periodNames[period] || period;
  
  let analysis = `SPENDING OVERVIEW\n`;
  analysis += `You spent KSH ${total.toLocaleString()} ${periodName} across ${expenses.length} transactions. `;
  analysis += `Your average transaction is KSH ${avgPerTransaction.toFixed(2)}.\n\n`;
  
  analysis += `CATEGORY BREAKDOWN\n`;
  analysis += `Your top spending category is ${topCategory[0]} (KSH ${topCategory[1].toLocaleString()}, `;
  analysis += `${((topCategory[1] / total) * 100).toFixed(1)}% of total spending).\n\n`;
  
  const sortedCats = Object.entries(categoryData).sort((a, b) => b[1] - a[1]);
  analysis += `Other significant categories:\n`;
  sortedCats.slice(1, 4).forEach(([cat, amt]) => {
    analysis += `‚Ä¢ ${cat}: KSH ${amt.toLocaleString()} (${((amt / total) * 100).toFixed(1)}%)\n`;
  });
  
  analysis += `\nRECOMMENDATIONS\n`;
  analysis += `1. Consider setting a budget limit for ${topCategory[0]} as it's your highest expense\n`;
  analysis += `2. Review your ${sortedCats[1][0]} spending for potential savings\n`;
  analysis += `3. Track daily expenses to identify small recurring costs\n`;
  analysis += `4. Set spending alerts for categories exceeding 30% of your budget\n\n`;
  
  analysis += `PREDICTION\n`;
  const projectedNext = period === 'week' ? total * 4 : period === 'month' ? total : total / 12;
  analysis += `Based on current trends, you're projected to spend approximately KSH ${projectedNext.toFixed(0)} next month.`;
  
  return analysis;
}

// Download AI Insights Report
document.getElementById('downloadInsightsBtn').addEventListener('click', async () => {
  if (!currentInsightsText || !currentChartsData) {
    toast('Generate insights first', 'err');
    return;
  }
  
  const userDoc = await db.collection('users').doc(currentUserId).get();
  const user = userDoc.data();
  const period = currentAIPeriod;
  const expenses = getExpensesByPeriod(period);
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const pageWidth = 210;
  const margin = 15;
  const contentWidth = pageWidth - (margin * 2);
  
  // Header
  doc.setFillColor(30, 58, 95);
  doc.rect(0, 0, pageWidth, 40, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(24);
  doc.setFont('helvetica', 'bold');
  doc.text('AI EXPENSE INSIGHTS', margin, 20);
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  doc.text(`${user.first} ${user.last} ‚Ä¢ ${new Date().toLocaleDateString('en-GB')}`, margin, 30);
  
  // Charts (convert to images)
  let y = 50;
  doc.setTextColor(30, 58, 95);
  doc.setFontSize(14);
  doc.setFont('helvetica', 'bold');
  doc.text('Spending Visualizations', margin, y);
  y += 10;
  
  try {
    const catCanvas = document.getElementById('categoryChart');
    const catImg = catCanvas.toDataURL('image/png');
    doc.addImage(catImg, 'PNG', margin, y, 80, 80);
    
    const trendCanvas = document.getElementById('trendChart');
    const trendImg = trendCanvas.toDataURL('image/png');
    doc.addImage(trendImg, 'PNG', margin + 90, y, 80, 80);
    y += 90;
  } catch (err) {
    console.error('Chart export error:', err);
  }
  
  // AI Insights Text
  doc.setFontSize(14);
  doc.setFont('helvetica', 'bold');
  doc.text('AI Analysis & Recommendations', margin, y);
  y += 8;
  
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(50, 50, 50);
  const lines = doc.splitTextToSize(currentInsightsText, contentWidth);
  
  lines.forEach(line => {
    if (y > 280) {
      doc.addPage();
      y = 20;
    }
    doc.text(line, margin, y);
    y += 5;
  });
  
  doc.save(`AI_Insights_${user.first}_${user.last}_${period}.pdf`);
  toast('AI Report downloaded!', 'ok');
});

// Email AI Insights
document.getElementById('emailInsightsBtn').addEventListener('click', () => {
  document.getElementById('emailInputOverlay').classList.add('show');
});

document.getElementById('emailInputClose').addEventListener('click', () => {
  document.getElementById('emailInputOverlay').classList.remove('show');
});

document.getElementById('cancelEmailBtn').addEventListener('click', () => {
  document.getElementById('emailInputOverlay').classList.remove('show');
});

document.getElementById('sendEmailBtn').addEventListener('click', async () => {
  const email = document.getElementById('insightsEmailInput').value.trim();
  if (!email || !email.includes('@')) {
    toast('Enter valid email', 'err');
    return;
  }
  
  if (!currentInsightsText) {
    toast('Generate insights first', 'err');
    return;
  }
  
  const userDoc = await db.collection('users').doc(currentUserId).get();
  const user = userDoc.data();
  
  // Prepare email content
  const subject = `Your AI Expense Insights - ${currentAIPeriod.toUpperCase()}`;
  const body = `Hi ${user.first},\n\nHere are your AI-powered expense insights:\n\n${currentInsightsText}\n\n---\nGenerated by FinanceFlow Expense Tracker\n${new Date().toLocaleString()}`;
  
  // Open email client
  const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = mailtoLink;
  
  document.getElementById('emailInputOverlay').classList.remove('show');
  toast('Email client opened!', 'ok');
});
  toast('PDF downloaded!','ok');
}
</script>
</body>
</html>